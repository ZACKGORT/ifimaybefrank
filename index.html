<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="An anti-scroll manifesto. A portfolio that makes you read one sentence at a time. Sentence-based navigation meets parallax storytelling.">
    <meta name="author" content="Zack Gort">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ifimaybefrank.com/">
    <meta property="og:title" content="IFIMAYBEFRANK - Zack Gort">
    <meta property="og:description" content="What if reading on the web felt intentional? A sentence-based narrative interface.">
    <meta property="og:image" content="https://ifimaybefrank.com/og-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="IFIMAYBEFRANK - Zack Gort">
    <meta property="twitter:description" content="An anti-scroll manifesto. One sentence at a time.">
    <meta property="twitter:image" content="https://ifimaybefrank.com/og-image.jpg">
    
    <title>IFIMAYBEFRANK - Zack Gort</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ===================================
   CSS VARIABLES & THEMES
   =================================== */
:root {
    /* ── Palette ── */
    --bg-color: #000000;
    --ink: #ffffff;
    --ink-2: #b8b8b8;
    --ink-3: #808080;
    --accent: #daa520;

    /* ── Semantic surfaces ── */
    --surface: rgba(0, 0, 0, 0.60);           /* widget/panel bg */
    --surface-raised: rgba(10, 10, 10, 0.95); /* dropdowns, overlays */
    --border: rgba(255, 255, 255, 0.10);
    --border-strong: rgba(255, 255, 255, 0.15);
    --hover-tint: rgba(218, 165, 32, 0.08);   /* accent-tinted hover */
    --hover-tint-strong: rgba(218, 165, 32, 0.15);

    /* ── Sentence states ── */
    --sentence-color: rgba(255, 255, 255, 0.85);
    --sentence-active-color: #ffffff;
    --sentence-active-bg: rgba(0, 0, 0, 0.95);
    --sentence-active-shadow: 0 0 20px rgba(218, 165, 32, 0.30);
    --sentence-hover-color: var(--ink);
    --sentence-hover-bg: rgba(218, 165, 32, 0.08);
    --sentence-dimmed-opacity: 0.5;
    --sentence-dimmed-color: rgba(255, 255, 255, 0.50);

    /* ── Typography ── */
    --ui-font: 'Space Mono', monospace;
    --body-font: 'Crimson Text', Georgia, serif;
    --stream-line-height: 1.8;
    --stream-letter-spacing: -0.01em;
    --ui-font-weight: 400;
    --chapter-break-weight: 700;
    --chapter-break-letter-spacing: 0.15em;
    --chapter-break-font-size: 11px;
    --chapter-break-border-width: 1px;

    /* ── Chapter progress bars ── */
    --chapter-bar-bg: rgba(255, 255, 255, 0.15);
    --chapter-bar-hover-bg: rgba(255, 255, 255, 0.30);
    --chapter-bar-completed-bg: rgba(218, 165, 32, 0.40);
    --chapter-bar-completed-hover-bg: rgba(218, 165, 32, 0.60);
    --chapter-tooltip-bg: rgba(0, 0, 0, 0.90);

    /* ── Image grid ── */
    --grid-overlay-bg: rgba(5, 5, 5, 0.96);
    --grid-item-bg: #111111;
    --grid-item-border: rgba(255, 255, 255, 0.10);
    --grid-title-border: rgba(255, 255, 255, 0.10);

    /* ── Effects ── */
    --vig-opacity: 0.85;
    --vig-inner: 30%;
    --vig-mid: 75%;
    --vig-outer: 100%;
    --edge-blur: 6px;
    --edge-mask-i: 65%;
    --edge-mask-o: 80%;
    --grain-opacity: 0.08;
    --effects-display: block; /* set to 'none' to kill grain/vig/blur */

    /* ── Brackets ── */
    --bracket-color: #8b6f47;
    --bracket-hover: #daa520;
    --bracket-bg: rgba(218, 165, 32, 0.04);

    /* ── Cursor ── */
    --cursor-bg: transparent;
    --cursor-border: rgba(255, 255, 255, 0.50);
    --cursor-blend: difference;
    --cursor-opacity: 1;

    /* ── Selection ── */
    --selection-bg: rgba(218, 165, 32, 0.25);
    --selection-color: #ffffff;

    /* ── z-index stack ── */
    --z-content: 0;
    --z-grain: 149;
    --z-blur: 150;
    --z-vig: 151;
    --z-ui: 220;
    --z-overlay: 300;
    --z-dropdown: 350;
    --z-rail: 210;
    --z-mobile-bottom-rail: 220;
    --z-rotate-warning: 9999;

    /* ── Parallax ── */
    --text-parallax-strength: 0.03;
    --image-parallax-strength: 0.15;
    --center-magnet-strength: 0.25;
    --curve-k: 1;
}

/* ── NEWSPAPER THEME ── */
body.theme-newspaper {
    --bg-color: #faf8f3;
    --ink: #000000;
    --ink-2: #1a1a1a;
    --ink-3: #2a2a2a;
    --accent: #8b4513;

    --surface: rgba(245, 241, 232, 0.95);
    --surface-raised: rgba(245, 241, 232, 0.98);
    --border: rgba(0, 0, 0, 0.12);
    --border-strong: rgba(0, 0, 0, 0.15);
    --hover-tint: rgba(139, 69, 19, 0.06);
    --hover-tint-strong: rgba(139, 69, 19, 0.10);

    --sentence-color: #000000;
    --sentence-active-color: #ffffff;
    --sentence-active-bg: #000000;
    --sentence-active-shadow: none;
    --sentence-hover-color: #000000;
    --sentence-hover-bg: rgba(255, 255, 255, 0.95);
    --sentence-dimmed-opacity: 0.5;
    --sentence-dimmed-color: #333333;

    --chapter-bar-bg: rgba(0, 0, 0, 0.12);
    --chapter-bar-hover-bg: rgba(0, 0, 0, 0.25);
    --chapter-bar-completed-bg: rgba(139, 69, 19, 0.30);
    --chapter-bar-completed-hover-bg: rgba(139, 69, 19, 0.50);
    --chapter-tooltip-bg: rgba(245, 241, 232, 0.95);

    --grid-overlay-bg: rgba(245, 241, 232, 0.98);
    --grid-item-bg: #e8e4d8;
    --grid-item-border: rgba(0, 0, 0, 0.15);
    --grid-title-border: rgba(0, 0, 0, 0.12);

    --vig-opacity: 0.12;
    --grain-opacity: 0.08;

    --bracket-color: #5d4e37;
    --bracket-hover: #8b4513;
    --bracket-bg: rgba(139, 69, 19, 0.03);

    --cursor-bg: transparent;
    --cursor-border: rgba(0, 0, 0, 0.40);
    --cursor-blend: normal;
    --cursor-opacity: 1;

    --selection-bg: rgba(139, 69, 19, 0.25);
    --selection-color: #ffffff;
}

/* ── SPORT THEME ── */
body.theme-sport {
    --bg-color: #0a0a0a;
    --ink: #f5f5f5;
    --ink-2: #e0e0e0;
    --ink-3: #888888;
    --accent: #fa3c00;

    --surface: rgba(10, 10, 10, 0.92);
    --surface-raised: rgba(10, 10, 10, 0.97);
    --border: rgba(250, 60, 0, 0.18);
    --border-strong: rgba(250, 60, 0, 0.25);
    --hover-tint: rgba(250, 60, 0, 0.10);
    --hover-tint-strong: rgba(250, 60, 0, 0.15);

    --sentence-color: var(--ink-2);
    --sentence-active-color: #ffffff;
    --sentence-active-bg: var(--accent);
    --sentence-active-shadow: none;
    --sentence-hover-color: #ffffff;
    --sentence-hover-bg: rgba(250, 60, 0, 0.12);
    --sentence-dimmed-opacity: 0.5;
    --sentence-dimmed-color: var(--ink-3);

    --ui-font: 'Inter', sans-serif;
    --ui-font-weight: 600;
    --body-font: 'Inter', sans-serif;
    --stream-line-height: 1.75;
    --stream-letter-spacing: -0.025em;
    --chapter-break-weight: 900;
    --chapter-break-letter-spacing: 0.14em;
    --chapter-break-font-size: 10px;
    --chapter-break-border-width: 2px;

    --chapter-bar-bg: rgba(255, 255, 255, 0.10);
    --chapter-bar-hover-bg: rgba(255, 255, 255, 0.25);
    --chapter-bar-completed-bg: rgba(250, 60, 0, 0.35);
    --chapter-bar-completed-hover-bg: rgba(250, 60, 0, 0.55);
    --chapter-tooltip-bg: rgba(10, 10, 10, 0.97);

    --grid-overlay-bg: rgba(10, 10, 10, 0.98);
    --grid-item-bg: #111111;
    --grid-item-border: rgba(255, 255, 255, 0.08);
    --grid-title-border: rgba(250, 60, 0, 0.20);

    --vig-opacity: 0.60;
    --edge-blur: 4px;
    --grain-opacity: 0.04;

    --bracket-color: #cc3000;
    --bracket-hover: #fa3c00;
    --bracket-bg: rgba(250, 60, 0, 0.06);

    --cursor-bg: var(--accent);
    --cursor-border: var(--accent);
    --cursor-blend: normal;
    --cursor-opacity: 0.85;

    --selection-bg: rgba(250, 60, 0, 0.35);
    --selection-color: #ffffff;
}

/* ===================================
   LAYOUT MODES
   =================================== */
html, body { overscroll-behavior: none; touch-action: pan-y; }
body.layout-layered .text-layer { width: 95%; margin: 0 auto; max-width: 1400px; }
body.layout-layered .stream { color: var(--sentence-color); }
body.layout-layered .hover-image { position: absolute; left: 50%; top: 50%; }
body.layout-split .text-layer { width: 50%; margin: 0; padding-left: 6vw; }
body.layout-split .stream { color: var(--sentence-color); font-size: clamp(16px, 2vw, 28px); }
body.layout-split .hover-image { position: fixed; left: 72%; top: 50%; width: 45vw; height: 34vw; }
body.layout-split .hover-image.active { opacity: 1 !important; filter: brightness(1) contrast(1); }
body .hover-image { display: block; }

/* HIDE MOBILE RIGHT RAIL IN SPLIT VIEW */
body.layout-split .mobile-right-rail { display: none !important; }

/* ===================================
   KEYBOARD LEGEND WIDGET
   =================================== */
.keyboard-legend {
    position: fixed;
    bottom: 20px;
    right: 80px;
    z-index: var(--z-ui);
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--surface);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px 6px 4px;
    cursor: grab;
    user-select: none;
    transition: background 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    touch-action: none;
    transform: translateZ(0);
    will-change: transform;
    isolation: isolate;
}
.keyboard-legend:active { cursor: grabbing; }
.drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 12px;
    line-height: 1;
    padding-right: 6px;
    border-right: 1px solid var(--border);
    opacity: 0.4;
    display: flex;
    align-items: center;
    height: 100%;
    letter-spacing: -3px;
}
.k-group { display: flex; flex-direction: column; gap: 3px; align-items: center; }
.k-row { display: flex; gap: 3px; }
.k-key {
    width: 22px; height: 22px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--ui-font);
    font-weight: var(--ui-font-weight);
    font-size: 11px; color: var(--ink-3);
    position: relative;
    transition: all 0.15s ease;
    cursor: pointer;
}
.k-key:hover { background: var(--accent); color: var(--bg-color); border-color: var(--accent); }
.k-key:active { transform: scale(0.88); }
.k-tooltip {
    position: absolute; bottom: 100%; left: 50%;
    transform: translateX(-50%) translateY(-6px);
    background: var(--surface-raised); color: var(--ink);
    padding: 3px 7px; border-radius: 3px; font-size: 9px;
    white-space: nowrap; opacity: 0; pointer-events: none;
    transition: opacity 0.15s ease;
    border: 1px solid var(--border);
    font-family: var(--ui-font);
    letter-spacing: 0.05em;
}
.k-key:hover .k-tooltip { opacity: 1; }

@media (max-width: 768px) { .keyboard-legend { display: none; } }

/* ===================================
   MODE CLUSTER WIDGET
   =================================== */
.mode-cluster {
    display: flex;
    align-items: center;
    gap: 3px;
    background: var(--surface);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 8px 5px 4px;
    cursor: grab;
    user-select: none;
    pointer-events: auto;
    touch-action: none;
    transform: translateZ(0);
    will-change: transform;
    isolation: isolate;
    transition: background 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    position: fixed;
    top: clamp(14px, 2vh, 24px);
    right: clamp(16px, 3.5vw, 44px);
    z-index: var(--z-ui);
}
.mode-cluster:active { cursor: grabbing; }
.mode-drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 12px;
    line-height: 1;
    padding-right: 6px;
    border-right: 1px solid var(--border);
    opacity: 0.4;
    display: flex;
    align-items: center;
    align-self: stretch;
    letter-spacing: -3px;
    margin-right: 2px;
    flex-shrink: 0;
}
.mode-key {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.15s ease;
    padding: 0;
    position: relative;
    flex-shrink: 0;
}
.mode-key:hover {
    background: var(--hover-tint);
    border-color: var(--accent);
}
.mode-key:active { transform: scale(0.88); }
.mode-key-label {
    font-family: var(--ui-font);
    font-size: 9px;
    font-weight: 700;
    color: var(--ink);
    line-height: 1;
    letter-spacing: 0.02em;
}
.mode-key-desc {
    font-family: var(--ui-font);
    font-size: 7px;
    color: var(--ink-3);
    line-height: 1;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}
.mode-key:hover .mode-key-label { color: var(--accent); }
.mode-key:hover .mode-key-desc { color: var(--accent); opacity: 0.7; }

/* Active state per mode */
.mode-key.mode-active {
    background: var(--hover-tint-strong);
    border-color: var(--accent);
}
.mode-key.mode-active .mode-key-label,
.mode-key.mode-active .mode-key-desc { color: var(--accent); }

/* Suppress old header-right styles — widget is now standalone */
.header-right { display: none; }

@media (max-width: 768px) {
    .mode-cluster {
        padding: 4px 6px;
        gap: 3px;
        cursor: default;
        top: clamp(10px, 1.5vh, 18px);
        right: clamp(12px, 3vw, 20px);
    }
    .mode-drag-handle { display: none; }
    .mode-key#modeKeyF,
    .mode-key#modeKeyH,
    .mode-key#modeKeyC,
    .mode-key#modeKeySpace { display: none; }
    .mode-key {
        width: 32px;
        height: 32px;
    }
}

/* ===================================
   STATS WIDGET (+ MOBILE HUD)
   =================================== */
@keyframes hudEntrance {
    0%   { opacity: 0; transform: translateY(20px) scale(0.95); }
    60%  { opacity: 1; transform: translateY(-4px) scale(1.01); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes statPulse {
    0%   { transform: translateZ(0) scale(1); }
    40%  { transform: translateZ(0) scale(1.35); opacity: 1; }
    100% { transform: translateZ(0) scale(1); }
}

.stats-widget {
    position: fixed;
    bottom: 20px;
    left: 80px;
    z-index: var(--z-ui);
    display: flex;
    align-items: center;
    gap: 0;
    background: var(--surface);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 2px 4px 4px;
    cursor: grab;
    user-select: none;
    transition: background 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    touch-action: none;
    transform: translateZ(0);
    will-change: transform;
    isolation: isolate;
}
.stats-widget:active { cursor: grabbing; }

.stats-drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 12px;
    line-height: 1;
    padding-right: 6px;
    border-right: 1px solid var(--border);
    opacity: 0.4;
    display: flex;
    align-items: center;
    align-self: stretch;
    letter-spacing: -3px;
    margin-right: 0;
}
.stats-group { display: flex; align-items: center; }
.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 3px 9px;
    gap: 2px;
    border-right: 1px solid var(--border);
    min-width: 48px;
}
.stat-item:last-child { border-right: none; }
.stat-value {
    font-family: var(--ui-font);
    font-size: 13px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    transition: color 0.2s ease;
    display: inline-block;
    will-change: transform;
    transform: translateZ(0);
}
.stat-label {
    font-family: var(--ui-font);
    font-size: 7px;
    color: var(--ink-3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    line-height: 1;
    white-space: nowrap;
}
.stat-value.pulse { animation: statPulse 0.35s ease-out; }

/* ── HUD nav buttons (hidden on desktop, shown on mobile) ── */
.hud-nav-btn {
    display: none;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    color: var(--accent);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    flex-shrink: 0;
}
.hud-nav-btn svg { width: 18px; height: 18px; fill: currentColor; pointer-events: none; }
.hud-nav-btn:active { transform: scale(0.86); background: var(--hover-tint-strong); }
.hud-nav-btn.active-press { background: var(--accent) !important; color: var(--bg-color) !important; }

/* ── Mobile overrides ── */
@media (max-width: 768px) {
    .stats-widget {
        bottom: calc(16px + env(safe-area-inset-bottom));
        left: 0 !important;
        right: 0 !important;
        transform: none !important;
        margin-left: auto !important;
        margin-right: auto !important;
        width: fit-content !important;
        cursor: default;
        max-width: calc(100vw - 32px);
        width: auto;
        touch-action: none;
        padding: 5px 5px 5px 8px;
        border-radius: 12px;
        gap: 0;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5);
        animation: hudEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
    }
    .stats-widget:active { cursor: default; }
    .stats-drag-handle { display: none; }
    .hud-nav-btn { display: flex; }
    .stat-item { padding: 3px 7px; min-width: 44px; }
    .stat-value { font-size: 13px; }
    .stat-label { font-size: 6px; letter-spacing: 0.07em; }

    .hud-divider {
        width: 1px;
        align-self: stretch;
        background: var(--border);
        margin: 4px 3px;
        flex-shrink: 0;
    }
}



/* ===================================
   NAVIGATION RAILS
   =================================== */
.scroll-progress { 
    position: fixed; right: 24px; top: 50%; transform: translateY(-50%); 
    display: flex; flex-direction: column; align-items: center; gap: 12px; 
    z-index: var(--z-ui); pointer-events: auto; 
}
.chapter-progress-container { 
    display: flex; flex-direction: column; gap: 5px; padding: 8px 0; align-items: center;
}
.chapter-bar { 
    width: 16px; height: 3px; background: var(--chapter-bar-bg); border-radius: 2px; 
    cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
}
.chapter-bar:hover { width: 28px; height: 4px; background: var(--chapter-bar-hover-bg); }
.chapter-bar.active { background: var(--accent); box-shadow: 0 0 6px rgba(218,165,32,0.5); }
.chapter-bar.active:hover { background: var(--accent); }
.chapter-bar.completed { background: var(--chapter-bar-completed-bg); }
.chapter-bar.completed:hover { background: var(--chapter-bar-completed-hover-bg); }
.chapter-bar::after {
    content: attr(data-chapter-title);
    position: absolute; right: calc(100% + 10px); top: 50%; transform: translateY(-50%);
    font-family: var(--ui-font); font-size: 10px; color: var(--ink-2);
    white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s ease;
    background: var(--surface-raised); padding: 3px 7px; border-radius: 3px;
    border: 1px solid var(--border); letter-spacing: 0.04em;
}
.chapter-bar:hover::after { opacity: 1; }
.nav-button { 
    width: 32px; height: 32px; border-radius: 50%; 
    background: var(--surface); border: 1px solid var(--border); 
    color: var(--ink-3); cursor: pointer; transition: all 0.15s ease; 
    display: flex; align-items: center; justify-content: center; font-size: 12px; 
    pointer-events: auto; user-select: none; -webkit-user-select: none; 
    -webkit-tap-highlight-color: transparent; touch-action: manipulation; 
}
.nav-button:hover { background: var(--hover-tint); border-color: var(--accent); color: var(--accent); transform: scale(1.08); }
.nav-button:active { transform: scale(0.94); }
.nav-button svg { width: 14px; height: 14px; fill: currentColor; }
.nav-button.active-press, .mobile-nav-button.active-press {
    background: var(--accent) !important; color: var(--bg) !important;
    transform: scale(0.94); transition: transform 0.1s ease;
}
.left-rail { 
    position: fixed; left: 0; top: 50%; transform: translateY(-50%); 
    z-index: var(--z-rail); padding: 16px 10px 16px 0; pointer-events: auto; display: flex; align-items: center; 
}
.lens-control-container { 
    background: var(--surface); border: 1px solid var(--border); 
    border-left: none; border-radius: 0 6px 6px 0; padding: 12px 6px; 
    display: flex; flex-direction: column; align-items: center; gap: 10px; backdrop-filter: blur(12px); 
    transition: background 0.35s ease, border-color 0.35s ease;
}
.lens-label { 
    font-family: var(--ui-font); font-size: 8px; color: var(--ink-3); 
    text-transform: uppercase; letter-spacing: 0.06em; writing-mode: vertical-rl; 
    text-orientation: mixed; transform: rotate(180deg); opacity: 0.6;
}
.accessibility-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.accessibility-btn { 
    width: 24px; height: 24px; border-radius: 3px; background: rgba(255,255,255,0.04); 
    border: 1px solid var(--border); color: var(--ink-3); cursor: pointer; 
    display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; 
}
.accessibility-btn:hover { background: var(--hover-tint-strong); border-color: var(--accent); color: var(--accent); }
.accessibility-btn:active { transform: scale(0.9); }
.accessibility-btn svg { width: 14px; height: 14px; }
.accessibility-level { display: flex; flex-direction: column; gap: 3px; padding: 6px 0; }
.level-indicator { width: 14px; height: 2px; background: var(--border); border-radius: 1px; transition: background 0.2s ease; }
.level-indicator.active { background: var(--accent); }

/* ===================================
   MOBILE RAILS
   =================================== */
.mobile-right-rail { 
    display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 60px; 
    background: var(--surface); backdrop-filter: blur(10px); z-index: var(--z-ui); 
    flex-direction: column; align-items: center; justify-content: center; gap: 20px; 
    border-left: 1px solid var(--border); padding: 20px 0; 
    transition: background 0.35s ease, border-color 0.35s ease;
}
.mobile-nav-container { 
    display: flex; justify-content: space-between; align-items: center; gap: 12px; 
    max-width: 500px; margin: 0 auto; width: 100%; 
}
.mobile-right-rail .mobile-nav-container { flex-direction: column; height: 100%; justify-content: space-between; }
.mobile-right-rail .rail-top-group, .mobile-right-rail .rail-bottom-group { display: flex; flex-direction: column; gap: 10px; align-items: center; }
.mobile-nav-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.mobile-nav-button { 
    width: 48px; height: 48px; border-radius: 12px; background: var(--border); 
    border: 1px solid var(--border-strong); color: var(--accent); cursor: pointer; 
    transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; 
    pointer-events: auto; -webkit-tap-highlight-color: transparent; user-select: none; 
    -webkit-user-select: none; touch-action: manipulation; 
}
.mobile-nav-button:active { transform: scale(0.92); background: var(--hover-tint-strong); }
.mobile-nav-button svg { width: 22px; height: 22px; fill: currentColor; }
.mobile-nav-label { font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.05em; }
.mobile-progress-container { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 0 12px; }
.mobile-right-rail .mobile-progress-container { height: 100%; width: 100%; flex: 1; justify-content: center; padding: 20px 0; }
.mobile-right-rail .mobile-progress-bar { width: 4px; height: 100%; max-height: 200px; }
.mobile-right-rail .mobile-progress-fill { width: 100%; height: 0%; bottom: 0; top: auto; transition: height 0.3s ease; }
.mobile-progress-text { font-family: var(--ui-font); font-size: 10px; color: var(--ink-2); letter-spacing: 0.05em; }
.mobile-progress-bar { width: 100%; height: 4px; background: var(--border-strong); border-radius: 2px; position: relative; overflow: hidden; }
.mobile-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s ease; width: 0%; }

body.image-active .sentence:not(.active) { opacity: 0.1; color: var(--ink-3); }
body.image-active .sentence.active { opacity: 1; color: var(--sentence-active-color); }
body.image-active .sentence.dimmed { opacity: 0.01; color: var(--ink-3); }

/* ===================================
   BASE STYLES
   =================================== */
*, *::before, *::after { box-sizing: border-box; }
html { color-scheme: dark; -webkit-text-size-adjust: 100%; }
body, html { height: 100%; margin: 0; overflow-x: hidden; }
body { 
    background: var(--bg-color); color: var(--ink); font: 18px/1.8 var(--body-font); 
    overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; 
    -webkit-tap-highlight-color: transparent; cursor: none; user-select: none; 
    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
    transition: background-color 0.35s ease, color 0.35s ease;
}
body::-webkit-scrollbar { display: none; }
body { -ms-overflow-style: none; scrollbar-width: none; }
::selection { background: var(--selection-bg); color: var(--selection-color); }

/* ===================================
   FLOW MODE
   =================================== */
body.flow-mode .sentence { opacity: 0.15; transition: opacity 0.6s ease; }
body.flow-mode .sentence.active { opacity: 1; }
body.flow-mode .sentence.revealed { opacity: 0.6; }
body.flow-mode .text-layer { overflow-y: auto; height: 100vh; -webkit-overflow-scrolling: touch; }
/* Nuanced Split View trigger: allows text to fade when an image is active */
body.layout-split.image-active .sentence:not(.active) { 
    opacity: 0.25; 
    color: var(--ink-3); 
    transition: opacity 0.4s ease;
}

/* ===================================
   INTERACTION HINTS
   =================================== */
.interaction-hint { 
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 9998; 
    font-family: var(--ui-font); font-size: 11px; letter-spacing: 0.1em; 
    text-transform: uppercase; color: var(--accent); opacity: 0; 
    animation: hintPulse 3s ease-in-out; pointer-events: none; 
}
@keyframes hintPulse { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 0.6; } 50% { opacity: 0.3; } }
body.hint-shown .interaction-hint { display: none; }

/* ===================================
   CONTEXT MENU
   =================================== */


/* ===================================
   VISUAL EFFECTS
   =================================== */
.edge-blur { 
    position: fixed; inset: 0; pointer-events: none; z-index: var(--z-blur); 
    backdrop-filter: blur(var(--edge-blur)); -webkit-backdrop-filter: blur(var(--edge-blur)); 
    mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o)); 
    -webkit-mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o));
    transform: translateZ(0);
    will-change: transform;
}
.vignette { 
    position: fixed; inset: 0; pointer-events: none; z-index: var(--z-vig); 
    background: radial-gradient(120% 90% at 50% 50%, #fff0 var(--vig-inner), rgb(0 0 0 / 0.55) var(--vig-mid), rgb(0 0 0 / 0.9) var(--vig-outer)); 
    opacity: calc(var(--vig-opacity) * var(--curve-k));
    transform: translateZ(0);
    will-change: opacity;
    transition: opacity 0.35s ease;
}
body::after { 
    content: ""; position: fixed; inset: 0; pointer-events: none; z-index: var(--z-grain); opacity: 0.08; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.45'/%3E%3C/svg%3E"); 
    background-size: 120px 120px;
    transform: translateZ(0);
    will-change: transform;
    transition: opacity 0.35s ease;
}
body.theme-transitioning::after {
    opacity: 0;
}

/* ===================================
   PARALLAX & LAYERS
   =================================== */
.curved { 
    position: fixed; inset: 0; transform-style: preserve-3d; 
    transform: perspective(1000px) translateZ(calc(-200px * var(--curve-k))) scale(calc(1 + var(--curve-k) * 0.06)); 
    will-change: transform; z-index: var(--z-content);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.parallax-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
.text-layer { 
    position: relative; z-index: 10; padding: 15vh 8vw 25vh; max-width: 99%; margin: 0 auto; 
    transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.image-layer { 
    position: fixed; inset: 0; z-index: 5; pointer-events: none; 
    transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.stream { font-size: clamp(18px, 2.5vw, 32px); line-height: var(--stream-line-height); letter-spacing: var(--stream-letter-spacing); max-width: 100%; color: var(--sentence-color); font-family: var(--body-font); transition: color 0.35s ease, font-family 0.1s; }
.sentence { display: inline; transition: opacity 0.3s ease, color 0.3s ease, background 0.3s ease; cursor: none; position: relative; z-index: 2; letter-spacing: -0.01em; }
.sentence.active { color: var(--sentence-active-color); opacity: 1; text-shadow: var(--sentence-active-shadow); background: var(--sentence-active-bg); padding: 2px 6px; border-radius: 2px; }
.sentence.dimmed { opacity: var(--sentence-dimmed-opacity); color: var(--sentence-dimmed-color); }
.bullet-item, .numbered-bullet-item { display: block; margin: 0.5em 0; padding-left: 1.5em; position: relative; }
.bullet-marker, .numbered-marker { position: absolute; left: 0; color: var(--accent); font-weight: 600; }
.bullet-marker { font-size: 1.2em; line-height: 1.5; }
.numbered-marker { font-family: var(--ui-font); font-size: 0.85em; }
.line-break-spacer { display: inline; pointer-events: none; background: none !important; padding: 0 !important; }

/* ===================================
   CHAPTER BREAKS
   =================================== */
.chapter-break { 
    display: block; margin: 3em 0 2em; padding: 1.5em 0; 
    border-top: var(--chapter-break-border-width) solid color-mix(in srgb, var(--accent) 30%, transparent); 
    border-bottom: var(--chapter-break-border-width) solid color-mix(in srgb, var(--accent) 30%, transparent); 
    text-align: center; font-family: var(--ui-font); font-size: var(--chapter-break-font-size); 
    letter-spacing: var(--chapter-break-letter-spacing); 
    text-transform: uppercase; color: var(--accent); opacity: 0.7; cursor: pointer; transition: all 0.3s ease; pointer-events: auto; 
}
.chapter-break:hover { opacity: 1; background: var(--hover-tint); padding: 1.5em 1em; }
.chapter-break.dropdown-active { opacity: 1; background: var(--hover-tint-strong); border-color: color-mix(in srgb, var(--accent) 60%, transparent); color: var(--accent); }
.chapter-break .chapter-number { display: block; font-size: 0.7em; margin-bottom: 0.5em; color: var(--ink-3); }
.chapter-break .chapter-title { display: block; font-size: 1.2em; font-weight: var(--chapter-break-weight); letter-spacing: var(--chapter-break-letter-spacing); }

/* ===================================
   SUBCHAPTER BREAKS
   =================================== */
.subchapter-break {
    display: block; margin: 2em 0 1.5em; padding: 0.75em 0;
    border-top: 1px solid color-mix(in srgb, var(--accent) 15%, transparent);
    text-align: center; font-family: var(--ui-font); font-size: var(--chapter-break-font-size);
    letter-spacing: var(--chapter-break-letter-spacing);
    text-transform: uppercase; color: var(--ink-3); opacity: 0.5;
    pointer-events: none; transition: opacity 0.3s ease;
}
.subchapter-break .subchapter-title {
    display: inline-block; font-size: 1.11em;
    font-weight: var(--chapter-break-weight);
    letter-spacing: var(--chapter-break-letter-spacing);
}

/* ===================================
   BRACKETS
   =================================== */
.bracket-trigger { 
    all: unset; cursor: none; font-family: var(--ui-font); font-size: 0.65em; 
    color: var(--bracket-color); letter-spacing: 0.02em; transition: all 0.2s ease; 
    border-bottom: 1px dotted var(--bracket-color); padding-bottom: 1px; 
    display: inline; vertical-align: baseline; line-height: inherit; margin: 0 0.1em; 
}
.bracket-trigger:hover { color: var(--bracket-hover); opacity: 1; border-bottom-color: var(--bracket-hover); }
.bracket-trigger.expanded { opacity: 0.5; }
.bracket-content { 
    display: none; font-size: 0.8em; color: var(--ink-2); font-style: italic; 
    line-height: inherit; padding-left: 0.2em; margin-left: 0.2em; 
    border-left: 1px solid color-mix(in srgb, var(--accent) 50%, transparent); padding-right: 0.2em; 
    background: var(--bracket-bg); animation: bracketFadeIn 0.3s ease-out; 
}
.bracket-content.visible { display: inline; }
@keyframes bracketFadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

/* ===================================
   IMAGE TRIGGERS & HOVER
   =================================== */
.image-trigger { position: relative; text-decoration: none; border-bottom: 1px dotted var(--accent); cursor: help; transition: all 0.2s ease; opacity: 0.9; }
.image-trigger:hover { color: var(--accent); border-bottom-style: solid; opacity: 1; }
.hover-image { 
    position: absolute; z-index: 1; pointer-events: none; opacity: 0; 
    transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.1s linear; 
    width: 1400px; height: 1050px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); 
    transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9) contrast(1.05); 
    will-change: transform, opacity; left: 50%; top: 50%; 
}
.hover-image.active { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
.hover-image img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

/* ===================================
   HEADER
   =================================== */
.header { 
    position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-ui); 
    padding: clamp(14px, 2vh, 24px) clamp(16px, 3.5vw, 44px); 
    display: flex; justify-content: space-between; align-items: center; pointer-events: none; 
}
.brand-container { position: relative; pointer-events: auto; }
.header-right { display: flex; align-items: center; gap: 8px; pointer-events: auto; }
.brand { 
    font-family: var(--ui-font); font-size: 10px; letter-spacing: 0.1em; 
    text-transform: uppercase; color: var(--ink-3); padding: 5px 9px; border-radius: 3px; 
    transition: all 0.25s ease; text-decoration: none; background: var(--surface); 
    border: 1px solid var(--border); cursor: pointer; 
    display: flex; align-items: center; gap: 7px; 
}
.brand:hover { background: var(--hover-tint); color: var(--ink); border-color: var(--accent); }
.brand:active { transform: scale(0.95); }
.brand-dropdown-icon { font-size: 9px; transition: transform 0.2s ease; opacity: 0.6; }
.brand.open .brand-dropdown-icon { transform: rotate(180deg); opacity: 1; }

/* ===================================
   CHAPTER DROPDOWN — DRAGGABLE
   =================================== */
.chapter-dropdown { 
    position: fixed;
    top: 52px;
    left: clamp(16px, 3.5vw, 44px);
    min-width: 260px; 
    background: var(--surface-raised); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
    border: 1px solid var(--border); border-radius: 6px; padding: 6px 0; 
    opacity: 0; visibility: hidden;
    transition: opacity 0.2s cubic-bezier(0.25, 1, 0.5, 1), visibility 0.2s; 
    z-index: var(--z-dropdown); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5); 
    max-height: 70vh; display: flex; flex-direction: column; 
    touch-action: none;
    transform: none;
}
.chapter-dropdown.open { opacity: 1; visibility: visible; }
.chapter-dropdown.dragging { 
    transition: none !important; 
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    border-color: var(--accent);
}
.chapter-dropdown-header { 
    padding: 9px 14px; border-bottom: 1px solid var(--border); 
    margin-bottom: 4px; flex-shrink: 0;
    display: flex; align-items: center; gap: 7px;
    cursor: grab;
    user-select: none;
}
.chapter-dropdown-header:active { cursor: grabbing; }
.dropdown-drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 12px;
    letter-spacing: -2px;
    opacity: 0.35;
    line-height: 1;
    flex-shrink: 0;
}
.chapter-dropdown-header h3 { 
    font-family: var(--ui-font); font-size: 9px; letter-spacing: 0.12em; 
    text-transform: uppercase; color: var(--ink-3); margin: 0; font-weight: 400; flex: 1;
}
.chapter-dropdown-list { 
    overflow-y: auto; padding: 0; margin: 0; list-style: none; 
    overscroll-behavior: contain; -webkit-overflow-scrolling: touch; 
}
.chapter-dropdown-list::-webkit-scrollbar { width: 3px; }
.chapter-dropdown-list::-webkit-scrollbar-track { background: transparent; }
.chapter-dropdown-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.chapter-item { padding: 8px 14px; cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; gap: 10px; }
.chapter-item:hover { background: var(--hover-tint); }
.chapter-item.active { background: var(--hover-tint-strong); border-left: 2px solid var(--accent); padding-left: 12px; }
.chapter-item-number { font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); min-width: 36px; letter-spacing: 0.04em; }
.chapter-item-title { font-family: var(--body-font); font-size: 13px; color: var(--ink-2); font-style: italic; }
.chapter-item.active .chapter-item-title { color: var(--accent); font-style: normal; }
.chapter-item-progress { margin-left: auto; font-family: var(--ui-font); font-size: 8px; color: var(--ink-3); background: rgba(255,255,255,0.04); padding: 2px 5px; border-radius: 2px; }

/* ===================================
   HEADER BUTTONS
   =================================== */
.preview-toggle, .layout-toggle, .theme-toggle { pointer-events: auto; }
.preview-button, .layout-button, .grid-toggle-btn, .theme-button { 
    background: var(--surface); border: 1px solid var(--border); 
    padding: 5px 10px; border-radius: 3px; cursor: pointer; transition: all 0.25s ease; 
    display: flex; align-items: center; justify-content: center; 
    font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); gap: 5px; pointer-events: auto; 
    letter-spacing: 0.06em;
}
.preview-button:hover, .layout-button:hover, .grid-toggle-btn:hover, .theme-button:hover { background: var(--hover-tint); border-color: var(--accent); color: var(--ink); }
.preview-button:active, .layout-button:active, .grid-toggle-btn:active, .theme-button:active { transform: scale(0.95); }
.preview-button.active { border-color: var(--accent); color: var(--accent); }
.layout-icon { width: 24px; height: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
.layout-icon.layered::before, .layout-icon.layered::after { content: ''; display: block; width: 100%; height: 6px; background: var(--ink-3); border-radius: 1px; transition: all 0.3s ease; }
.layout-icon.layered::after { opacity: 0.5; margin-top: -4px; }
.layout-icon.split::before, .layout-icon.split::after { content: ''; display: block; border-radius: 1px; transition: all 0.3s ease; }
.layout-icon.split::before { width: 10px; height: 100%; background: var(--ink-3); }
.layout-icon.split::after { width: 10px; height: 100%; background: var(--ink-3); margin-left: 4px; opacity: 0.5; }
.grid-toggle-btn { text-transform: uppercase; letter-spacing: 0.05em; }

/* New SVG layout icon styles */
.layout-icon-landscape, .layout-icon-portrait { stroke: var(--ink-3); transition: all 0.3s ease; }
body.layout-layered .layout-icon-landscape { display: block; }
body.layout-layered .layout-icon-portrait { display: none; }
body.layout-split .layout-icon-landscape { display: none; }
body.layout-split .layout-icon-portrait { display: block; }

/* ===================================
   IMAGE GRID OVERLAY
   =================================== */
.image-grid-overlay { 
    position: fixed; inset: 0; z-index: var(--z-overlay); background: var(--grid-overlay-bg); 
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
    display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; overflow-y: auto; 
}
.image-grid-overlay.open { display: flex; opacity: 1; }
.close-hotspot { 
    position: fixed; top: 0; right: 0; width: 25vw; height: 25vh; min-width: 150px; min-height: 150px; 
    z-index: calc(var(--z-overlay) + 10); cursor: none; display: none; pointer-events: auto; 
}
.grid-close-hotspot { z-index: calc(var(--z-overlay) + 10); display: none; }
body.grid-open .grid-close-hotspot { display: block; }
.split-close-hotspot { z-index: calc(var(--z-ui) + 10); display: none !important; }
.rotate-close-hotspot { z-index: calc(var(--z-rotate-warning) + 1); display: none; }
@media (orientation: portrait) { body.layout-split .rotate-close-hotspot { display: block; } }
#cursor.close-mode { width: 60px; height: 60px; border-color: var(--accent); background: var(--hover-tint-strong); }
#cursor.close-mode::before { content: '✕'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: var(--accent); line-height: 1; }
.grid-content { padding: 100px 5vw; max-width: 1600px; margin: 0 auto; width: 100%; will-change: transform; transition: transform 0.1s linear; }
.grid-chapter-section { margin-bottom: 60px; }
.grid-chapter-title { font-family: var(--ui-font); font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--grid-title-border); opacity: 0.7; }
.grid-images-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
.grid-image-item { position: relative; aspect-ratio: 4/3; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid var(--grid-item-border); transition: all 0.3s ease; background: var(--grid-item-bg); }
.grid-image-item:hover { transform: scale(1.02); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 2; }
.grid-image-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: opacity 0.3s ease; }
.grid-image-item:hover img { opacity: 0.4; filter: blur(2px); }
.grid-image-caption { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
.grid-image-item:hover .grid-image-caption { opacity: 1; }
.caption-text { color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); background: rgba(0, 0, 0, 0.85); padding: 8px 12px; border-radius: 4px; font-family: var(--body-font); font-size: 16px; line-height: 1.4; }

/* ===================================
   CUSTOM CURSOR
   =================================== */
#cursor { 
    position: fixed; top: 0; left: 0; width: 20px; height: 20px; 
    background: var(--cursor-bg);
    border: 1px solid var(--cursor-border); border-radius: 50%; pointer-events: none; z-index: 9999; 
    transform: translate3d(-50px, -50px, 0) translate(-50%, -50%); 
    transition: width 0.25s, height 0.25s, background-color 0.25s, border-color 0.25s, opacity 0.25s; 
    mix-blend-mode: var(--cursor-blend); will-change: transform;
    opacity: var(--cursor-opacity);
    overflow: hidden;
}
#cursor.hovering { width: 36px; height: 36px; background-color: var(--hover-tint); border-color: var(--accent); }
#cursor.pointer { width: 14px; height: 14px; background-color: var(--ink); }
#cursor.has-image { opacity: 0; }

/* Cursor thumbnail — letterbox, focus mode only */
#cursor-thumb {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    pointer-events: none;
    border-radius: 0;
    display: block;
    transition: opacity 0.2s ease;
}
#cursor.thumb-active {
    width: 220px;
    height: 130px;
    border-radius: 3px;
    border: 1px solid rgba(255,255,255,0.12);
    background: #000;
    mix-blend-mode: normal;
    opacity: 1;
    transition: width 0.2s cubic-bezier(0.25,1,0.5,1),
                height 0.2s cubic-bezier(0.25,1,0.5,1),
                border-radius 0.2s ease,
                opacity 0.15s ease;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
}
#cursor.thumb-active #cursor-thumb { opacity: 1; }

/* Suppress background image layer in focus mode — cursor IS the image */
body.focus-mode .hover-image { opacity: 0 !important; }

/* ===================================
   TOAST NOTIFICATIONS
   =================================== */
.toast-container {
    position: fixed;
    bottom: 72px;
    left: 44px;
    z-index: calc(var(--z-ui) + 50);
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-start;
    gap: 6px;
    pointer-events: none;
}
.toast {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface-raised);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 13px;
    font-family: var(--ui-font);
    font-size: 10px;
    color: var(--ink-2);
    letter-spacing: 0.04em;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    pointer-events: auto;
    cursor: pointer;
    opacity: 0;
    transform: translateX(-6px) scale(0.97);
    transition: opacity 0.25s cubic-bezier(0.25, 1, 0.5, 1),
                transform 0.25s cubic-bezier(0.25, 1, 0.5, 1);
    max-width: min(85vw, 340px);
    white-space: normal;
    text-align: left;
    line-height: 1.5;
}
.toast.visible {
    opacity: 1;
    transform: translateX(0) scale(1);
}
.toast.dismissing {
    opacity: 0;
    transform: translateX(-4px) scale(0.97);
}

/* Banner variant */
.toast.toast-banner {
    position: fixed;
    top: 64px;
    left: 50%;
    bottom: auto;
    transform: translateX(-50%) translateY(-12px) scale(0.97);
    max-width: min(92vw, 520px);
    text-align: center;
    justify-content: center;
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    box-shadow: 0 8px 36px rgba(0,0,0,0.5);
    font-size: 11px;
    padding: 11px 18px;
    gap: 10px;
    border-radius: 4px;
}
.toast.toast-banner.visible {
    transform: translateX(-50%) translateY(0) scale(1);
}
.toast.toast-banner.dismissing {
    transform: translateX(-50%) translateY(-8px) scale(0.97);
}

.toast-icon {
    font-size: 12px;
    flex-shrink: 0;
    opacity: 0.7;
}
.toast-text { line-height: 1.5; }
.toast-accent { color: var(--accent); font-weight: 600; }
.toast-action {
    margin-left: 4px;
    padding: 2px 7px;
    border: 1px solid var(--accent);
    border-radius: 2px;
    color: var(--accent);
    font-size: 9px;
    cursor: pointer;
    transition: background 0.15s ease;
    flex-shrink: 0;
    pointer-events: auto;
    white-space: nowrap;
}
.toast-action:hover { background: var(--hover-tint-strong); }

/* Toast rail bell button */
.toast-rail-btn {
    position: relative;
    width: 28px;
    height: 28px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-3);
    transition: color 0.2s ease;
    padding: 0;
}
.toast-rail-btn:hover { color: var(--accent); }
.toast-rail-btn svg { width: 18px; height: 18px; }
.toast-rail-dot {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}
.toast-rail-dot.active { opacity: 1; animation: dotPulse 2s ease-in-out infinite; }
@keyframes dotPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.6; }
}

/* Chapter logo pulse on chapter crossing */
.brand.chapter-pulse {
    border-color: var(--accent) !important;
    color: var(--accent) !important;
    background: var(--hover-tint-strong) !important;
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 25%, transparent);
    transition: all 0.2s ease !important;
}

@media (max-width: 768px) {
    .toast-container {
        left: 50%;
        bottom: 100px;
        transform: translateX(-50%);
        align-items: center;
    }
    .toast { text-align: center; transform: translateY(12px) scale(0.96); }
    .toast.visible { transform: translateY(0) scale(1); }
    .toast.dismissing { transform: translateY(8px) scale(0.97); }
}

/* ===================================
   ROTATE WARNING
   =================================== */
.rotate-warning { 
    position: fixed; inset: 0; z-index: var(--z-rotate-warning); 
    background: var(--bg-color); /* Theme aware background */
    backdrop-filter: blur(10px); 
    display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; 
    color: var(--accent); 
}
.rotate-warning svg { width: 48px; height: 48px; fill: var(--accent); margin-bottom: 20px; animation: rotateIcon 2s infinite ease-in-out; }
.rotate-warning p { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--ink); max-width: 300px; line-height: 1.6; }
@keyframes rotateIcon { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 75% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
@keyframes bounce { 0%, 100% { transform: rotate(45deg) translateY(0); } 50% { transform: rotate(45deg) translateY(8px); } }
@keyframes fadeInOut { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
@media (orientation: portrait) { body.layout-split .rotate-warning { display: flex; } }
.rotate-warning.visible { display: flex; }

/* ===================================
   RESPONSIVE BREAKPOINTS
   =================================== */
@media (max-height: 500px) and (orientation: landscape) {
    .scroll-progress { display: none; }
    .left-rail { display: flex; padding: 10px 4px 10px 0; }
    .mobile-nav-button { width: 36px; height: 36px; }
    .mobile-progress-text { font-size: 9px; }
    .text-layer { padding: 10vh 8vw 20vh; max-width: 90%; }
    .header { padding: 10px 20px; }
    .stream { font-size: clamp(16px, 3vw, 24px); }
    .preview-toggle { display: none; }
}

@media (max-width: 768px) {
    .scroll-progress { display: none; }
    .left-rail { display: flex; }
    .text-layer { padding: 12vh 6vw 20vh 50px; max-width: 95%; }
    .stream { font-size: clamp(16px, 4vw, 28px); }
    .hover-image { width: 800px; height: 600px; }
    .chapter-dropdown { min-width: 240px; }
    .grid-images-container { grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .grid-content { padding: 100px 10vw; }
    body.layout-split .text-layer { width: 100%; padding-left: 50px; padding-right: 20px; }
    body.layout-split .hover-image { position: absolute; left: 50%; top: 50%; width: 800px; height: 600px; transform: translate(-50%, -50%) scale(0.95); }
    @media (pointer: coarse) { #cursor { display: none !important; } }
    * { -webkit-tap-highlight-color: var(--hover-tint); }
    .nav-button { -webkit-tap-highlight-color: var(--hover-tint-strong); }
}

@media (prefers-reduced-motion: reduce) {
    .edge-blur { backdrop-filter: none; -webkit-backdrop-filter: none; }
    * { animation: none !important; transition: none !important; }
}

    /* H key: hide all UI chrome, leaving only the reading surface */
    body.ui-hidden .header,
    body.ui-hidden .scroll-progress,
    body.ui-hidden .left-rail,
    body.ui-hidden #keyboardLegend {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    /* statsWidget fades but nav buttons stay live in ui-hidden mode */
    body.ui-hidden #statsWidget {
        opacity: 0.08;
        transition: opacity 0.3s ease;
    }
    body.ui-hidden #statsWidget #hudPrevBtn,
    body.ui-hidden #statsWidget #hudNextBtn {
        opacity: 1;
        pointer-events: auto;
    }
    body:not(.ui-hidden) .header,
    body:not(.ui-hidden) .scroll-progress,
    body:not(.ui-hidden) .left-rail,
    body:not(.ui-hidden) #statsWidget,
    body:not(.ui-hidden) #keyboardLegend {
        transition: opacity 0.3s ease;
    }
    /* ui-hidden hotzone — top-right corner, matches existing close-hotspot geometry */
    .ui-hidden-hotspot {
        position: fixed;
        top: 0; right: 0;
        width: 25vw; height: 25vh;
        min-width: 150px; min-height: 150px;
        z-index: calc(var(--z-ui) + 5);
        cursor: none;
        display: none;
        pointer-events: auto;
    }
    body.ui-hidden .ui-hidden-hotspot { display: block; }

    /* focus-mode hotzone — same geometry */
    .focus-mode-hotspot {
        position: fixed;
        top: 0; right: 0;
        width: 25vw; height: 25vh;
        min-width: 150px; min-height: 150px;
        z-index: calc(var(--z-ui) + 5);
        cursor: none;
        display: none;
        pointer-events: auto;
    }
    body.focus-mode .focus-mode-hotspot { display: block; }
    /* Focus Mode */
    body.focus-mode .header,
    body.focus-mode .scroll-progress,
    body.focus-mode .left-rail,
    body.focus-mode #statsWidget,
    body.focus-mode #keyboardLegend {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
    }
    body.focus-mode .image-layer,
    body.focus-mode .hover-image,
    body.focus-mode .edge-blur,
    body.focus-mode .vignette {
        opacity: 0 !important;
        pointer-events: none;
        transition: opacity 0.25s ease;
    }
    body.focus-mode.image-active .sentence:not(.active) {
        opacity: var(--sentence-dimmed-opacity) !important;
        color: var(--sentence-dimmed-color) !important;
    }
    body.focus-mode .sentence.active { text-shadow: none; }
    @keyframes focusPulse {
        0%, 100% { box-shadow: 0 2px 0 0 var(--accent); }
        50%       { box-shadow: 0 2px 0 0 color-mix(in srgb, var(--accent) 50%, transparent); }
    }
    body.focus-mode .sentence.active { animation: focusPulse 1.8s ease-in-out infinite; }
    </style>
</head>
<body>



    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="false"></div>
    <div class="close-hotspot grid-close-hotspot" id="gridCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot split-close-hotspot" id="splitCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot rotate-close-hotspot" id="rotateCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="ui-hidden-hotspot" id="uiHiddenHotspot" aria-label="Move cursor here to restore UI"></div>
    <div class="focus-mode-hotspot" id="focusModeHotspot" aria-label="Move cursor here to exit focus mode"></div>
    
    <div class="rotate-warning" id="rotateWarning">
        <svg viewBox="0 0 24 24"><path d="M4 7.59l5-5c.78-.78 2.05-.78 2.83 0L20 10.76c.78.78.78 2.05 0 2.83L11.83 21.76c-.78.78-2.05.78-2.83 0l-5-5c-.78-.78-.78-2.05 0-2.83L4 7.59zM9 19.17l8.17-8.17L9 2.83 2.83 9 9 19.17zM17 12h-2v2h2v-2zm0-4h-2v2h2V8zm0-4h-2v2h2V4z"/></svg>
        <p>Please rotate your device to landscape for Split View.</p>
        <p style="font-size:11px;opacity:0.5;margin-top:12px;font-family:var(--ui-font);">TAP TO DISMISS</p>
    </div>

    <div id="keyboardLegend" class="keyboard-legend" title="Drag to move">
        <div class="drag-handle">⋮⋮</div>
        <div class="k-group">
            <div class="k-row">
                <div class="k-key" id="keyPrevSentence" aria-label="Previous Sentence">↑<span class="k-tooltip">Prev Sentence</span></div>
            </div>
            <div class="k-row">
                <div class="k-key" id="keyPrevChapter" aria-label="Previous Chapter">←<span class="k-tooltip">Prev Chapter</span></div>
                <div class="k-key" id="keyNextSentence" aria-label="Next Sentence">↓<span class="k-tooltip">Next Sentence</span></div>
                <div class="k-key" id="keyNextChapter" aria-label="Next Chapter">→<span class="k-tooltip">Next Chapter</span></div>
            </div>
        </div>
    </div>

    <div id="statsWidget" class="stats-widget" title="Drag to move" aria-label="Reading stats and navigation">
        <div class="stats-drag-handle">⋮⋮</div>
        <button class="hud-nav-btn" id="hudPrevBtn" aria-label="Previous Sentence" title="Previous (long-press for prev chapter)">
            <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
        </button>
        <div class="hud-divider"></div>
        <div class="stats-group">
            <div class="stat-item">
                <span class="stat-value" id="statSentencesSeen">1</span>
                <span class="stat-label">Sentences</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statBracketsOpened">0</span>
                <span class="stat-label">Brackets</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statChaptersRead">1</span>
                <span class="stat-label">Chapters</span>
            </div>
        </div>
        <div class="hud-divider"></div>
        <button class="hud-nav-btn" id="hudNextBtn" aria-label="Next Sentence" title="Next (long-press for next chapter)">
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
    </div>

    <div class="image-grid-overlay" id="imageGridOverlay" aria-hidden="true">
        <div class="grid-content" id="gridContent"></div>
    </div>

    <div id="cursor" aria-hidden="true"><img id="cursor-thumb" alt="" aria-hidden="true"></div>
    
    <div class="left-rail">
        <div class="lens-control-container">
            <button class="toast-rail-btn" id="toastRailBtn" title="Hints &amp; tips" aria-label="Show hints">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span class="toast-rail-dot" id="toastRailDot"></span>
            </button>
            <div class="accessibility-controls">
                <button class="accessibility-btn" id="accessibilityIncrease" aria-label="Increase accessibility" title="Increase">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
                <div class="accessibility-level" id="accessibilityLevel">
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator active"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                </div>
                <button class="accessibility-btn" id="accessibilityDecrease" aria-label="Decrease accessibility" title="Decrease">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
        </div>
    </div>
    
    <header class="header">
        <div class="brand-container">
            <div class="brand" id="brandLogo" aria-label="Open chapter menu">
                <span>If I May Be Frank</span>
                <span class="brand-dropdown-icon">▼</span>
            </div>
            <div class="chapter-dropdown" id="chapterDropdown" aria-hidden="true">
                <div class="chapter-dropdown-header" id="chapterDropdownHeader">
                    <span class="dropdown-drag-handle">⋮⋮</span>
                    <h3>Chapters</h3>
                </div>
                <ul class="chapter-dropdown-list" id="chapterDropdownList"></ul>
            </div>
        </div>

        <div class="mode-cluster" id="modeCluster" title="Drag to move" aria-label="Mode controls">
            <div class="mode-drag-handle">⋮⋮</div>
            <button class="mode-key" id="modeKeySpace" aria-label="Next sentence (Space)" title="Space — Next Sentence">
                <span class="mode-key-label">SPC</span>
                <span class="mode-key-desc">Next</span>
            </button>
            <button class="mode-key" id="modeKeyG" aria-label="Toggle image grid (G)" title="G — Image Grid">
                <span class="mode-key-label">G</span>
                <span class="mode-key-desc">Grid</span>
            </button>
            <button class="mode-key" id="modeKeyC" aria-label="Toggle chapter menu (C)" title="C — Chapters">
                <span class="mode-key-label">C</span>
                <span class="mode-key-desc">Chapters</span>
            </button>
            <button class="mode-key" id="modeKeyF" aria-label="Toggle focus mode (F)" title="F — Focus Mode">
                <span class="mode-key-label">F</span>
                <span class="mode-key-desc">Focus</span>
            </button>
            <button class="mode-key" id="modeKeyH" aria-label="Toggle read mode (H)" title="H — Read Mode">
                <span class="mode-key-label">H</span>
                <span class="mode-key-desc">Read</span>
            </button>
            <button class="mode-key" id="modeKeyT" aria-label="Toggle theme (T)" title="T — Theme">
                <span class="mode-key-label">T</span>
                <span class="mode-key-desc">Theme</span>
            </button>
            <button class="mode-key" id="modeKeyL" aria-label="Toggle layout (L)" title="L — Layout">
                <span class="mode-key-label">L</span>
                <span class="mode-key-desc">Layout</span>
            </button>
        </div>
    </header>

    <div class="edge-blur" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>

    <div class="scroll-progress" aria-label="Navigation controls">
        <button class="nav-button prev-sentence" id="prevSentenceBtn" title="Previous Sentence (↑/k)" aria-label="Previous Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
        </button>
        <div class="chapter-progress-container" id="chapterProgressContainer"></div>
        <button class="nav-button next-sentence" id="nextSentenceBtn" title="Next Sentence (↓/j)" aria-label="Next Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </button>
    </div>

    <main class="curved">
        <div class="parallax-container">
            <div id="imageLayer" class="image-layer">
                <div id="hoverImage" class="hover-image" role="tooltip" aria-hidden="true">
                    <img src="" alt="" id="hoverImageImg" loading="lazy">
                </div>
            </div>
            <div id="textLayer" class="text-layer">
                <article class="stream" id="stream" role="article"></article>
            </div>
        </div>
    </main>

    <script>
// ===================================
// IFIMAYBEFRANK - Complete JavaScript
// ===================================

const CONFIG = {
    TAIL_LENGTH: 12,
    CURSOR_SMOOTHING: 0.35,
    IMAGE_HOVER_DELAY: 120,
    TEXT_PARALLAX_STRENGTH: 0.03,
    IMAGE_PARALLAX_STRENGTH: 0.15,
    CENTER_MAGNET_STRENGTH: 0.25,
    PARALLAX_DAMPING: 0.1,
    SCROLL_THRESHOLD: 30,
    SCROLL_COOLDOWN: 100,
    LONG_PRESS_DURATION: 300,
    FLICK_THRESHOLD: 50
};

const state = {
    hoveredSentence: null,
    expandedBrackets: new Set(),
    imageActive: false,
    layoutMode: 'layered',
    currentSentenceIndex: -1,
    currentChapterIndex: 0,
    allSentenceElements: [],
    chapterStartIndices: [],
    subchapterStartIndices: [],
    gridImages: [],
    mouseX: 0,
    mouseY: 0,
    currentTriggerRect: null,
    imageTimeout: null,
    isTouch: false,
    lastInteractionWasTouch: false,
    scrollCooldownActive: false,
    touchStartY: 0,
    touchStartX: 0,
    touchMoved: false,
    // Stats tracking
    sentencesSeen: new Set(),
    bracketsOpened: 0,
    chaptersRead: new Set(),
    // Chapter-break dropdown opener tracking
    chapterBreakOpener: null
};

const cursor = { x: 0, y: 0, targetX: 0, targetY: 0, element: null, currentImageElement: null };
const parallax = { text: { x: 0, y: 0, targetX: 0, targetY: 0 }, image: { x: 0, y: 0, targetX: 0, targetY: 0 } };

// ===================================
// DATA
// ===================================
const chapters = [
    { id: 0, title: "Hello World", startText: "The year is 2026" },
    { id: 1, title: "Words from the Maker", startText: "This is my curriculum vitae" },
    { id: 2, title: "Introduction", startText: "I am Zack" },
    { id: 3, title: "The Early Days", startText: "I built my first computer" },
    { id: 4, title: "Suburbia Startup", startText: "A turning point at Turn5 Inc." },
    { id: 5, title: "#AgencyLife", startText: "One Sixty Over Ninety" },
    { id: 6, title: "The New York Experience", startText: "Enter FlightPath." },
    { id: 7, title: "Remote, Not Removed", startText: "This is the Whey" },
    { id: 8, title: "About", startText: "Currently I'm seeking my next" },
    { id: 9, title: "Conclusion", startText: "Beyond the work, there's music" },
    { id: 10, title: "Extras", startText: "You can find my music on SoundCloud" }
]

const imageMap = {
    'burn and turn': 'https://i.ibb.co/Y7wVfbfK/DSC08212.webp',
    'content churn': 'https://i.ibb.co/MD923R2f/DSC08254.webp',
    'void': 'https://i.ibb.co/MZbMqsT/6039d4bbb15be328fc33b54d-IMG-6478.jpg',
    'paused': 'https://i.ibb.co/BjZQ8KG/2322060064540385797-5144774570.jpg',
    'intentional': 'https://i.ibb.co/m5sNTvYX/603a967916b10d5bef5a6dd8-ZAX02712-1.webp',
    'beat': 'https://i.ibb.co/twyPzFZf/ZAX01304.webp',
    'moment to movement': 'https://i.ibb.co/gMDT38J5/IMG-20200527-221611-475.jpg',
    'I loathe to be so bold': 'https://i.ibb.co/0yjJ4j8L/603a967a5dc3e982f571b744-ZAX00968.webp',
    'my own way': 'https://i.ibb.co/bHsf63Q/2269150474215204867-5144774570.jpg',
    'conviction counters': 'https://i.ibb.co/bjCjbfbT/603a93efdfd184c21ef2d238-IMG-3352.webp',
    'curriculum vitae': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'my impetus': 'https://i.ibb.co/ym4M89VT/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'my innovations': 'https://i.ibb.co/r2nhMymB/1-Dkcm-PIZj6ro-ZML4w2k-Nk-Mw.webp',
    'eyes and mind': 'https://i.ibb.co/DPJM0yfz/1-k-Y6yg0chz7-Puu-Wgrl-YNMA.webp',
    'building something': 'https://i.ibb.co/Vc4F4vfT/ZAX09994.jpg',
    'proof of concept': 'https://i.ibb.co/9HzBPc7Y/603a93eea83b1aab7a98c35b-DSC08228.webp',
    'But first': 'https://i.ibb.co/9HWqZ86P/603a95edd9a3b56723de7edc-DSC00910.webp',
    'Zack': 'https://i.ibb.co/NZ0y6Hn/2272303929273225747-5144774570.jpg',
    'left-handed': 'https://i.ibb.co/Kp0wZtgT/ZAX01496.jpg',
    'self-taught': 'https://i.ibb.co/52Cm4Cf/63bc58fccaee2352e1c9b36d-Embedded-Image-3.jpg',
    'artist & craftsman': 'https://i.ibb.co/DDFpj6Dm/ZAX03810.jpg',
    'dreamer': 'https://i.ibb.co/hqCtdrS/ZAX02263.jpg',
    'to discover': 'https://i.ibb.co/FbxpWLhV/DSC08352-1.jpg',
    'built my first computer': 'https://i.ibb.co/fdxZdwwC/1-d-MG5-YE20sk-Uzo3z7-GIyf1w.webp',
    'pirated copies': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'study at university': 'https://i.ibb.co/gbVdcLRq/hands-by-zackgort-dckl0r-375w-2x.jpg',
    'studied what I saw': 'https://i.ibb.co/mVkj6sxm/1-g-Ax-Wr-Bz-Rv-QDdn-TOBp-GHGt-A.webp',
    'observed, almalgamated, and carried my craft': 'https://i.ibb.co/zWddYDKH/1-b7-R1-Bb-D3kn-TIbl-Ly-MZd-Xg.webp',
    'what I saw around me': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'studied typography': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'client work': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'reading books': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'examining magazines': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'faux website concepts': 'https://i.ibb.co/DHHzHw8G/1-pu-HZ09-ELFPd-Aa-MK0-HAxq-Q.webp',
    'Craigslist post': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'cover letter': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'formal education': 'https://i.ibb.co/WpPWpTwN/Oaks-2.webp',
    'Turn5 Inc': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'where you wear the hat you want': 'https://i.ibb.co/XfC5FTbn/IMG-20200505-222710-446.webp',
    'Canon Rebel': 'https://i.ibb.co/W42LZmDK/ZAX01271.jpg',
    'Charged with designing': 'https://i.ibb.co/fG0dXSr0/1-m7-Hfhu-QO4-Ugr1-Vte-Zf6it-A.webp',
    'package design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'catalogue design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'product photographer': 'https://i.ibb.co/C38FHDx9/1-FYt-Vic-HKj-LDPLW2rcn-J1u-A.webp',
    'OEM quality': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'Photographing and retouching': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'Pivot to web': 'https://i.ibb.co/sv8nw0Dp/1-rqzz-Cscn-OIL96-Vm-Ln0v7d-A.webp',
    'We designed everything from ground-up': 'https://i.ibb.co/QdmJdXh/AM-wire.jpg',
    'email and ads': 'https://i.ibb.co/vxXJ7fSV/1-rqzz-Cscn-OIL96-Vm-Ln0v7d-A.webp',
    'user testing': 'https://i.ibb.co/fG0dXSr0/1-m7-Hfhu-QO4-Ugr1-Vte-Zf6it-A.webp',
    'forty million per year': 'https://i.ibb.co/YTKt6LcS/IMG-20210515-151006.webp',
    'city life': 'https://i.ibb.co/zhPSN9QQ/1-6-Cxwk-Ywhhn5-Z-FHINfdp-WA.webp',
    'Leadnomics': 'https://i.ibb.co/ZG6v0p5/image-10.png',
    'multiple verticals': 'https://i.ibb.co/KLPDrZQ/image-5-Copy.png',
    'payday loans': 'https://i.ibb.co/7N4r6FF5/603d0b8b04655c6fd42d2253-DSC08281.jpg',
    'catastrophic financial decisions': 'https://i.ibb.co/7JX2kx7T/DSC08804.jpg',
    'pay and perks': 'https://i.ibb.co/5jqqSwp/Cx-BW-h-GXg-AQt-K2m.jpg',
    'conversion rate': 'https://i.ibb.co/N3Sj82y/6463e2dfb2d84c89977adcf7-IMG-20200204-185021-01.jpg',
    'Business bides by imperative': 'https://i.ibb.co/PG3F2y6D/vermont-509.jpg',
    'completely comminuted clavicle': 'https://i.ibb.co/Z1NBn9Px/clavicle.webp',
    'downtime': 'https://i.ibb.co/pvJvGhnt/ZAX02330-1.webp',
    'Karma': 'https://i.ibb.co/h1yDszfq/2863797725928703996-5144774570.webp',
    'I think so': 'https://i.ibb.co/BHKQwjNL/life.webp',
    'interactive haiku': 'https://i.ibb.co/27BznHGJ/1-BNs-Ch8k1bclj-KMu1-KN-g.gif',
    'Enter #agencylife': 'https://i.ibb.co/twJMjr51/IMG-20150924-142223609.webp',
    'One Sixty Over Ninety': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    'Interactive Department': 'https://i.ibb.co/fd8Ycjyv/1-pch6xh-Ep-Fo-Xxli-AGb-Nnr7-Q.webp',
    'longer nights': 'https://i.ibb.co/yBcGXrQc/IMG-20150415-134735718.webp',
    'lots of weekends': 'https://i.ibb.co/SwzHM3CZ/1-o-P6kr-DDq-Pp-Sg-F4-Ag-Fr-WClw.webp',
    'grayscale wireframes': 'https://i.ibb.co/nNLv6NKB/1-CQ-4u-Tk-D6-MUBWABKw-JIZg-A.webp',
    'Clients included': 'https://i.ibb.co/8LmdVjbY/160over90brands.webp',
    'scientific': 'https://i.ibb.co/SzM25Fb/1-vk-U8l-Zmqn-OHghe-Os-K0qtrw.webp',
    'expressive': 'https://i.ibb.co/0VmJ708g/work3.webp',
    'novel': 'https://i.ibb.co/k2CCgp95/1-b8ad-Q-Cb-L1-YXoe6o-Fs4t-SQ.webp',
    'considered': 'https://i.ibb.co/pBYP6wt8/1-HXIU3nxu-ZGq-Ne-Ef3-Wv-Lf-MQ.webp',
    'I had a hand': 'https://i.ibb.co/rR74bLkf/1-o-XV3b-GDEf-TKoh-Ue-ICCjc1-A.webp',
    'O3 World': 'https://i.ibb.co/LXmyD2hq/IMG-20170104-184947-650.webp',
    'digital product shop': 'https://i.ibb.co/Swf714Sd/o3.webp',
    'agile in nature': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'scrum led': 'https://i.ibb.co/mr7gnpTg/1-y-GJCqkzizxa-Uxk3-R5-DCD8g.webp',
    'daily stand-ups': 'https://i.ibb.co/zTKr9Dh9/1-7w-EKA8du-Scc-OZw-Im-A-6j-SQ.webp',
    'Lean UX': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'we workshopped': 'https://i.ibb.co/ZW3j6T1/Photo-Selects-Sketch-Prep-1-1-Houghton-Nav.jpg',
    'we wireframed': 'https://i.ibb.co/Dg9fM8q8/1-Tut-Ce-PQB0b-SCo-Mf-MTWJb-Q.webp',
    'we shipped': 'https://i.ibb.co/v4q7TbDZ/1-t-Yd-DX2-Ql-VLw-XI7gm3ev-MLw.webp',
    'Downtown from Fishtown was Workarea': 'https://i.ibb.co/mjt5Myw/1-l-EJetj-Ut85-CTbb24d-BTFk-A.webp',
    'napkin sketches': 'https://i.ibb.co/ZzCTQbWf/1-e-SNZnvlr-UJAz-AL1-Jx-T0-ZHQ.webp',
    'Five Foot Gorilla': 'https://i.ibb.co/mjt5Myw/1-l-EJetj-Ut85-CTbb24d-BTFk-A.webp',
    'proprietary SaaS': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'reframe': 'https://i.ibb.co/C3fQ63NH/vermont-500.jpg',
    'Enter FlightPath': 'https://i.ibb.co/3xrYxxR/ZAX09787.jpg',
    'Hello, New York City': 'https://i.ibb.co/HpnrrYMR/2269419019461331921-5144774570.webp',
    'emerging from bankruptcy': 'https://i.ibb.co/k2svMNFv/603d10120fba838e599b6b5e-IMG-1563.webp',
    'Sure, this was risky': 'https://i.ibb.co/DD6wrNzS/603d102dae26b192aef6ab4a-IMG-3023.jpg',
    'They needed my help': 'https://i.ibb.co/N6hxQ0RG/1-k-SDc-GT46-VQM6-Kk25-SPr-Acg.webp',
    'influence': 'https://i.ibb.co/2KG97tH/63bc73fb17c4cf8bb0731b4f-IMG-20220717-004144-444.webp',
    'confidence': 'https://i.ibb.co/xHcVc0k/63bc73fb6521f9025bdacc8c-IMG-20220719-182310-414.webp',
    'I had agency': 'https://i.ibb.co/gTrCrJd/6463e0a86edfa1bd8ed7ed78-IMG-20220625-231733-173.webp',
    'WCAG': 'https://i.ibb.co/WpyqgbYQ/1-9-EZTgvxtt-DXOac-Hz-I9axe-Q.gif',
    'Commuting from Philly': 'https://i.ibb.co/23WVc0PW/tunnel-ANIMATION.gif',
    'Up and out': 'https://i.ibb.co/LdDMT8zw/pennstation.webp',
    'Sunrise and Sunset': 'https://i.ibb.co/chqNfQGJ/skylinephilly.webp',
    'skylines': 'https://i.ibb.co/cK6Nywxq/skyline.webp',
    'wear & tear': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'killing it': 'https://i.ibb.co/21QjMR93/commute.webp',
    'found love': 'https://i.ibb.co/gtfnzmc/6463db5b885de5f0e9c14019-IMG-20190918-010900-01-1.jpg',
    'From Workarea to LiveArea': 'https://i.ibb.co/mSR1GDc/2309287483437628607-5144774570.jpg',
    'world worked': 'https://i.ibb.co/HVt8q9Q/63bc58fdd5af3c7496ddc47b-Embedded-Image-18.jpg',
    'Once familiar faces faded': 'https://i.ibb.co/LQyhkV7/2421291975296513469-5144774570.jpg',
    'muffled, or on mute': 'https://i.ibb.co/9HPBnC6/2278045066214592879-5144774570.jpg',
    
    'bandwidth': 'https://i.ibb.co/5pYQjBh/ZAX04125.jpg',
    'The show must go on': 'https://i.ibb.co/8cFGqNB/6463c90009f6d464ffca5fe3-wellbeaight.jpg',
    'more time computing': 'https://i.ibb.co/Xr97WzXX/DSC06055-1.webp',
    'Camera on': 'https://i.ibb.co/B6vFwH6/zoom-zack.gif',
    'This is the Whey': 'https://i.ibb.co/09K8Z99/image-624.png',

    'Cards Against Bad UX': 'https://i.ibb.co/jv7dC3hH/1-m-Zdgz7y-Elh7n-WKuu-S8-XZ2g.webp',
    'jargon-laden spreadsheets': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'single-sided meetings': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'As a shopper': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'content manager': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'guest user': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'LiveArea': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'UX Manager': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'one-point-two million': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$1.2m': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'two-thirty-five per hour': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$235/hr': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'Elva Design Group': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'Elva': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'General Nutrition Centers': 'https://i.ibb.co/pBMMxY1Z/11.webp',
    'GNC': 'https://i.ibb.co/7N2rDqrN/8.webp',
    'mobile-first navigation': 'https://i.ibb.co/vx76zjgf/10.webp',
    'shake things up': 'https://i.ibb.co/rft2bf0T/9.webp',
    'modernized and optimized': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'Huge': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'single user flow': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'siloed': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'Code and Theory': 'https://i.ibb.co/jP8rS95G/1-5g-Mvv7027-cm7r0vm-IDy1-A.webp',
    'Senior Designer': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'ACD': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'Directly Responsible Individual': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'Publicis Sapient': 'https://i.ibb.co/XkM2hn8n/bny1.png',
    'Digital Transformation': 'https://i.ibb.co/vvMZmq94/bny2.png',
    'BNY Mellon': 'https://i.ibb.co/xS49C07B/bny3.png',
    'Team Lead': 'https://i.ibb.co/rR74bLkf/1-o-XV3b-GDEf-TKoh-Ue-ICCjc1-A.webp',
    'exhaustive research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'industry research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'client workshops': 'https://i.ibb.co/XfXGRWZ5/1-RTEI5a-Ccw31fj-Fzqj-Bg-FEg.webp',
    'consistent presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'in-office presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'laid off': 'https://i.ibb.co/jkpcGvMF/1-f-TX-d-BN7l7of-M3nf-KU7p8g.webp',
    'Design Systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'design systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'data paradigm': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'networking': 'https://i.ibb.co/sJkpkV9Q/1-l4jg-O1-4g-Ey-Wy-IBEQZho0g.webp',
    'low voltage networking': 'https://i.ibb.co/sJkpkV9Q/1-l4jg-O1-4g-Ey-Wy-IBEQZho0g.webp',
    'RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'terminate an RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    '30–45 seconds': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'thirty to forty-five seconds': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'Run cables': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'security systems': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'cable management': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'twist parity': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'different parts of my brain': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'intoview.pro': 'https://i.ibb.co/ym1z1pyb/DSC05994.webp',
    'intoview': 'https://i.ibb.co/ym1z1pyb/DSC05994.webp',
    'platform for creative exploration': 'https://i.ibb.co/23QsQrCG/DSC05954.webp',
    'note-taking app': 'https://i.ibb.co/qLWQC0cN/DSC08358.webp',
    'kanban': 'https://i.ibb.co/xSCsZcyn/wmzWGlaw.webp',
    'emdash.click': 'https://i.ibb.co/0p7Ktz5L/1-Tut-Ce-PQB0b-SCo-Mf-MTWJb-Q.webp',
    'em dash utility': 'https://i.ibb.co/0p7Ktz5L/1-Tut-Ce-PQB0b-SCo-Mf-MTWJb-Q.webp',
    'sees potential': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'someone out there': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'mouths to feed': 'https://i.ibb.co/gpr7smN/1-Zs0lu-PIi-C5ly-AOEo2-LLEl-A.webp',
    'think different': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'play guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'take photographs': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'Wolfgang': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'my dog': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'Bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'non-linear': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'career journey': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'A-list brands': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp',
    'global scale': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp',
    'pink onesie': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'pink onezie': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'systems thinking': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'hands-on prototyping': 'https://i.ibb.co/NdwrPWfV/1-Na-ZV6rc-Ew-RT55p-R12-BY0jg.webp',
    'bridge design and development': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'photographs': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'AI': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'uplift imagination': 'https://i.ibb.co/DPJM0yfz/1-k-Y6yg0chz7-Puu-Wgrl-YNMA.webp'
}

const phraseRegexMap = new Map();
Object.keys(imageMap).forEach(phrase => {
    const escapedPhrase = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    phraseRegexMap.set(phrase, new RegExp(`\\b${escapedPhrase}\\b`, 'gi'));
});

const narrative = `The year is 2026. Burn and turn. Content churn. We fade fast into the void. But, what if we paused? What if reading felt intentional again? Beat by beat, beat for beat. From moment to movement. I loathe to be so bold [This is not some grand manifesto about the state of UX] — but may I say, conviction counters convention [Strong belief resists being carried by the current of convention.]

This is my curriculum vitae. [A polished portfolio seems disingenuous to me. Facts are never facts. Truths are almost always half-lies. Capabilities become curbed. We move through content that does not move us. It feels static. It feels stale. It feels safe.] My impetus. My innovations. Through the eyes and mind — and lens — of the beholder [The underlying mechanism that defines the user experience of this site concept is a 'stream of consciousness']

//Truth be told, I'm building something beyond this. [] May this serve as a proof of concept — if not of the final product, but of my approach. But first, let me introduce myself properly.
//I am Zack — Thinker & Maker. [musician, photographer, writer, roamer, wanderer, nomad, Metallica fan] A left-handed autodidact with an affinity for alliterative apropros. [sic] A self-taught designer who learned to code. [amongst many things] An observer, a ponderer, and a dreamer. An artist & craftsman. I seek not to disrupt, but to discover. [All em dashes in this piece were sourced from www.emdash.click]


I built my first computer circa 2005 into 2006. I immediately installed pirated copies of Adobe Photoshop and Illustrator. [bootstrap roots] While I didn't study at university long enough to graduate, [stop-out, not drop-out] I studied what I saw. [] I observed, amalgamated, and carried my craft through conviction. I read books, flipped through magazines, and took on client work. I created faux website concepts to understand designing for the medium. All this culminated in responding to a Craigslist post that changed everything. [] A garage startup in the suburbs of Philadelphia that would become my formal education.

A turning point at Turn5 Inc. The kind of place where you wear the hat you want. I was handed a brand new PC and a Canon Rebel DSLR. Charged with designing for our web properties, product packaging, printed catalogues, emails and ads; all across multiple brand systems. Add product photography and retouching, specializing in color match and OEM quality. Photographing and retouching thousands of parts.

### Design By Data.
Pivot to web design, focusing on email marketing and bespoke feature design. We designed everything from ground-up. We built a lifestyle brand that grew from ten to forty million per year during my time at Turn5. I played my part, but I wanted to escape suburbia with my eyes set on city life.

### From Suburbs to the City.
Leadnomics was shifty — paradigm shifty. [sic] We focused on lead generation across multiple verticals. But our cash cow were payday loans. [Look, I did not know this till after I started working there, but as I was merely the conduit, and not the lender, nor the shark, my conscience abided] Said bluntly, my job was to make it easy for our users to make catastrophic financial decisions. I achieved a 95.8% conversion rate using responsive design and rigorous testing. [I am not proud of this, per se; it was actually 98.5%, but that seems less believable] But the pay and perks were great — free lunches, flexible work, nice views. [seeing the city skyline from across the river behooved my next career move] Business bides by imperative, not by idealism.

### Re-evaluate, then engage.
Nearing three years with this company, I found myself with a completely comminuted clavicle. [cycling slip along the Schuylkill River Trail] Karma? I think so. [It gave me a moment to pause, evaluate, and act] I spent my downtime learning to code — HTML, CSS, and JavaScript. I built an interactive haiku to test my skills — it wasn't profound, but it proved potential. Enter #agencylife.

One Sixty Over Ninety — my heartrate when offered a job as an Interaction Designer in Center City, Philadelphia. I took a pay cut to join their new Interactive Department, but I was there to learn. Clients included Comcast, Kent State, and the Philadelphia Eagles. We worked long days, longer nights, and short weekends. Lots of weekends.

//The culture demanded we dare. [to try; to push beyond] The agency invited creatives to take risks; operating and ideating beyond our comfort zone. The work wasn't scientific. It was expressive. It was novel. It was considered. As an interactive designer, I had a hand in every aspect of the creative process.

### A Digital Product Shop.
O3 World was an elevating experience. A digital product shop in the heart of Fishtown, Philly. We were Agile in nature and scrum led. [via a certified scrum master] We held daily stand-ups to manage projects for clients like La Colombe, Vertex, and SEIC. [E-commerce via Shopify; Web App for small business owners, and enterprise scale financial products]
//We practiced true Lean UX methodologies. We workshopped with whiteboards. We wireframed with Balsamiq. We shipped.

### A Bona Fide Dev Shop.
Downtown from Fishtown was Workarea, where I worked on a proprietary SaaS platform. We skipped high-fidelity mockups for napkin sketches and direct collaboration with developers. We were a dev-shop through and through. We built things better, faster, smarter. The company sold, requiring I reframe my approach.

Enter FlightPath. Hello, New York City. Emerging from bankruptcy, the agency served the pharmaceutical sector. [now reduced from a bustling two-floor office in Midtown to a mere ten dedicated employees; with I being one to join them] They needed my help, and this was my foot-in-the-door to the NYC scene. [This was risky. It was not lucrative. Passable at best, but FlightPath was always only ever to be my runway]
//
Sure, this was risky, but I was already in motion. Here, I had influence. With that, came confidence. [I worked on rigorous WCAG compliance for our Pharma clients: Merck, Vetsulin, Charter, Organic Girl, Goya, and several non-profits] I had agency at this agency. Commuting from Philly to Manhattan — and back — every business day for a full year. Up and out by five o'clock; home by ten o'clock — maybe. Saw both Sunrise and Sunset every day away from home. Two skylines, three hours apart. Why? Despite the wear & tear, I was moving forward.

### From Midtown to Uptown.
From Workarea to LiveArea. From IC to Manager — I owned the UX process for a gamut of B2B & B2C brands. [via the Salesforce Commerce Cloud platform] It was the most ownership I had held to date. I ran discovery. I directed and delegated. I did the work too, by the way. 

### Workshopping.
After several rounds of our client becoming increasingly overwhelmed and frustrated with unfamiliar process, I crafted "Cards Against Bad UX" to help clients empathize with users. [A card game played in workshops to humanize the user and depoliticize the design conversation] By shifting the conversation from features to feelings — from the guest user and content manager, not the executive stakeholder — we saved the contract. Clients don't always know what they want. They always know how something makes them feel.

### COVID.
Something shifted as the world worked through the COVID pandemic. Once familiar faces faded behind canceled cameras. Now shadows, muffled, or on mute. [meta commentary on the fascinating phenomena of people suddenly becoming introverts] Business is busyness.

Less time commuting, more time computing.  Camera on. 2021 was a very busy year. [I had earned WFH priveleges since 2011, so this was nothing new]

This is the Whey. At Elva Design Group, I led discovery for GNC. Management wanted to shake things up. We designed a mobile-first navigation schema — restructured, not reskinned. We didn't have time for perfection, but we successfully modernized and optimized their online experience. Sometimes the win is knowing when good is good enough.

### Small Cog in a Huge Wheel.
At Huge, teams were massive. I was responsible for a single user flow, unaware of what the other twelve designers on the project were doing. To say we were siloed would be an understatement. I learned what I didn't want from a place of work. That is also valuable.

### From the 62nd of the One World Trade Center.
At Code and Theory, I was hired as a Senior Designer with sights on ACD. I quickly proved my worth. [Within three weeks I was running client calls solo] But leadership churn and a revolving door of priorities made it a disorienting experience. I acted as a Directly Responsible Individual for UX and strategy across multiple workstreams simultaneously. I learned hard lessons about large agencies — chief among them: visibility matters as much as output.

### Hello from Agency Row.
Enter Publicis Sapient. I spent a year working on Digital Transformation for BNY Mellon. I became the de facto Team Lead, driving exhaustive research, client workshops, and weekly readouts to senior stakeholders. [I was not hired as a lead. I became one because no one else stepped up.] I secured a contract extension through documented impact. Despite my consistent presence and hard work, I was laid off in a round of cuts. I was just a number on a spreadsheet. [It stings less when you understand that enterprise agencies run on utilization rates, not merit]

### Down But Not Out.
Come on baby, let's do the twist. I pivoted to low voltage networking. [Bear with me] I learned to terminate an RJ45 in 30–45 seconds. I run cables, install security systems, and manage cable management in commercial and residential settings. It requires specific twist parity and a steady hand. I'm using different parts of my brain — the same brain that once wireframed enterprise banking platforms. [Humility is a hell of a teacher] I still have mouths to feed. I keep moving.

As an aside, I've been building. I repurposed intoview.pro as a platform for creative exploration — it started as an interview tool and became something more personal. I built a note-taking app and a kanban board to scratch my own itch. I created emdash.click because the em dash is underused and undervalued, and the world needed a one-click solution. [Every em dash in this piece came from there] These aren't just portfolio pieces; they are functioning products that prove I can build — not just design.

### Seek & Employ.
Currently I'm seeking my next full-time role. I want work that matters with people who care. I am not looking for a title. I am looking for a team. I offer systems thinking and hands-on prototyping — I bridge design and development because I have lived on both sides of the handoff. [I have been the designer who couldn't explain the spec, and I became the one who could build it] I think. I make. I ship.

### Work to Eat. Eat to Live. Live to Skate. Skate to Work.
Beyond the work, there's music. I play guitar left-handed — started at fifteen, never stopped. [Metallica, Arctic Monkeys, and whatever is in the rotation that week] I take photographs of New York the way a tourist never would — alleys, fire escapes, the underside of the Williamsburg Bridge at 6am. I have a dog named Wolfgang. [he is a very good boy] I once chased and helped safely capture a wild zebra through the streets of West Philly. [true story; his name was Majesty; he was fine]
//
I am not worried about AI taking our jobs. My talent is presenting ideas that uplift imagination. I do this with capable hands, a curious mind, and twenty years of scar tissue. [I think different]

### Connect.
You can find my music on SoundCloud. My photography lives on Instagram. My full portfolio lives at zackgort.com. If something here moved you — even one sentence — I would love to hear from it. Thanks for reading one sentence at a time.`


// ===================================
// UTILITY FUNCTIONS
// ===================================
const Utils = {
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) { func.apply(this, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }
        };
    },
    $(selector) { return document.querySelector(selector); },
    $$(selector) { return Array.from(document.querySelectorAll(selector)); }
};

// ===================================
// STATS WIDGET
// ===================================
function pulseStatValue(elId) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.remove('pulse');
    void el.offsetWidth; // reflow to restart animation
    el.classList.add('pulse');
    el.addEventListener('animationend', () => el.classList.remove('pulse'), { once: true });
}

function updateStats() {
    const sentencesEl = document.getElementById('statSentencesSeen');
    const bracketsEl = document.getElementById('statBracketsOpened');
    const chaptersEl = document.getElementById('statChaptersRead');
    if (sentencesEl) sentencesEl.textContent = state.sentencesSeen.size;
    if (bracketsEl) bracketsEl.textContent = state.bracketsOpened;
    if (chaptersEl) chaptersEl.textContent = state.chaptersRead.size;
}

function trackSentence(index) {
    const wasNew = !state.sentencesSeen.has(index);
    state.sentencesSeen.add(index);
    if (wasNew) {
        pulseStatValue('statSentencesSeen');
        updateStats();
    }
    toastBehaviors.onSentenceAdvance();
}

function trackChapter(chapterId) {
    const wasNew = !state.chaptersRead.has(chapterId);
    state.chaptersRead.add(chapterId);
    if (wasNew) {
        pulseStatValue('statChaptersRead');
        updateStats();
        toastBehaviors.onChapterAdvance();
    }
}

function trackBracketOpen() {
    state.bracketsOpened++;
    pulseStatValue('statBracketsOpened');
    updateStats();
    toastBehaviors.onBracketOpened();
}

// ===================================
// TOAST NOTIFICATION SYSTEM
// ===================================
const Toast = (() => {
    const SHOWN_KEY = 'frank_toasts_shown';
    const shown = new Set(JSON.parse(sessionStorage.getItem(SHOWN_KEY) || '[]'));

    function markShown(id) {
        shown.add(id);
        sessionStorage.setItem(SHOWN_KEY, JSON.stringify([...shown]));
    }

    function hasShown(id) { return shown.has(id); }

    let activeToasts = 0;

    function show({ id, icon = '💡', message, actionLabel = null, actionFn = null, duration = 6000, force = false, banner = false, onDismiss = null }) {
        if (!force && hasShown(id)) return;
        if (!banner && activeToasts >= 2) return; // banners bypass stack limit

        const container = document.getElementById('toastContainer');
        if (!container) return;

        const el = document.createElement('div');
        el.className = banner ? 'toast toast-banner' : 'toast';
        el.setAttribute('role', 'status');
        el.innerHTML = `
            <span class="toast-icon">${icon}</span>
            <span class="toast-text">${message}</span>
            ${actionLabel ? `<span class="toast-action" id="toast-action-${id}">${actionLabel}</span>` : ''}
        `;

        // Banners go to body directly so they aren't offset by the rail container
        if (banner) {
            document.body.appendChild(el);
        } else {
            container.appendChild(el);
            activeToasts++;
        }
        markShown(id);

        // Trigger entrance
        requestAnimationFrame(() => {
            requestAnimationFrame(() => el.classList.add('visible'));
        });

        const dismiss = () => {
            if (!el.parentNode) return;
            el.classList.remove('visible');
            el.classList.add('dismissing');
            setTimeout(() => {
                el.remove();
                if (!banner) activeToasts = Math.max(0, activeToasts - 1);
                if (onDismiss) onDismiss();
            }, 350);
        };

        const timer = setTimeout(dismiss, duration);

        if (actionLabel && actionFn) {
            const btn = el.querySelector(`#toast-action-${id}`);
            if (btn) btn.addEventListener('click', (e) => {
                e.stopPropagation();
                clearTimeout(timer);
                dismiss();
                actionFn();
            });
        }

        el.addEventListener('click', () => { clearTimeout(timer); dismiss(); });
    }

    return { show, hasShown };
})();

// ===================================
// TOAST BEHAVIORS (triggers)
// ===================================
const toastBehaviors = (() => {

    const isMobile = () => window.innerWidth <= 768 || state.isTouch;

    // ── Rail dot indicator ──
    function setRailDot(active) {
        const dot = document.getElementById('toastRailDot');
        if (dot) dot.classList.toggle('active', active);
    }

    // ─── Ambient pool ───
    const AMBIENT_POOL = [
        {
            id: 'amb-hide-ui',
            icon: '◻',
            message: () => 'Press <span class="toast-accent">H</span> to hide the interface — just you and the text.',
            actionLabel: 'Try it',
            actionFn: () => toggleUIVisibility()
        },
        {
            id: 'amb-theme',
            icon: '☀️',
            message: () => 'Try a different mood — toggle the <span class="toast-accent">theme</span> in the top right.',
            actionLabel: 'Switch',
            actionFn: () => toggleTheme()
        },
        {
            id: 'amb-split',
            icon: '◫',
            message: () => 'Try <span class="toast-accent">Split View</span> — text on the left, imagery on the right.',
            actionLabel: 'Try it',
            actionFn: () => { if (state.layoutMode === 'layered') toggleLayout(); },
            condition: () => state.layoutMode === 'layered'
        },
        {
            id: 'amb-grid',
            icon: '▦',
            message: () => '<span class="toast-accent">Display</span> shows all chapter imagery in one view.',
            actionLabel: 'Open',
            actionFn: () => toggleImageGrid()
        },
        {
            id: 'amb-zoom',
            icon: '🔍',
            message: () => isMobile()
                ? 'Adjust text size with the <span class="toast-accent">zoom</span> control on the left edge.'
                : 'The <span class="toast-accent">zoom</span> rail on the left adjusts reading size.'
        },
        {
            id: 'amb-chapters',
            icon: '📖',
            message: () => isMobile()
                ? 'Tap <span class="toast-accent">If I May Be Frank</span> to jump between chapters.'
                : 'Click the logo to open the <span class="toast-accent">chapter menu</span> — or use ← →.',
            actionLabel: 'Chapters',
            actionFn: () => toggleChapterDropdown()
        }
    ];

    let ambientTimer = null;

    function scheduleNextAmbient() {
        const remaining = AMBIENT_POOL.filter(t =>
            !Toast.hasShown(t.id) && (!t.condition || t.condition())
        );
        if (remaining.length === 0) return;
        const delay = 45000 + Math.random() * 45000;
        ambientTimer = setTimeout(() => {
            const eligible = remaining.filter(t => !t.condition || t.condition());
            if (eligible.length === 0) { scheduleNextAmbient(); return; }
            const pick = eligible[Math.floor(Math.random() * eligible.length)];
            setRailDot(true);
            Toast.show({
                id: pick.id,
                icon: pick.icon,
                message: typeof pick.message === 'function' ? pick.message() : pick.message,
                actionLabel: pick.actionLabel || null,
                actionFn: pick.actionFn || null,
                duration: 12000,
                onDismiss: () => setRailDot(false)
            });
            scheduleNextAmbient();
        }, delay);
    }

    // ─── Idle detection ───
    let idleTimer = null;
    let returnTimer = null;
    let lastSentenceIndexAtIdle = -1;
    const IDLE_THRESHOLD = 15000;     // 15s cold idle
    const RETURN_THRESHOLD = 60000;   // 60s away = "return" scenario

    function resetIdleTimer() {
        clearTimeout(idleTimer);
        clearTimeout(returnTimer);
        idleTimer = setTimeout(onIdle, IDLE_THRESHOLD);
    }

    function onIdle() {
        lastSentenceIndexAtIdle = state.currentSentenceIndex;
        // If user goes very long without any input, set a return detection
        returnTimer = setTimeout(() => {
            // returnTimer fires — next interaction triggers onReturn
            document.addEventListener('keydown', onReturn, { once: true });
            document.addEventListener('wheel', onReturn, { once: true });
            document.addEventListener('click', onReturn, { once: true });
            document.addEventListener('touchstart', onReturn, { once: true });
        }, RETURN_THRESHOLD - IDLE_THRESHOLD);

        if (Toast.hasShown('idle-nav')) return;
        setRailDot(true);
        Toast.show({
            id: 'idle-nav',
            icon: '⌨️',
            message: isMobile()
                ? 'Tap the <span class="toast-accent">arrows</span> or swipe to navigate sentence by sentence.'
                : 'Press <span class="toast-accent">Space</span> or <span class="toast-accent">↑↓</span> to navigate sentence by sentence.',
            duration: 12000,
            onDismiss: () => setRailDot(false)
        });
    }

    function onReturn(e) {
        // Clean up other listeners
        ['keydown','wheel','click','touchstart'].forEach(ev =>
            document.removeEventListener(ev, onReturn)
        );
        if (Toast.hasShown('return-welcome-back')) return;
        const sameSentence = state.currentSentenceIndex === lastSentenceIndexAtIdle;
        setRailDot(true);
        Toast.show({
            id: 'return-welcome-back',
            icon: '↩',
            message: sameSentence
                ? 'Welcome back — press <span class="toast-accent">Space</span> to pick up where you left off.'
                : 'Good to have you back. <span class="toast-accent">Keep reading.</span>',
            duration: 12000,
            onDismiss: () => setRailDot(false)
        });
    }

    // ─── Scroll wheel analysis ───
    let wheelTimestamps = [];
    let keyOrButtonUsed = false;
    let wheelOnlyWarned = false;
    let totalWheelCount = 0;
    const WHEEL_WINDOW = 2000;
    const RAPID_WHEEL_THRESHOLD = 5;
    let rapidWheelStage = 0;

    function onWheel() {
        resetIdleTimer();
        const now = Date.now();
        wheelTimestamps.push(now);
        totalWheelCount++;
        wheelTimestamps = wheelTimestamps.filter(t => now - t <= WHEEL_WINDOW);
        const count = wheelTimestamps.length;

        if (count >= RAPID_WHEEL_THRESHOLD) {
            if (rapidWheelStage === 0 && !Toast.hasShown('rapid-wheel-grid')) {
                rapidWheelStage = 1;
                setRailDot(true);
                Toast.show({
                    id: 'rapid-wheel-grid',
                    icon: '▦',
                    message: 'Scrolling fast? <span class="toast-accent">Display</span> shows all imagery at a glance.',
                    actionLabel: 'Open',
                    actionFn: () => toggleImageGrid(),
                    duration: 12000,
                    onDismiss: () => setRailDot(false)
                });
            } else if (rapidWheelStage === 1 && !Toast.hasShown('rapid-wheel-split') && state.layoutMode === 'layered') {
                rapidWheelStage = 2;
                setRailDot(true);
                Toast.show({
                    id: 'rapid-wheel-split',
                    icon: '◫',
                    message: 'Or try <span class="toast-accent">Split View</span> — text uninterrupted, images pinned right.',
                    actionLabel: 'Try it',
                    actionFn: () => { if (state.layoutMode === 'layered') toggleLayout(); },
                    duration: 12000,
                    onDismiss: () => setRailDot(false)
                });
            }
            wheelTimestamps = [];
        }
    }

    function onSingleWheel() {
        if (keyOrButtonUsed || wheelOnlyWarned) return;
        if (totalWheelCount >= 6) {
            wheelOnlyWarned = true;
            setRailDot(true);
            Toast.show({
                id: 'scroll-only-nav',
                icon: '⌨️',
                message: isMobile()
                    ? 'Swipe up/down or tap the <span class="toast-accent">arrows</span> to move sentence by sentence.'
                    : 'Try <span class="toast-accent">Space</span>, <span class="toast-accent">↑↓</span>, or the chapter menu for smoother navigation.',
                actionLabel: 'Chapters',
                actionFn: () => toggleChapterDropdown(),
                duration: 12000,
                onDismiss: () => setRailDot(false)
            });
        }
    }

    function onKeyOrButton() {
        keyOrButtonUsed = true;
        resetIdleTimer();
    }

    // ─── Chapter crossing: logo pulse ───
    function onChapterAdvance() {
        resetIdleTimer();
        const brand = document.getElementById('brandLogo');
        if (brand) {
            brand.classList.add('chapter-pulse');
            setTimeout(() => brand.classList.remove('chapter-pulse'), 1800);
        }
    }

    // ─── Bracket nudge ───
    // Fires after 15+ sentences with zero brackets opened
    let bracketNudgeSent = false;
    function checkBracketNudge() {
        if (bracketNudgeSent || Toast.hasShown('bracket-nudge')) return;
        if (state.bracketsOpened === 0 && state.sentencesSeen.size >= 15) {
            bracketNudgeSent = true;
            setRailDot(true);
            Toast.show({
                id: 'bracket-nudge',
                icon: '[ ]',
                message: 'See the <span class="toast-accent">bracketed annotations</span>? Tap or click them to expand footnotes.',
                duration: 12000,
                onDismiss: () => setRailDot(false)
            });
        }
    }

    function onBracketOpened() {
        resetIdleTimer();
        bracketNudgeSent = true; // suppress nudge once they've used one
    }

    // ─── End-of-content CTA ───
    function onLastSentence() {
        if (Toast.hasShown('end-cta')) return;
        setRailDot(true);
        Toast.show({
            id: 'end-cta',
            icon: '✦',
            message: 'That\'s everything. Find more at <span class="toast-accent">zackgort.com</span> — or reach out.',
            actionLabel: 'Portfolio →',
            actionFn: () => window.open('https://zackgort.com', '_blank'),
            duration: 12000,
            banner: true,
            onDismiss: () => setRailDot(false)
        });
    }

    function onSentenceAdvance() {
        resetIdleTimer();
        checkBracketNudge();
    }

    function onConclusionChapter() { /* removed — replaced by end-of-content CTA */ }

    function init() {
        // Welcome banner — always shows on page load, cycles through unique hints per session visit
        const WELCOME_POOL = [
            {
                id: 'welcome-banner-0',
                message: 'Navigate sentence by sentence — or explore <span class="toast-accent">themes</span>, <span class="toast-accent">split view</span>, and the <span class="toast-accent">chapter menu</span> above.'
            },
            {
                id: 'welcome-banner-1',
                message: 'Click any <span class="toast-accent">[+]</span> annotation to expand it. Each one is a footnote hiding in plain sight.'
            },
            {
                id: 'welcome-banner-2',
                message: 'Hover over <span class="toast-accent">underlined phrases</span> to surface an image. The text and the picture are the same thought.'
            },
            {
                id: 'welcome-banner-3',
                message: 'Press <span class="toast-accent">←  →</span> to jump between chapters. Or tap the logo to open the full chapter menu.'
            },
            {
                id: 'welcome-banner-4',
                message: 'Try <span class="toast-accent">Split View</span> — text on the left, imagery pinned right. Or go full focus with <span class="toast-accent">F</span>.'
            },
            {
                id: 'welcome-banner-5',
                message: 'The <span class="toast-accent">▦ Display</span> button shows every image in the piece at once. A different way to read the same story.'
            }
        ];

        setTimeout(() => {
            // Pick the first unshown welcome hint; if all shown, cycle back to 0 with force
            const unshown = WELCOME_POOL.filter(w => !Toast.hasShown(w.id));
            const pick = unshown.length > 0
                ? unshown[0]
                : WELCOME_POOL[0];
            Toast.show({
                id: pick.id,
                icon: '✦',
                message: pick.message,
                duration: 12000,
                banner: true,
                force: unshown.length === 0, // force only when fully cycled
                onDismiss: () => {}
            });
        }, 1800);

        // Start idle detection
        idleTimer = setTimeout(onIdle, IDLE_THRESHOLD);

        // Ambient pool after 30s
        setTimeout(scheduleNextAmbient, 30000);
    }

    return { onWheel, onSingleWheel, onKeyOrButton, onSentenceAdvance, onChapterAdvance, onBracketOpened, onConclusionChapter, onLastSentence, init, getAmbientPool: () => AMBIENT_POOL, clearAmbientTimer: () => clearTimeout(ambientTimer), setRailDot };
})();

function makeDraggable(el, { useRight = true, useBottom = true } = {}) {
    if (!el || el.dataset.draggableBound) return;
    el.dataset.draggableBound = 'true';

    let isDragging = false;
    let hasMoved = false;
    let startX, startY, initialA, initialB;
    const DRAG_THRESHOLD = 4;

    function getInitialPos() {
        const style = window.getComputedStyle(el);
        initialA = useRight ? parseInt(style.right, 10) || 0 : parseInt(style.left, 10) || 0;
        initialB = useBottom ? parseInt(style.bottom, 10) || 0 : parseInt(style.top, 10) || 0;
    }

    function clampToViewport(aVal, bVal, w, h) {
        const rect = el.getBoundingClientRect();
        const elW = rect.width || 200;
        const elH = rect.height || 100;
        const margin = 8;
        if (useRight) {
            aVal = Math.max(margin, Math.min(aVal, w - elW - margin));
        } else {
            aVal = Math.max(margin, Math.min(aVal, w - elW - margin));
        }
        if (useBottom) {
            bVal = Math.max(margin, Math.min(bVal, h - elH - margin));
        } else {
            bVal = Math.max(margin, Math.min(bVal, h - elH - margin));
        }
        return [aVal, bVal];
    }

    function applyPos(aVal, bVal) {
        const [ca, cb] = clampToViewport(aVal, bVal, window.innerWidth, window.innerHeight);
        if (useRight) el.style.right = ca + 'px'; else el.style.left = ca + 'px';
        if (useBottom) el.style.bottom = cb + 'px'; else el.style.top = cb + 'px';
    }

    // Mouse
    el.addEventListener('mousedown', (e) => {
        if (window.innerWidth <= 768) return; // Disable drag on mobile
        if (e.target.closest('.k-key, .chapter-item, .chapter-dropdown-list, button, a, input, [role="button"]')) return;
        isDragging = true;
        hasMoved = false;
        el.style.cursor = 'grabbing';
        startX = e.clientX; startY = e.clientY;
        getInitialPos();
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dX = useRight ? startX - e.clientX : e.clientX - startX;
        const dY = useBottom ? startY - e.clientY : e.clientY - startY;
        if (!hasMoved && Math.abs(e.clientX - startX) < DRAG_THRESHOLD && Math.abs(e.clientY - startY) < DRAG_THRESHOLD) return;
        hasMoved = true;
        applyPos(initialA + dX, initialB + dY);
    });

    document.addEventListener('mouseup', (e) => {
        if (isDragging) {
            isDragging = false;
            hasMoved = false;
            el.style.cursor = '';
        }
    });

    // Touch
    let tStartX, tStartY;
    el.addEventListener('touchstart', (e) => {
        if (window.innerWidth <= 768) return; // Disable drag on mobile
        if (e.target.closest('.k-key, .chapter-item, .chapter-dropdown-list, button, a, input, [role="button"]')) return;
        isDragging = true;
        hasMoved = false;
        const t = e.touches[0];
        tStartX = t.clientX; tStartY = t.clientY;
        getInitialPos();
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const t = e.touches[0];
        if (!hasMoved && Math.abs(t.clientX - tStartX) < DRAG_THRESHOLD && Math.abs(t.clientY - tStartY) < DRAG_THRESHOLD) return;
        hasMoved = true;
        if (e.cancelable) e.preventDefault();
        const dX = useRight ? tStartX - t.clientX : t.clientX - tStartX;
        const dY = useBottom ? tStartY - t.clientY : t.clientY - tStartY;
        applyPos(initialA + dX, initialB + dY);
    }, { passive: false });

    document.addEventListener('touchend', () => { isDragging = false; hasMoved = false; });
}

// ===================================
// DRAGGABLE CHAPTER DROPDOWN
// ===================================
function initializeDraggableDropdown() {
    const dropdown = document.getElementById('chapterDropdown');
    const header = document.getElementById('chapterDropdownHeader');
    if (!dropdown || !header) return;

    let isDragging = false;
    let startX, startY, initLeft, initTop;

    // Canonical pixel position — null means "use CSS default"
    let pinnedLeft = null;
    let pinnedTop = null;

    function applyPinnedPosition() {
        if (pinnedLeft !== null && pinnedTop !== null) {
            dropdown.style.left = pinnedLeft + 'px';
            dropdown.style.top  = pinnedTop  + 'px';
        }
    }

    function clampDropdown(left, top) {
        const w = dropdown.offsetWidth  || 260;
        const h = dropdown.offsetHeight || 300;
        const margin = 8;
        left = Math.max(margin, Math.min(left, window.innerWidth  - w - margin));
        top  = Math.max(margin, Math.min(top,  window.innerHeight - h - margin));
        return [left, top];
    }

    function startDrag(clientX, clientY) {
        // Snapshot current rendered position into pixels on first drag
        if (pinnedLeft === null) {
            const rect = dropdown.getBoundingClientRect();
            pinnedLeft = rect.left;
            pinnedTop  = rect.top;
            dropdown.style.left = pinnedLeft + 'px';
            dropdown.style.top  = pinnedTop  + 'px';
        }
        isDragging = true;
        dropdown.classList.add('dragging');
        startX = clientX; startY = clientY;
        initLeft = pinnedLeft;
        initTop  = pinnedTop;
    }

    function moveDrag(clientX, clientY) {
        if (!isDragging) return;
        const [cl, ct] = clampDropdown(
            initLeft + (clientX - startX),
            initTop  + (clientY - startY)
        );
        pinnedLeft = cl;
        pinnedTop  = ct;
        dropdown.style.left = cl + 'px';
        dropdown.style.top  = ct + 'px';
    }

    function endDrag() {
        if (!isDragging) return;
        isDragging = false;
        dropdown.classList.remove('dragging');
    }

    // Apply pinned position every time the dropdown opens
    dropdown.addEventListener('transitionend', () => {
        if (dropdown.classList.contains('open')) applyPinnedPosition();
    });
    // Also apply immediately on open in case transition is skipped
    const observer = new MutationObserver(() => {
        if (dropdown.classList.contains('open')) applyPinnedPosition();
    });
    observer.observe(dropdown, { attributes: true, attributeFilter: ['class'] });

    // Mouse
    header.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        startDrag(e.clientX, e.clientY);
    });
    document.addEventListener('mousemove', (e) => { if (isDragging) moveDrag(e.clientX, e.clientY); });
    document.addEventListener('mouseup', endDrag);

    // Touch
    header.addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const t = e.touches[0];
        startDrag(t.clientX, t.clientY);
    }, { passive: false });
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();
        const t = e.touches[0];
        moveDrag(t.clientX, t.clientY);
    }, { passive: false });
    document.addEventListener('touchend', endDrag);
}

// ===================================
// TOUCH DETECTION
// ===================================
function detectTouch() {
    window.addEventListener('touchstart', () => { state.lastInteractionWasTouch = true; state.isTouch = true; }, { passive: true });
    window.addEventListener('mousedown', () => { state.lastInteractionWasTouch = false; state.isTouch = false; }, { passive: true });
}

// ===================================
// NARRATIVE PARSING
// ===================================
function parseNarrative(text) {
    const parts = [];
    let idCounter = 0;
    const segments = text.split(/(\[|\])/);
    let inBracket = false;
    let bracketId = null;
    
    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        if (segment === '[') {
            inBracket = true;
            bracketId = idCounter++;
            parts.push({ type: 'bracket', id: bracketId, content: '' });
        } else if (segment === ']') {
            inBracket = false;
            bracketId = null;
        } else if (segment.length > 0) {
            if (inBracket && bracketId !== null) {
                const bracket = parts.find(p => p.id === bracketId);
                if (bracket) bracket.content = segment.trim();
            } else {
                const lineSegments = segment.split(/(\/\/|\/)/);
                for (let j = 0; j < lineSegments.length; j++) {
                    const lineSegment = lineSegments[j];
                    if (lineSegment === '//') {
                        parts.push({ type: 'line-break', id: idCounter++, breakType: 'double' });
                    } else if (lineSegment === '/') {
                        parts.push({ type: 'line-break', id: idCounter++, breakType: 'single' });
                    } else if (lineSegment.trim()) {
                        const sentences = lineSegment.split(/(?<=[.!?])\s+/);
                        sentences.forEach(sentence => {
                            const trimmedSentence = sentence.trim();
                            if (!trimmedSentence) return;
                            if (trimmedSentence.startsWith('### ')) {
                                parts.push({ type: 'subchapter-break', id: idCounter++, title: trimmedSentence.substring(4).trim() });
                                return;
                            }
                            if (/^\(\d+\)\s/.test(trimmedSentence)) {
                                const match = trimmedSentence.match(/^\((\d+)\)\s(.+)/);
                                if (match) { parts.push({ type: 'numbered-bullet', id: idCounter++, number: match[1], text: match[2].trim() }); return; }
                            }
                            if (trimmedSentence.startsWith('* ')) {
                                parts.push({ type: 'bullet', id: idCounter++, text: trimmedSentence.substring(2).trim() });
                                return;
                            }
                            parts.push({ type: 'sentence', id: idCounter++, text: trimmedSentence });
                        });
                    }
                }
            }
        }
    }
    return parts;
}

// ===================================
// IMAGE HANDLING
// ===================================
function wrapImageTriggers(text) {
    let wrapped = text;
    for (const [phrase, url] of Object.entries(imageMap)) {
        const regex = phraseRegexMap.get(phrase);
        if (regex) wrapped = wrapped.replace(regex, `<span class="image-trigger" data-image="${url}">$&</span>`);
    }
    return wrapped;
}

function preloadImages() {
    const imageUrls = [...new Set(Object.values(imageMap))];
    imageUrls.forEach(url => { const img = new Image(); img.src = url; });
}

function showImage(imageUrl, triggerElement) {
    cursor.currentImageElement = triggerElement;
    state.imageActive = true;
    state.currentTriggerRect = triggerElement.getBoundingClientRect();
    document.body.classList.add('image-active');

    const isReadMode = document.body.classList.contains('focus-mode');

    if (isReadMode) {
        // Cursor thumbnail mode — image follows pointer, bg layer suppressed by CSS
        const thumb = Utils.$('#cursor-thumb');
        if (state.imageTimeout) clearTimeout(state.imageTimeout);
        state.imageTimeout = setTimeout(() => {
            thumb.onload = () => cursor.element.classList.add('thumb-active');
            thumb.onerror = () => cursor.element.classList.add('thumb-active');
            if (thumb.src !== imageUrl) thumb.src = imageUrl;
            else cursor.element.classList.add('thumb-active');
        }, CONFIG.IMAGE_HOVER_DELAY);
    } else {
        // Normal mode — full background image
        const hoverImage = Utils.$('#hoverImage');
        const hoverImageImg = Utils.$('#hoverImageImg');
        if (state.imageTimeout) clearTimeout(state.imageTimeout);
        state.imageTimeout = setTimeout(() => {
            hoverImageImg.onload = () => hoverImage.classList.add('active');
            hoverImageImg.onerror = () => hoverImage.classList.add('active');
            hoverImageImg.src = imageUrl;
        }, CONFIG.IMAGE_HOVER_DELAY);
    }
}

function hideImage() {
    const hoverImage = Utils.$('#hoverImage');
    if (state.imageTimeout) clearTimeout(state.imageTimeout);
    hoverImage.classList.remove('active');
    cursor.element.classList.remove('has-image', 'thumb-active');
    document.body.classList.remove('image-active');
    state.imageActive = false;
    cursor.currentImageElement = null;
    state.currentTriggerRect = null;
}

// ===================================
// CHAPTER MANAGEMENT
// ===================================
function getCurrentChapter() {
    if (state.allSentenceElements.length === 0) return 0;
    for (let i = chapters.length - 1; i >= 0; i--) {
        if (state.currentSentenceIndex >= state.chapterStartIndices[i]) return i;
    }
    return 0;
}

function goToChapter(chapterId) {
    const startIndex = state.chapterStartIndices[chapterId];
    if (startIndex !== undefined) {
        state.currentSentenceIndex = startIndex;
        highlightSentence(startIndex);
        closeChapterDropdown();
    }
}

function getStops() {
    const chapterStops = state.chapterStartIndices
        .filter(idx => idx >= 0)
        .map((sentenceIndex, i) => ({ sentenceIndex, type: 'chapter', id: i }));
    const subchapterStops = state.subchapterStartIndices
        .map(s => ({ sentenceIndex: s.sentenceIndex, type: 'subchapter', title: s.title }));
    return [...chapterStops, ...subchapterStops].sort((a, b) => a.sentenceIndex - b.sentenceIndex);
}

function nextChapter() {
    const cur = state.currentSentenceIndex;
    const stops = getStops();
    const next = stops.find(s => s.sentenceIndex > cur);
    if (next) { state.currentSentenceIndex = next.sentenceIndex; highlightSentence(next.sentenceIndex); }
}

function previousChapter() {
    const cur = state.currentSentenceIndex;
    const stops = getStops();
    const prev = [...stops].reverse().find(s => s.sentenceIndex < cur);
    if (prev) { state.currentSentenceIndex = prev.sentenceIndex; highlightSentence(prev.sentenceIndex); }
}

// ===================================
// SENTENCE NAVIGATION
// ===================================
function nextSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex + 1) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function previousSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex - 1 + state.allSentenceElements.length) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function highlightSentence(index) {
    const sentence = state.allSentenceElements[index];
    if (!sentence) return;
    state.allSentenceElements.forEach(s => { s.classList.remove('active'); s.classList.add('dimmed'); s.style.opacity = ''; });
    sentence.classList.add('active');
    sentence.classList.remove('dimmed');
    
    // Track stats
    trackSentence(index);
    trackChapter(getCurrentChapter());
    toastBehaviors.onSentenceAdvance();

    // End-of-content CTA on last sentence
    if (index === state.allSentenceElements.length - 1) toastBehaviors.onLastSentence();

    updateChapterProgress();
    updateChapterDropdown();
    sentence.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const imageTrigger = sentence.querySelector('.image-trigger');
    if (imageTrigger) {
        const imageUrl = imageTrigger.getAttribute('data-image');
        if (imageUrl) showImage(imageUrl, imageTrigger);
    } else {
        hideImage();
    }
}

function resetToBeginning() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = 0;
    highlightSentence(0);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===================================
// UI UPDATE FUNCTIONS
// ===================================
function updateChapterProgress() {
    const currentChapter = getCurrentChapter();
    const bars = Utils.$$('.chapter-bar');
    bars.forEach(bar => {
        const chapterId = parseInt(bar.dataset.chapterId);
        bar.classList.remove('active', 'completed');
        if (chapterId === currentChapter) bar.classList.add('active');
        else if (chapterId < currentChapter) bar.classList.add('completed');
    });
    const total = state.allSentenceElements.length;
    const current = state.currentSentenceIndex + 1;
    const progress = (current / total) * 100;
    // Landscape right-rail progress
    const landProgressFill = Utils.$('#landProgressFill');
    if (landProgressFill) landProgressFill.style.height = `${progress}%`;
}

function updateChapterDropdown() {
    const currentChapter = getCurrentChapter();
    const items = Utils.$$('.chapter-item');
    items.forEach(item => {
        const chapterId = parseInt(item.dataset.chapterId);
        if (chapterId === currentChapter) {
            item.classList.add('active');
            if (isDropdownOpen()) item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            item.classList.remove('active');
        }
    });
}

function initializeChapterProgress() {
    const container = Utils.$('#chapterProgressContainer');
    if (!container) return;
    container.innerHTML = '';
    let isRapidScrolling = false;
    let rapidScrollTimeout = null;
    chapters.forEach(chapter => {
        const bar = document.createElement('div');
        bar.className = 'chapter-bar';
        bar.dataset.chapterId = chapter.id;
        bar.dataset.chapterTitle = `${String(chapter.id + 1).padStart(2, '0')}. ${chapter.title}`;
        bar.title = chapter.title;
        bar.addEventListener('click', function(e) { e.stopPropagation(); goToChapter(parseInt(this.dataset.chapterId)); });
        bar.addEventListener('mouseenter', function() { if (isRapidScrolling) goToChapter(parseInt(this.dataset.chapterId)); });
        bar.addEventListener('mousedown', function(e) { e.preventDefault(); isRapidScrolling = true; if (rapidScrollTimeout) clearTimeout(rapidScrollTimeout); });
        container.appendChild(bar);
    });
    document.addEventListener('mouseup', function() {
        if (isRapidScrolling) {
            isRapidScrolling = false;
            if (rapidScrollTimeout) clearTimeout(rapidScrollTimeout);
            rapidScrollTimeout = setTimeout(() => isRapidScrolling = false, 100);
        }
    });
    updateChapterProgress();
}

function buildChapterDropdown() {
    const dropdownList = Utils.$('#chapterDropdownList');
    dropdownList.innerHTML = '';
    chapters.forEach(chapter => {
        const startIndex = state.chapterStartIndices[chapter.id];
        const endIndex = chapter.id < chapters.length - 1 ? state.chapterStartIndices[chapter.id + 1] : state.allSentenceElements.length;
        const li = document.createElement('li');
        li.className = 'chapter-item';
        li.dataset.chapterId = chapter.id;
        li.innerHTML = `
            <span class="chapter-item-number">${String(chapter.id + 1).padStart(2, '0')}</span>
            <span class="chapter-item-title">${chapter.title}</span>
            <span class="chapter-item-progress">${endIndex - startIndex} sentences</span>
        `;
        li.addEventListener('click', () => goToChapter(chapter.id));
        dropdownList.appendChild(li);
    });
}

// ===================================
// DROPDOWN MANAGEMENT
// ===================================
function isDropdownOpen() { return Utils.$('#chapterDropdown').classList.contains('open'); }

function toggleChapterDropdown() {
    const brand = Utils.$('#brandLogo');
    const dropdown = Utils.$('#chapterDropdown');
    brand.classList.toggle('open');
    dropdown.classList.toggle('open');
    if (dropdown.classList.contains('open')) updateChapterDropdown();
    // Clear any chapter-break opener when toggled via logo
    if (!dropdown.classList.contains('open')) clearChapterBreakOpener();
}

function clearChapterBreakOpener() {
    if (state.chapterBreakOpener) {
        state.chapterBreakOpener.classList.remove('dropdown-active');
        state.chapterBreakOpener = null;
    }
}

function closeChapterDropdown() {
    Utils.$('#brandLogo').classList.remove('open');
    Utils.$('#chapterDropdown').classList.remove('open');
    clearChapterBreakOpener();
}

function openDropdownFromChapterBreak(chapterBreakEl, chapterId) {
    const dropdown = Utils.$('#chapterDropdown');
    const brand = Utils.$('#brandLogo');

    // If already open from this exact chapter-break → close (toggle off)
    if (isDropdownOpen() && state.chapterBreakOpener === chapterBreakEl) {
        closeChapterDropdown();
        return;
    }

    // Clear previous opener highlight
    clearChapterBreakOpener();

    // Open dropdown
    brand.classList.add('open');
    dropdown.classList.add('open');
    updateChapterDropdown();

    // Mark this chapter-break as the opener
    state.chapterBreakOpener = chapterBreakEl;
    chapterBreakEl.classList.add('dropdown-active');

    // Scroll the matching chapter item into view inside the dropdown
    requestAnimationFrame(() => {
        const item = dropdown.querySelector(`.chapter-item[data-chapter-id="${chapterId}"]`);
        if (item) item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    });
}

// ===================================
// IMAGE GRID
// ===================================
function isGridOpen() { return Utils.$('#imageGridOverlay').classList.contains('open'); }

function toggleImageGrid() {
    const overlay = Utils.$('#imageGridOverlay');
    const btns = Utils.$$('.grid-toggle-btn');
    if (overlay.classList.contains('open')) {
        overlay.classList.remove('open');
        document.body.classList.remove('grid-open');
        document.body.style.overflow = '';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '▦');
    } else {
        overlay.classList.add('open');
        document.body.classList.add('grid-open');
        document.body.style.overflow = 'hidden';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '✕');
        buildImageGrid();
    }
}

function buildImageGrid() {
    const content = Utils.$('#gridContent');
    content.innerHTML = '';
    const imagesByChapter = {};
    state.gridImages.forEach(imgData => {
        if (!imagesByChapter[imgData.chapterId]) imagesByChapter[imgData.chapterId] = [];
        imagesByChapter[imgData.chapterId].push(imgData);
    });
    chapters.forEach(chapter => {
        if (imagesByChapter[chapter.id] && imagesByChapter[chapter.id].length > 0) {
            const section = document.createElement('div');
            section.className = 'grid-chapter-section';
            section.innerHTML = `<div class="grid-chapter-title">Chapter ${String(chapter.id + 1).padStart(2, '0')} · ${chapter.title}</div>`;
            const grid = document.createElement('div');
            grid.className = 'grid-images-container';
            imagesByChapter[chapter.id].forEach(imgData => {
                const item = document.createElement('div');
                item.className = 'grid-image-item';
                item.innerHTML = `<img src="${imgData.url}" loading="lazy" alt="Grid preview"><div class="grid-image-caption"><span class="caption-text">${imgData.text}</span></div>`;
                item.addEventListener('click', () => { toggleImageGrid(); state.currentSentenceIndex = imgData.index; highlightSentence(imgData.index); });
                grid.appendChild(item);
            });
            section.appendChild(grid);
            content.appendChild(section);
        }
    });
}

// ===================================
// SCROLL & TOUCH HANDLING
// ===================================
function handleScroll(event) {
    if (state.scrollCooldownActive) return;
    if (event.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) { event.preventDefault(); return; }
    if (isGridOpen()) return;
    const scrollDelta = event.deltaY;
    if (Math.abs(scrollDelta) >= CONFIG.SCROLL_THRESHOLD) {
        state.scrollCooldownActive = true;
        if (scrollDelta > 0) nextSentence(); else previousSentence();
        setTimeout(() => { state.scrollCooldownActive = false; }, CONFIG.SCROLL_COOLDOWN);
    }
    event.preventDefault();
}

function handleTouchStart(e) { state.touchStartY = e.touches[0].clientY; state.touchStartX = e.touches[0].clientX; state.touchMoved = false; }
function handleTouchMove(e) {
    state.touchMoved = true;
    if (e.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) { e.preventDefault(); return; }
    if (isGridOpen()) return;
    e.preventDefault();
}
function handleTouchEnd(e) {
    if (!state.touchMoved || state.scrollCooldownActive || isDropdownOpen() || isGridOpen()) return;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaY = state.touchStartY - touchEndY;
    if (Math.abs(deltaY) > CONFIG.FLICK_THRESHOLD) {
        state.scrollCooldownActive = true;
        if (deltaY > 0) nextSentence(); else previousSentence();
        setTimeout(() => { state.scrollCooldownActive = false; }, CONFIG.SCROLL_COOLDOWN);
    }
}

// ===================================
// PARALLAX & CURSOR
// ===================================
function updateParallax() {
    const viewportCenterX = window.innerWidth / 2;
    const viewportCenterY = window.innerHeight / 2;
    const mouseOffsetX = (state.mouseX - viewportCenterX) / viewportCenterX;
    const mouseOffsetY = (state.mouseY - viewportCenterY) / viewportCenterY;
    parallax.text.targetX = mouseOffsetX * 20 * CONFIG.TEXT_PARALLAX_STRENGTH;
    parallax.text.targetY = mouseOffsetY * 20 * CONFIG.TEXT_PARALLAX_STRENGTH;
    if (state.imageActive && state.currentTriggerRect) {
        const trigger = state.currentTriggerRect;
        const triggerCenterX = trigger.left + trigger.width / 2;
        const triggerCenterY = trigger.top + trigger.height / 2;
        const distToCenterX = (viewportCenterX - triggerCenterX) / viewportCenterX;
        const distToCenterY = (viewportCenterY - triggerCenterY) / viewportCenterY;
        parallax.image.targetX = (mouseOffsetX * 100 * CONFIG.IMAGE_PARALLAX_STRENGTH) - (distToCenterX * CONFIG.CENTER_MAGNET_STRENGTH * 100);
        parallax.image.targetY = (mouseOffsetY * 100 * CONFIG.IMAGE_PARALLAX_STRENGTH) - (distToCenterY * CONFIG.CENTER_MAGNET_STRENGTH * 100);
    } else {
        parallax.image.targetX = 0; parallax.image.targetY = 0;
    }
    parallax.text.x += (parallax.text.targetX - parallax.text.x) * CONFIG.PARALLAX_DAMPING;
    parallax.text.y += (parallax.text.targetY - parallax.text.y) * CONFIG.PARALLAX_DAMPING;
    parallax.image.x += (parallax.image.targetX - parallax.image.x) * CONFIG.PARALLAX_DAMPING;
    parallax.image.y += (parallax.image.targetY - parallax.image.y) * CONFIG.PARALLAX_DAMPING;
    const textLayer = Utils.$('#textLayer');
    const imageLayer = Utils.$('#imageLayer');
    const gridOverlay = Utils.$('#gridContent');
    if (textLayer) textLayer.style.transform = `translate3d(${parallax.text.x}px, ${parallax.text.y}px, 0)`;
    if (imageLayer) imageLayer.style.transform = `translate3d(${parallax.image.x}px, ${parallax.image.y}px, 0)`;
    if (gridOverlay) gridOverlay.style.transform = `translate3d(${parallax.image.x * 0.5}px, ${parallax.image.y * 0.5}px, 0)`;
    requestAnimationFrame(updateParallax);
}

function updateCursor() {
    if (!cursor.element) return;
    cursor.x += (cursor.targetX - cursor.x) * CONFIG.CURSOR_SMOOTHING;
    cursor.y += (cursor.targetY - cursor.y) * CONFIG.CURSOR_SMOOTHING;
    cursor.element.style.transform = `translate3d(${cursor.x}px, ${cursor.y}px, 0) translate(-50%, -50%)`;
    requestAnimationFrame(updateCursor);
}

// ===================================
// RENDER FUNCTION
// ===================================
function render() {
    const streamEl = Utils.$('#stream');
    const parsedContent = parseNarrative(narrative);
    const fragment = document.createDocumentFragment();
    state.allSentenceElements = [];
    state.gridImages = [];
    state.chapterStartIndices = new Array(chapters.length).fill(-1);
    state.subchapterStartIndices = [];
    chapters.forEach(chapter => {
        const index = narrative.indexOf(chapter.startText);
        if (index !== -1) state.chapterStartIndices[chapter.id] = index;
    });
    let sentenceCount = 0;
    let nextChapterIndex = 0;
    let currentActiveChapter = 0;

    parsedContent.forEach(part => {
        if (nextChapterIndex < chapters.length) {
            const nextChapter = chapters[nextChapterIndex];
            const textContent = part.type === 'sentence' || part.type === 'bullet' || part.type === 'numbered-bullet' ? part.text : (part.type === 'bracket' ? part.content : '');
            if (textContent && textContent.includes(nextChapter.startText)) {
                state.chapterStartIndices[nextChapter.id] = sentenceCount;
                const chapterBreak = document.createElement('div');
                chapterBreak.className = 'chapter-break';
                chapterBreak.dataset.chapterId = nextChapter.id;
                chapterBreak.innerHTML = `<span class="chapter-number">Chapter ${String(nextChapter.id + 1).padStart(2, '0')}</span><span class="chapter-title">${nextChapter.title}</span>`;
                chapterBreak.addEventListener('click', () => { showUI(); openDropdownFromChapterBreak(chapterBreak, nextChapter.id); });
                fragment.appendChild(chapterBreak);
                currentActiveChapter = nextChapter.id;
                nextChapterIndex++;
            }
        }

        if (part.type === 'sentence') {
            const span = document.createElement('span');
            span.className = 'sentence';
            span.dataset.sentenceIndex = sentenceCount;
            span.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            span.innerHTML = wrapImageTriggers(part.text) + ' ';
            span.addEventListener('mouseenter', () => { if (state.isTouch) return; const index = parseInt(span.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            span.addEventListener('mouseleave', () => { if (state.isTouch) return; state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            span.addEventListener('click', () => { state.currentSentenceIndex = parseInt(span.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(span);
            sentenceCount++;
            fragment.appendChild(span);
        } else if (part.type === 'line-break') {
            const br = document.createElement('span');
            br.className = 'line-break-spacer';
            br.innerHTML = part.breakType === 'double' ? '<br><br>' : '<br>';
            fragment.appendChild(br);
        } else if (part.type === 'subchapter-break') {
            const el = document.createElement('div');
            el.className = 'subchapter-break';
            el.innerHTML = `<span class="subchapter-title">${part.title}</span>`;
            state.subchapterStartIndices.push({ sentenceIndex: sentenceCount, title: part.title });
            fragment.appendChild(el);
        } else if (part.type === 'bullet') {
            const li = document.createElement('div');
            li.className = 'sentence bullet-item';
            li.dataset.sentenceIndex = sentenceCount;
            li.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            li.innerHTML = '<span class="bullet-marker">•</span> ' + wrapImageTriggers(part.text);
            li.addEventListener('mouseenter', () => { if (state.isTouch) return; const index = parseInt(li.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            li.addEventListener('mouseleave', () => { if (state.isTouch) return; state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            li.addEventListener('click', () => { state.currentSentenceIndex = parseInt(li.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(li);
            sentenceCount++;
            fragment.appendChild(li);
        } else if (part.type === 'numbered-bullet') {
            const li = document.createElement('div');
            li.className = 'sentence numbered-bullet-item';
            li.dataset.sentenceIndex = sentenceCount;
            li.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            li.innerHTML = `<span class="numbered-marker">${part.number}.</span> ` + wrapImageTriggers(part.text);
            li.addEventListener('mouseenter', () => { if (state.isTouch) return; const index = parseInt(li.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            li.addEventListener('mouseleave', () => { if (state.isTouch) return; state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            li.addEventListener('click', () => { state.currentSentenceIndex = parseInt(li.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(li);
            sentenceCount++;
            fragment.appendChild(li);
        } else if (part.type === 'bracket') {
            const trigger = document.createElement('button');
            trigger.className = 'bracket-trigger';
            trigger.textContent = '[+]';
            const contentId = `bracket-content-${part.id}`;
            trigger.setAttribute('aria-controls', contentId);
            const content = document.createElement('span');
            content.className = 'bracket-content';
            content.id = contentId;
            content.textContent = ' ' + part.content + ' ';
            trigger.addEventListener('click', () => {
                const isExpanded = content.classList.toggle('visible');
                trigger.textContent = isExpanded ? '[−]' : '[+]';
                trigger.classList.toggle('expanded');
                if (isExpanded) { state.expandedBrackets.add(part.id); trackBracketOpen(); }
                else state.expandedBrackets.delete(part.id);
            });
            fragment.appendChild(trigger);
            fragment.appendChild(content);
        }
    });
    
    streamEl.innerHTML = '';
    streamEl.appendChild(fragment);
    buildChapterDropdown();
    initializeChapterProgress();
    
    streamEl.addEventListener('mouseover', e => {
        const trigger = e.target.closest('.image-trigger');
        if (trigger) { const imageUrl = trigger.getAttribute('data-image'); if (imageUrl) showImage(imageUrl, trigger); }
    }, { passive: true });
    streamEl.addEventListener('mouseout', e => { if (e.target.closest('.image-trigger')) hideImage(); }, { passive: true });
}

// ===================================
// CONTEXT MENU
// ===================================
function initializeContextMenu() {
    // Suppress browser right-click context menu
    document.addEventListener('contextmenu', e => e.preventDefault());

    // Mobile: long press on stream → hide UI; any scroll gesture restores it
    const streamEl = Utils.$('#stream');
    if (streamEl) {
        let lpTimer = null;
        let lpMoved = false;
        streamEl.addEventListener('touchstart', (e) => {
            if (e.target.closest('.bracket-trigger, .image-trigger, .chapter-break, .subchapter-break, button, a')) return;
            lpMoved = false;
            lpTimer = setTimeout(() => {
                lpTimer = null;
                if (!lpMoved) {
                    document.body.classList.add('ui-hidden');
                    if (navigator.vibrate) navigator.vibrate(40);
                }
            }, CONFIG.LONG_PRESS_DURATION);
        }, { passive: true });
        streamEl.addEventListener('touchmove',   () => { lpMoved = true; if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; } }, { passive: true });
        streamEl.addEventListener('touchend',    () => { if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; } }, { passive: true });
        streamEl.addEventListener('touchcancel', () => { if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; } }, { passive: true });
    }
}

// ===================================
// LAYOUT & THEME
// ===================================
function toggleLayout() {
    state.layoutMode = state.layoutMode === 'layered' ? 'split' : 'layered';
    document.body.classList.remove('layout-layered', 'layout-split');
    document.body.classList.add(`layout-${state.layoutMode}`);
    // Re-evaluate image/dimming state for the current sentence after layout switch
    highlightSentence(state.currentSentenceIndex);
}

function showUI() {
    document.body.classList.remove('ui-hidden');
}

function toggleUIVisibility() {
    document.body.classList.toggle('ui-hidden');
}

function enterFocusMode() {
    document.body.classList.add('focus-mode');
    hideImage();
    Toast.show({ id: 'focus-mode-on', message: 'Focus Mode — interface hidden, images suspended', duration: 2500, banner: true, force: true });
}

function exitFocusMode() {
    document.body.classList.remove('focus-mode');
    // Tear down cursor thumbnail, re-trigger normal bg image if still hovering
    if (cursor.element && cursor.element.classList.contains('thumb-active')) {
        cursor.element.classList.remove('thumb-active');
        if (cursor.currentImageElement) {
            const url = cursor.currentImageElement.getAttribute('data-image');
            if (url) showImage(url, cursor.currentImageElement);
        }
    }
    Toast.show({ id: 'focus-mode-off', message: 'Focus Mode off', duration: 1800, banner: true, force: true });
}

function toggleFocusMode() {
    if (document.body.classList.contains('focus-mode')) exitFocusMode();
    else enterFocusMode();
}


function toggleTheme() {
    const body = document.body;
    // Add a transitioning flag so grain/edge-blur don't flash during the swap
    body.classList.add('theme-transitioning');
    requestAnimationFrame(() => {
        if (body.classList.contains('theme-sport')) body.classList.remove('theme-sport');
        else if (body.classList.contains('theme-newspaper')) { body.classList.remove('theme-newspaper'); body.classList.add('theme-sport'); }
        else body.classList.add('theme-newspaper');
        const icon = Utils.$('.theme-icon');
        icon.textContent = body.classList.contains('theme-sport') ? '⚡' : (body.classList.contains('theme-newspaper') ? '📖' : '☀️');
        requestAnimationFrame(() => {
            body.classList.remove('theme-transitioning');
        });
    });
}

// ===================================
// ACCESSIBILITY
// ===================================
function initializeAccessibility() {
    let accessibilityLevel = 2;
    const accessibilityLevels = [0, 0.25, 0.5, 0.75, 1];
    function applyAccessibilityLevel(level) {
        const value = accessibilityLevels[level];
        document.documentElement.style.setProperty('--curve-k', value * 3);
        document.documentElement.style.setProperty('--vig-opacity', Math.min(value * 2.4, 1.2));
        document.documentElement.style.setProperty('--edge-blur', (value * 20) + 'px');
        document.body.style.fontSize = ((1.3 - (value * 0.9)) * 100) + '%';
        Utils.$$('.level-indicator').forEach((el, i) => { el.classList.toggle('active', i === level); });
    }
    Utils.$('#accessibilityIncrease').addEventListener('click', () => { if (accessibilityLevel > 0) applyAccessibilityLevel(--accessibilityLevel); });
    Utils.$('#accessibilityDecrease').addEventListener('click', () => { if (accessibilityLevel < accessibilityLevels.length - 1) applyAccessibilityLevel(++accessibilityLevel); });
    applyAccessibilityLevel(accessibilityLevel);
}

// ===================================
// LONG PRESS
// ===================================
function setupLongPress(buttonId, normalAction, longPressAction) {
    const button = Utils.$(`#${buttonId}`);
    if (!button) return;
    let longPressTimer = null;
    let longPressActivated = false;
    button.addEventListener('touchstart', () => {
        longPressActivated = false;
        longPressTimer = setTimeout(() => { longPressActivated = true; longPressAction(); if (navigator.vibrate) navigator.vibrate(50); }, CONFIG.LONG_PRESS_DURATION);
    }, { passive: true });
    button.addEventListener('touchend', (e) => { if (longPressTimer) clearTimeout(longPressTimer); if (longPressActivated) e.preventDefault(); }, { passive: false });
    button.addEventListener('touchcancel', () => { if (longPressTimer) clearTimeout(longPressTimer); }, { passive: true });
    button.addEventListener('click', (e) => { if (longPressActivated) { e.preventDefault(); e.stopPropagation(); longPressActivated = false; } else normalAction(); });
}

// ===================================
// CLOSE HOTSPOTS
// ===================================
function initializeCloseHotspots() {
    const gridCloseHotspot = Utils.$('#gridCloseHotspot');
    const rotateCloseHotspot = Utils.$('#rotateCloseHotspot');
    const rotateWarning = Utils.$('#rotateWarning');
    gridCloseHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    gridCloseHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    gridCloseHotspot.addEventListener('click', () => { toggleImageGrid(); cursor.element.classList.remove('close-mode'); });
    rotateCloseHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    rotateCloseHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    rotateCloseHotspot.addEventListener('click', () => { rotateWarning.style.display = 'none'; cursor.element.classList.remove('close-mode'); if (state.layoutMode === 'split') toggleLayout(); });

    // ui-hidden hotspot — top-right corner restores UI (same geometry as close-hotspots)
    const uiHiddenHotspot = document.getElementById('uiHiddenHotspot');
    uiHiddenHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    uiHiddenHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    uiHiddenHotspot.addEventListener('click', () => { showUI(); cursor.element.classList.remove('close-mode'); });

    // focus-mode hotspot — top-right corner exits focus mode
    const focusModeHotspot = document.getElementById('focusModeHotspot');
    focusModeHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    focusModeHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    focusModeHotspot.addEventListener('click', () => { exitFocusMode(); cursor.element.classList.remove('close-mode'); });
    // Mobile tap-to-dismiss on the overlay itself
    rotateWarning.addEventListener('click', () => { rotateWarning.style.display = 'none'; if (state.layoutMode === 'split') toggleLayout(); });
}

// ===================================
// KEYBOARD CONTROLS
// ===================================
function initializeKeyboardControls() {
    const getBtnForKey = (key) => {
        if (key === 'ArrowUp' || key === 'k' || key === 'Backspace') return Utils.$('#prevSentenceBtn');
        if (key === 'ArrowDown' || key === 'j' || key === ' ' || key === 'Space') return Utils.$('#nextSentenceBtn');
        return null;
    };
    // Also flash HUD buttons on key press for visual feedback
    const getHudBtnForKey = (key) => {
        if (key === 'ArrowUp' || key === 'k' || key === 'Backspace' || key === 'ArrowLeft') return Utils.$('#hudPrevBtn');
        if (key === 'ArrowDown' || key === 'j' || key === ' ' || key === 'Space' || key === 'ArrowRight') return Utils.$('#hudNextBtn');
        return null;
    };
    // Get keyboard legend key element for highlighting
    const getKeyElement = (key) => {
        if (key === 'ArrowUp' || key === 'k') return Utils.$('#keyPrevSentence');
        if (key === 'ArrowDown' || key === 'j') return Utils.$('#keyNextSentence');
        if (key === 'ArrowLeft') return Utils.$('#keyPrevChapter');
        if (key === 'ArrowRight') return Utils.$('#keyNextChapter');
        return null;
    };
    document.addEventListener('keydown', e => {
        const btn = getBtnForKey(e.key);
        if (btn) btn.classList.add('active-press');
        const hudBtn = getHudBtnForKey(e.key);
        if (hudBtn) hudBtn.classList.add('active-press');
        // Highlight keyboard legend keys
        const keyElement = getKeyElement(e.key);
        if (keyElement) {
            keyElement.style.background = 'var(--accent)';
            keyElement.style.color = '#fff';
            keyElement.style.borderColor = 'var(--accent)';
        }
        
        if (e.key === 'Space' || e.code === 'Space') { e.preventDefault(); nextSentence(); }
        else if (e.key.toLowerCase() === 'g') { e.preventDefault(); toggleImageGrid(); }
        else if (e.key.toLowerCase() === 'c') { e.preventDefault(); toggleChapterDropdown(); }
        else if (e.key === 'Backspace') { e.preventDefault(); previousSentence(); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); nextChapter(); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); previousChapter(); }
        else if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); nextSentence(); }
        else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); previousSentence(); }
        else if (e.key === 'Shift') { e.preventDefault(); toggleLayout(); }
        else if (e.key === 'l') toggleLayout();
        else if (e.key.toLowerCase() === 't') toggleTheme();
        else if (e.key.toLowerCase() === 'h') { e.preventDefault(); toggleUIVisibility(); }
        else if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFocusMode(); }
        else if (e.key === 'Home') { e.preventDefault(); resetToBeginning(); }
        else if (e.key === 'Escape' || e.key.toLowerCase() === 'x') {
            if (document.body.classList.contains('focus-mode')) { exitFocusMode(); return; }
            if (document.body.classList.contains('ui-hidden')) { showUI(); return; }
            closeChapterDropdown();
            if (isGridOpen()) { toggleImageGrid(); cursor.element.classList.remove('close-mode'); }
            else if (Utils.$('#rotateWarning').style.display === 'flex') { Utils.$('#rotateWarning').style.display = 'none'; cursor.element.classList.remove('close-mode'); if (state.layoutMode === 'split') toggleLayout(); }
            else if (state.layoutMode === 'split') toggleLayout();
        }
    });
    document.addEventListener('keyup', e => { 
        const btn = getBtnForKey(e.key); if (btn) btn.classList.remove('active-press');
        const hudBtn = getHudBtnForKey(e.key); if (hudBtn) hudBtn.classList.remove('active-press');
        // Remove highlight from keyboard legend keys
        const keyElement = getKeyElement(e.key);
        if (keyElement) {
            keyElement.style.background = '';
            keyElement.style.color = '';
            keyElement.style.borderColor = '';
        }
    });
}

// ===================================
// INTERACTION HINT
// ===================================
function initializeInteractionHint() {
    let hintDismissed = false;
    const dismissHint = () => { if (!hintDismissed) { document.body.classList.add('hint-shown'); hintDismissed = true; } };
    document.addEventListener('click', dismissHint, { once: true });
    document.addEventListener('touchstart', dismissHint, { once: true });
    setTimeout(dismissHint, 3000);
}

// ===================================
// MAIN INITIALIZATION
// ===================================
document.addEventListener('DOMContentLoaded', () => {
    cursor.element = Utils.$('#cursor');
    
    document.addEventListener('mousemove', e => {
        cursor.targetX = e.clientX; cursor.targetY = e.clientY;
        state.mouseX = e.clientX; state.mouseY = e.clientY;
    }, { passive: true });
    
    document.addEventListener('mouseover', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item, .k-key')) {
            cursor.element.classList.add('hovering');
            if (e.target.matches('button, a, .grid-image-item, .k-key')) cursor.element.classList.add('pointer');
        }
    }, { passive: true });
    
    document.addEventListener('mouseout', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item, .k-key')) {
            cursor.element.classList.remove('hovering', 'pointer');
        }
    }, { passive: true });
    
    detectTouch();
    initializeAccessibility();
    initializeContextMenu();
    initializeCloseHotspots();
    initializeKeyboardControls();
    initializeInteractionHint();
    
    // Initialize draggable widgets using factory
    const legend = document.getElementById('keyboardLegend');
    if (legend) {
        makeDraggable(legend, { useRight: true, useBottom: true });
        Utils.$('#keyPrevSentence').addEventListener('click', (e) => { e.stopPropagation(); previousSentence(); });
        Utils.$('#keyNextSentence').addEventListener('click', (e) => { e.stopPropagation(); nextSentence(); });
        Utils.$('#keyPrevChapter').addEventListener('click', (e) => { e.stopPropagation(); previousChapter(); });
        Utils.$('#keyNextChapter').addEventListener('click', (e) => { e.stopPropagation(); nextChapter(); });
    }
    
    // Stats Widget Logic
    const statsWidget = document.getElementById('statsWidget');
    if (statsWidget) {
        let lastDesktopLeft = '80px';
        let lastDesktopBottom = '20px';
        let isMobileMode = window.innerWidth <= 768;

        const applyDesktopStyles = () => {
             statsWidget.style.left = lastDesktopLeft;
             statsWidget.style.bottom = lastDesktopBottom;
             statsWidget.style.right = 'auto'; // clear mobile styles
             statsWidget.style.transform = ''; // clear mobile centering
             statsWidget.style.width = ''; // clear mobile width
             statsWidget.style.margin = ''; // clear mobile margin
             statsWidget.style.cursor = 'grab';
        };

        const applyMobileStyles = () => {
             // Save desktop position before switching to mobile layout
             if (statsWidget.style.left && statsWidget.style.left !== '0px') lastDesktopLeft = statsWidget.style.left;
             if (statsWidget.style.bottom) lastDesktopBottom = statsWidget.style.bottom;
             
             // Apply mobile layout override
             statsWidget.style.left = '0'; 
             statsWidget.style.right = '0';
             statsWidget.style.bottom = 'calc(16px + env(safe-area-inset-bottom))';
             statsWidget.style.marginLeft = 'auto';
             statsWidget.style.marginRight = 'auto';
             statsWidget.style.width = 'fit-content';
             statsWidget.style.transform = 'none';
             statsWidget.style.cursor = 'default';
        };

        // Initialize Draggable ONCE
        makeDraggable(statsWidget, { useRight: false, useBottom: true });

        // Set Initial State
        if (isMobileMode) applyMobileStyles();
        else applyDesktopStyles();

        // Resize Listener
        window.addEventListener('resize', Utils.debounce(() => {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobileMode) {
                isMobileMode = newIsMobile;
                if (isMobileMode) applyMobileStyles();
                else applyDesktopStyles();
            }
        }, 100));
    }
    
    // Event listeners
    Utils.$('#brandLogo').addEventListener('click', toggleChapterDropdown);
    Utils.$('#gridToggleBtn')?.addEventListener('click', toggleImageGrid);
    Utils.$('#layoutToggle')?.addEventListener('click', toggleLayout);
    Utils.$('#themeToggle')?.addEventListener('click', toggleTheme);

    // Mode cluster buttons
    const modeCluster = document.getElementById('modeCluster');
    if (modeCluster) {
        makeDraggable(modeCluster, { useRight: true, useBottom: false });

        Utils.$('#modeKeySpace').addEventListener('click', (e) => { e.stopPropagation(); nextSentence(); });
        Utils.$('#modeKeyG').addEventListener('click', (e) => { e.stopPropagation(); toggleImageGrid(); });
        Utils.$('#modeKeyC').addEventListener('click', (e) => { e.stopPropagation(); toggleChapterDropdown(); });
        Utils.$('#modeKeyF').addEventListener('click', (e) => { e.stopPropagation(); toggleFocusMode(); });
        Utils.$('#modeKeyH').addEventListener('click', (e) => { e.stopPropagation(); toggleUIVisibility(); });
        Utils.$('#modeKeyT').addEventListener('click', (e) => { e.stopPropagation(); toggleTheme(); });
        Utils.$('#modeKeyL').addEventListener('click', (e) => { e.stopPropagation(); toggleLayout(); });

        // Sync active states when modes change
        function syncModeCluster() {
            Utils.$('#modeKeyF').classList.toggle('mode-active', document.body.classList.contains('focus-mode'));
            Utils.$('#modeKeyH').classList.toggle('mode-active', document.body.classList.contains('ui-hidden'));
            Utils.$('#modeKeyG').classList.toggle('mode-active', isGridOpen());
            Utils.$('#modeKeyC').classList.toggle('mode-active', isDropdownOpen());
            const isLayered = document.body.classList.contains('layout-layered');
            Utils.$('#modeKeyL').classList.toggle('mode-active', !isLayered);
        }
        // Observe body class changes to keep buttons in sync
        new MutationObserver(syncModeCluster).observe(document.body, { attributes: true, attributeFilter: ['class'] });
        syncModeCluster();
    }
    Utils.$('#prevSentenceBtn').addEventListener('click', previousSentence);
    Utils.$('#nextSentenceBtn').addEventListener('click', nextSentence);
    
    document.addEventListener('click', e => {
        if (!Utils.$('#brandLogo').contains(e.target) && !Utils.$('#chapterDropdown').contains(e.target) && !e.target.closest('.chapter-break')) closeChapterDropdown();
    });
    
    window.addEventListener('wheel', handleScroll, { passive: false });
    window.addEventListener('touchstart', handleTouchStart, { passive: true });
    window.addEventListener('touchmove', handleTouchMove, { passive: false });
    window.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // Toast: wire wheel events (both rapid and single-wheel detection)
    window.addEventListener('wheel', () => {
        toastBehaviors.onWheel();
        toastBehaviors.onSingleWheel();
    }, { passive: true });

    // Toast: mark that user has used keyboard or nav buttons (not scroll-only)
    document.addEventListener('keydown', (e) => {
        const navKeys = ['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight','j','k'];
        if (navKeys.includes(e.key) || navKeys.includes(e.code)) toastBehaviors.onKeyOrButton();
        else toastBehaviors.onKeyOrButton(); // any keypress resets idle
    }, { passive: true });
    Utils.$('#prevSentenceBtn')?.addEventListener('click', () => toastBehaviors.onKeyOrButton(), { passive: true });
    Utils.$('#nextSentenceBtn')?.addEventListener('click', () => toastBehaviors.onKeyOrButton(), { passive: true });
    Utils.$('#hudPrevBtn')?.addEventListener('click', () => toastBehaviors.onKeyOrButton(), { passive: true });
    Utils.$('#hudNextBtn')?.addEventListener('click', () => toastBehaviors.onKeyOrButton(), { passive: true });
    
    // Wire HUD nav buttons with long-press (prev/next sentence, long-press for chapter)
    setupLongPress('hudPrevBtn', previousSentence, previousChapter);
    setupLongPress('hudNextBtn', nextSentence, nextChapter);
    setupLongPress('landPrevBtn', previousSentence, previousChapter);
    setupLongPress('landNextBtn', nextSentence, nextChapter);
    
    preloadImages();
    render();
    updateStats(); // Initialize stats display
    updateCursor();
    updateParallax();
    
    document.body.classList.add(`layout-${state.layoutMode}`);
    
    if (state.allSentenceElements.length > 0) {
        state.currentSentenceIndex = 0;
        highlightSentence(0);
    }
    
    // Initialize draggable dropdown after render
    initializeDraggableDropdown();
    
    window.toggleLayout = toggleLayout;
    window.toggleTheme = toggleTheme;
    
    // Initialize toast system
    toastBehaviors.init();

    // Rail bell button — cycles through ambient pool, force-shows even if already seen
    const toastRailBtn = document.getElementById('toastRailBtn');
    if (toastRailBtn) {
        let forceIndex = 0;
        toastRailBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const pool = toastBehaviors.getAmbientPool();
            // First try unshown toasts; if all shown, cycle with force
            const unshown = pool.filter(t => !Toast.hasShown(t.id) && (!t.condition || t.condition()));
            const pick = unshown.length > 0
                ? unshown[Math.floor(Math.random() * unshown.length)]
                : pool[forceIndex++ % pool.length];
            toastBehaviors.clearAmbientTimer();
            toastBehaviors.setRailDot(true);
            Toast.show({
                id: pick.id,
                icon: pick.icon,
                message: typeof pick.message === 'function' ? pick.message() : pick.message,
                actionLabel: pick.actionLabel || null,
                actionFn: pick.actionFn || null,
                duration: 12000,
                force: true,
                onDismiss: () => toastBehaviors.setRailDot(false)
            });
        });
    }
});
    </script>
</body>
</html>
