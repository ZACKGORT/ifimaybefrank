<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="An anti-scroll manifesto. A portfolio that makes you read one sentence at a time. Sentence-based navigation meets parallax storytelling.">
    <meta name="author" content="Zack Gort">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ifimaybefrank.com/">
    <meta property="og:title" content="IFIMAYBEFRANK - Zack Gort">
    <meta property="og:description" content="What if reading on the web felt intentional? A sentence-based narrative interface.">
    <meta property="og:image" content="https://ifimaybefrank.com/og-image.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="IFIMAYBEFRANK - Zack Gort">
    <meta property="twitter:description" content="An anti-scroll manifesto. One sentence at a time.">
    <meta property="twitter:image" content="https://ifimaybefrank.com/og-image.jpg">
    
    <title>IFIMAYBEFRANK - Zack Gort</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ===================================
   CSS VARIABLES & THEMES
   ===================================
   Design principle: every component reads exclusively from these
   variables. Adding a new theme means only adding a new variable
   block here ‚Äî zero component-level overrides required.
   =================================== */
:root {
    /* ‚îÄ‚îÄ Palette ‚îÄ‚îÄ */
    --bg-color: #000000;
    --ink: #ffffff;
    --ink-2: #b8b8b8;
    --ink-3: #808080;
    --accent: #daa520;

    /* ‚îÄ‚îÄ Semantic surfaces ‚îÄ‚îÄ */
    --surface: rgba(0, 0, 0, 0.60);           /* widget/panel bg */
    --surface-raised: rgba(10, 10, 10, 0.95); /* dropdowns, overlays */
    --border: rgba(255, 255, 255, 0.10);
    --border-strong: rgba(255, 255, 255, 0.15);
    --hover-tint: rgba(218, 165, 32, 0.08);   /* accent-tinted hover */
    --hover-tint-strong: rgba(218, 165, 32, 0.15);

    /* ‚îÄ‚îÄ Sentence states ‚îÄ‚îÄ */
    --sentence-color: rgba(255, 255, 255, 0.85);
    --sentence-active-color: #ffffff;
    --sentence-active-bg: rgba(0, 0, 0, 0.95);
    --sentence-active-shadow: 0 0 20px rgba(218, 165, 32, 0.30);
    --sentence-hover-color: var(--ink);
    --sentence-hover-bg: rgba(218, 165, 32, 0.08);
    --sentence-dimmed-opacity: 0.44;
    --sentence-dimmed-color: rgba(255, 255, 255, 0.50);

    /* ‚îÄ‚îÄ Typography ‚îÄ‚îÄ */
    --ui-font: 'Space Mono', monospace;
    --body-font: 'Crimson Text', Georgia, serif;
    --stream-line-height: 1.8;
    --stream-letter-spacing: -0.01em;
    --ui-font-weight: 400;
    --chapter-break-weight: 700;
    --chapter-break-letter-spacing: 0.15em;
    --chapter-break-font-size: 11px;
    --chapter-break-border-width: 1px;

    /* ‚îÄ‚îÄ Chapter progress bars ‚îÄ‚îÄ */
    --chapter-bar-bg: rgba(255, 255, 255, 0.15);
    --chapter-bar-hover-bg: rgba(255, 255, 255, 0.30);
    --chapter-bar-completed-bg: rgba(218, 165, 32, 0.40);
    --chapter-bar-completed-hover-bg: rgba(218, 165, 32, 0.60);
    --chapter-tooltip-bg: rgba(0, 0, 0, 0.90);

    /* ‚îÄ‚îÄ Image grid ‚îÄ‚îÄ */
    --grid-overlay-bg: rgba(5, 5, 5, 0.96);
    --grid-item-bg: #111111;
    --grid-item-border: rgba(255, 255, 255, 0.10);
    --grid-title-border: rgba(255, 255, 255, 0.10);

    /* ‚îÄ‚îÄ Effects ‚îÄ‚îÄ */
    --vig-opacity: 0.85;
    --vig-inner: 30%;
    --vig-mid: 75%;
    --vig-outer: 100%;
    --edge-blur: 6px;
    --edge-mask-i: 65%;
    --edge-mask-o: 80%;
    --grain-opacity: 0.08;
    --effects-display: block; /* set to 'none' to kill grain/vig/blur */

    /* ‚îÄ‚îÄ Brackets ‚îÄ‚îÄ */
    --bracket-color: #8b6f47;
    --bracket-hover: #daa520;
    --bracket-bg: rgba(218, 165, 32, 0.04);

    /* ‚îÄ‚îÄ Cursor ‚îÄ‚îÄ */
    --cursor-bg: transparent;
    --cursor-border: rgba(255, 255, 255, 0.50);
    --cursor-blend: difference;
    --cursor-opacity: 1;

    /* ‚îÄ‚îÄ Selection ‚îÄ‚îÄ */
    --selection-bg: rgba(218, 165, 32, 0.25);
    --selection-color: #ffffff;

    /* ‚îÄ‚îÄ z-index stack ‚îÄ‚îÄ */
    --z-content: 0;
    --z-grain: 149;
    --z-blur: 150;
    --z-vig: 151;
    --z-ui: 220;
    --z-overlay: 300;
    --z-dropdown: 350;
    --z-rail: 210;
    --z-mobile-bottom-rail: 220;
    --z-rotate-warning: 9999;

    /* ‚îÄ‚îÄ Parallax ‚îÄ‚îÄ */
    --text-parallax-strength: 0.03;
    --image-parallax-strength: 0.15;
    --center-magnet-strength: 0.25;
    --curve-k: 1;
}

/* ‚îÄ‚îÄ NEWSPAPER THEME ‚îÄ‚îÄ */
body.theme-newspaper {
    --bg-color: #faf8f3;
    --ink: #000000;
    --ink-2: #1a1a1a;
    --ink-3: #2a2a2a;
    --accent: #8b4513;

    --surface: rgba(245, 241, 232, 0.95);
    --surface-raised: rgba(245, 241, 232, 0.98);
    --border: rgba(0, 0, 0, 0.12);
    --border-strong: rgba(0, 0, 0, 0.15);
    --hover-tint: rgba(139, 69, 19, 0.06);
    --hover-tint-strong: rgba(139, 69, 19, 0.10);

    --sentence-color: #000000;
    --sentence-active-color: #ffffff;
    --sentence-active-bg: #000000;
    --sentence-active-shadow: none;
    --sentence-hover-color: #000000;
    --sentence-hover-bg: rgba(255, 255, 255, 0.95);
    --sentence-dimmed-opacity: 0.44;
    --sentence-dimmed-color: #333333;

    --chapter-bar-bg: rgba(0, 0, 0, 0.12);
    --chapter-bar-hover-bg: rgba(0, 0, 0, 0.25);
    --chapter-bar-completed-bg: rgba(139, 69, 19, 0.30);
    --chapter-bar-completed-hover-bg: rgba(139, 69, 19, 0.50);
    --chapter-tooltip-bg: rgba(245, 241, 232, 0.95);

    --grid-overlay-bg: rgba(245, 241, 232, 0.98);
    --grid-item-bg: #e8e4d8;
    --grid-item-border: rgba(0, 0, 0, 0.15);
    --grid-title-border: rgba(0, 0, 0, 0.12);

    --vig-opacity: 0.12;
    --grain-opacity: 0.08;

    --bracket-color: #5d4e37;
    --bracket-hover: #8b4513;
    --bracket-bg: rgba(139, 69, 19, 0.03);

    --cursor-bg: transparent;
    --cursor-border: rgba(0, 0, 0, 0.40);
    --cursor-blend: difference;
    --cursor-opacity: 1;

    --selection-bg: rgba(139, 69, 19, 0.25);
    --selection-color: #ffffff;
}

/* ‚îÄ‚îÄ SPORT THEME ‚îÄ‚îÄ */
body.theme-sport {
    --bg-color: #0a0a0a;
    --ink: #f5f5f5;
    --ink-2: #e0e0e0;
    --ink-3: #888888;
    --accent: #fa3c00;

    --surface: rgba(10, 10, 10, 0.92);
    --surface-raised: rgba(10, 10, 10, 0.97);
    --border: rgba(250, 60, 0, 0.18);
    --border-strong: rgba(250, 60, 0, 0.25);
    --hover-tint: rgba(250, 60, 0, 0.10);
    --hover-tint-strong: rgba(250, 60, 0, 0.15);

    --sentence-color: var(--ink-2);
    --sentence-active-color: #ffffff;
    --sentence-active-bg: var(--accent);
    --sentence-active-shadow: none;
    --sentence-hover-color: #ffffff;
    --sentence-hover-bg: rgba(250, 60, 0, 0.12);
    --sentence-dimmed-opacity: 0.44;
    --sentence-dimmed-color: var(--ink-3);

    --ui-font: 'Inter', sans-serif;
    --ui-font-weight: 600;
    --body-font: 'Inter', sans-serif;
    --stream-line-height: 1.75;
    --stream-letter-spacing: -0.025em;
    --chapter-break-weight: 900;
    --chapter-break-letter-spacing: 0.14em;
    --chapter-break-font-size: 10px;
    --chapter-break-border-width: 2px;

    --chapter-bar-bg: rgba(255, 255, 255, 0.10);
    --chapter-bar-hover-bg: rgba(255, 255, 255, 0.25);
    --chapter-bar-completed-bg: rgba(250, 60, 0, 0.35);
    --chapter-bar-completed-hover-bg: rgba(250, 60, 0, 0.55);
    --chapter-tooltip-bg: rgba(10, 10, 10, 0.97);

    --grid-overlay-bg: rgba(10, 10, 10, 0.98);
    --grid-item-bg: #111111;
    --grid-item-border: rgba(255, 255, 255, 0.08);
    --grid-title-border: rgba(250, 60, 0, 0.20);

    --vig-opacity: 0.60;
    --edge-blur: 4px;
    --grain-opacity: 0.04;

    --bracket-color: #cc3000;
    --bracket-hover: #fa3c00;
    --bracket-bg: rgba(250, 60, 0, 0.06);

    --cursor-bg: var(--accent);
    --cursor-border: var(--accent);
    --cursor-blend: normal;
    --cursor-opacity: 0.85;

    --selection-bg: rgba(250, 60, 0, 0.35);
    --selection-color: #ffffff;
}

/* ===================================
   LAYOUT MODES
   =================================== */
html, body { overscroll-behavior: none; touch-action: pan-y; }
body.layout-layered .text-layer { width: 95%; margin: 0 auto; max-width: 1400px; }
body.layout-layered .stream { color: var(--sentence-color); }
body.layout-layered .hover-image { position: absolute; left: 50%; top: 50%; }
body.layout-split .text-layer { width: 50%; margin: 0; padding-left: 6vw; }
body.layout-split .stream { color: var(--sentence-color); font-size: clamp(16px, 2vw, 28px); }
body.layout-split .hover-image { position: fixed; left: 72%; top: 50%; width: 45vw; height: 34vw; }
body.layout-split .hover-image.active { opacity: 1 !important; filter: brightness(1) contrast(1); }
body .hover-image { display: block; }

/* HIDE MOBILE RIGHT RAIL IN SPLIT VIEW */
body.layout-split .mobile-right-rail { display: none !important; }

/* ===================================
   KEYBOARD LEGEND WIDGET
   =================================== */
.keyboard-legend {
    position: fixed;
    bottom: 20px;
    right: 80px;
    z-index: var(--z-ui);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border-strong);
    border-radius: 8px;
    padding: 8px 12px 8px 6px;
    cursor: grab;
    user-select: none;
    transition: background 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    touch-action: none;
    transform: translateZ(0);
    will-change: transform;
    isolation: isolate;
}
.keyboard-legend:active { cursor: grabbing; }
.drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 14px;
    line-height: 1;
    padding-right: 6px;
    border-right: 1px solid var(--border);
    opacity: 0.7;
    display: flex;
    align-items: center;
    height: 100%;
    letter-spacing: -2px;
}
.k-group { display: flex; flex-direction: column; gap: 4px; align-items: center; }
.k-row { display: flex; gap: 4px; }
.k-key {
    width: 24px; height: 24px;
    background: var(--border);
    border: 1px solid var(--border-strong);
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--ui-font);
    font-weight: var(--ui-font-weight);
    font-size: 12px; color: var(--ink);
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
}
.k-key:hover { background: var(--accent); color: var(--bg-color); border-color: var(--accent); }
.k-key:active { transform: scale(0.9); }
.k-tooltip {
    position: absolute; bottom: 100%; left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background: var(--surface-raised); color: var(--ink);
    padding: 4px 8px; border-radius: 4px; font-size: 10px;
    white-space: nowrap; opacity: 0; pointer-events: none;
    transition: opacity 0.2s ease;
    border: 1px solid var(--border-strong);
    font-family: var(--ui-font);
}
.k-key:hover .k-tooltip { opacity: 1; }

@media (max-width: 768px) { .keyboard-legend { display: none; } }

/* ===================================
   STATS WIDGET (+ MOBILE HUD)
   =================================== */
@keyframes hudEntrance {
    0%   { opacity: 0; transform: translateY(20px) scale(0.95); }
    60%  { opacity: 1; transform: translateY(-4px) scale(1.01); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes statPulse {
    0%   { transform: translateZ(0) scale(1); }
    40%  { transform: translateZ(0) scale(1.35); opacity: 1; }
    100% { transform: translateZ(0) scale(1); }
}

.stats-widget {
    position: fixed;
    bottom: 20px;
    left: 80px;
    z-index: var(--z-ui);
    display: flex;
    align-items: center;
    gap: 0;
    background: var(--surface);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border-strong);
    border-radius: 8px;
    padding: 6px 4px 6px 6px;
    cursor: grab;
    user-select: none;
    transition: background 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    touch-action: none;
    transform: translateZ(0);
    will-change: transform;
    isolation: isolate;
}
.stats-widget:active { cursor: grabbing; }

.stats-drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 14px;
    line-height: 1;
    padding-right: 8px;
    border-right: 1px solid var(--border);
    opacity: 0.7;
    display: flex;
    align-items: center;
    align-self: stretch;
    letter-spacing: -2px;
    margin-right: 2px;
}
.stats-group { display: flex; align-items: center; }
.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 4px 10px;
    gap: 3px;
    border-right: 1px solid var(--border);
    min-width: 56px;
}
.stat-item:last-child { border-right: none; }
.stat-value {
    font-family: var(--ui-font);
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    transition: color 0.2s ease;
    display: inline-block;
    will-change: transform;
    transform: translateZ(0);
}
.stat-label {
    font-family: var(--ui-font);
    font-size: 8px;
    color: var(--ink-3);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    line-height: 1;
    white-space: nowrap;
}
.stat-value.pulse { animation: statPulse 0.35s ease-out; }

/* ‚îÄ‚îÄ HUD nav buttons (hidden on desktop, shown on mobile) ‚îÄ‚îÄ */
.hud-nav-btn {
    display: none;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    background: var(--border);
    border: 1px solid var(--border-strong);
    color: var(--accent);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    flex-shrink: 0;
}
.hud-nav-btn svg { width: 20px; height: 20px; fill: currentColor; pointer-events: none; }
.hud-nav-btn:active { transform: scale(0.88); background: var(--hover-tint-strong); }
.hud-nav-btn.active-press { background: var(--accent) !important; color: var(--bg-color) !important; }

/* ‚îÄ‚îÄ Mobile overrides ‚îÄ‚îÄ */
@media (max-width: 768px) {
    .stats-widget {
        /* Float above iOS safe area ‚Äî centered without transform (Safari-safe) */
        bottom: calc(16px + env(safe-area-inset-bottom));
        left: 0 !important;
        right: 0 !important;
        transform: none !important;
        margin-left: auto !important;
        margin-right: auto !important;
        width: fit-content !important;
        cursor: default;
        max-width: calc(100vw - 32px);
        width: auto;
        touch-action: none;
        padding: 6px 6px 6px 10px;
        border-radius: 14px;
        gap: 0;
        box-shadow: 0 8px 32px rgba(0,0,0,0.45);
        /* Entrance animation */
        animation: hudEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
    }
    .stats-widget:active { cursor: default; }
    .stats-drag-handle { display: none; }
    .hud-nav-btn { display: flex; }
    .stat-item { padding: 4px 8px; min-width: 48px; }
    .stat-value { font-size: 14px; }
    .stat-label { font-size: 7px; }

    /* Dividers between nav btn and stats group */
    .hud-divider {
        width: 1px;
        align-self: stretch;
        background: var(--border-strong);
        margin: 4px 4px;
        flex-shrink: 0;
    }
}



/* ===================================
   NAVIGATION RAILS
   =================================== */
.scroll-progress { 
    position: fixed; right: 30px; top: 50%; transform: translateY(-50%); 
    display: flex; flex-direction: column; align-items: center; gap: 15px; 
    z-index: var(--z-ui); pointer-events: auto; 
}
.chapter-progress-container { 
    display: flex; flex-direction: column; gap: 6px; padding: 10px 0; align-items: center;
}
.chapter-bar { 
    width: 20px; height: 4px; background: var(--chapter-bar-bg); border-radius: 2px; 
    cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
}
.chapter-bar:hover { width: 32px; height: 6px; background: var(--chapter-bar-hover-bg); }
.chapter-bar.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.chapter-bar.active:hover { background: var(--accent); box-shadow: 0 0 12px var(--accent); }
.chapter-bar.completed { background: var(--chapter-bar-completed-bg); }
.chapter-bar.completed:hover { background: var(--chapter-bar-completed-hover-bg); }
.chapter-bar::after {
    content: attr(data-chapter-title);
    position: absolute; right: calc(100% + 12px); top: 50%; transform: translateY(-50%);
    font-family: var(--ui-font); font-size: 11px; color: var(--ink-2);
    white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    background: var(--chapter-tooltip-bg); padding: 4px 8px; border-radius: 4px;
    border: 1px solid var(--border-strong);
}
.chapter-bar:hover::after { opacity: 1; }
.nav-button { 
    width: 36px; height: 36px; border-radius: 50%; 
    background: var(--surface); border: 1px solid var(--border); 
    color: var(--ink-3); cursor: pointer; transition: all 0.2s ease; 
    display: flex; align-items: center; justify-content: center; font-size: 14px; 
    pointer-events: auto; user-select: none; -webkit-user-select: none; 
    -webkit-tap-highlight-color: transparent; touch-action: manipulation; 
}
.nav-button:hover { background: var(--hover-tint); border-color: var(--accent); color: var(--accent); transform: scale(1.1); }
.nav-button:active { transform: scale(0.95); }
.nav-button svg { width: 16px; height: 16px; fill: currentColor; }
.nav-button.active-press, .mobile-nav-button.active-press {
    background: var(--accent) !important; color: var(--bg) !important;
    transform: scale(0.95); transition: transform 0.1s ease;
}
.left-rail { 
    position: fixed; left: 0; top: 50%; transform: translateY(-50%); 
    z-index: var(--z-rail); padding: 20px 12px; pointer-events: auto; display: flex; align-items: center; 
}
.lens-control-container { 
    background: var(--surface); border: 1px solid var(--border); 
    border-left: none; border-radius: 0 8px 8px 0; padding: 16px 8px; 
    display: flex; flex-direction: column; align-items: center; gap: 12px; backdrop-filter: blur(5px); 
    transition: background 0.35s ease, border-color 0.35s ease;
}
.lens-label { 
    font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); 
    text-transform: uppercase; letter-spacing: 0.05em; writing-mode: vertical-rl; 
    text-orientation: mixed; transform: rotate(180deg); 
}
.accessibility-controls { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.accessibility-btn { 
    width: 28px; height: 28px; border-radius: 4px; background: var(--border); 
    border: 1px solid var(--border-strong); color: var(--ink-2); cursor: pointer; 
    display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; 
}
.accessibility-btn:hover { background: var(--hover-tint-strong); border-color: var(--accent); color: var(--accent); }
.accessibility-btn:active { transform: scale(0.9); }
.accessibility-btn svg { width: 16px; height: 16px; }
.accessibility-level { display: flex; flex-direction: column; gap: 4px; padding: 8px 0; }
.level-indicator { width: 16px; height: 3px; background: var(--border-strong); border-radius: 2px; transition: background 0.2s ease; }
.level-indicator.active { background: var(--accent); }

/* ===================================
   MOBILE RAILS
   =================================== */
.mobile-right-rail { 
    display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 60px; 
    background: var(--surface); backdrop-filter: blur(10px); z-index: var(--z-ui); 
    flex-direction: column; align-items: center; justify-content: center; gap: 20px; 
    border-left: 1px solid var(--border); padding: 20px 0; 
    transition: background 0.35s ease, border-color 0.35s ease;
}
.mobile-nav-container { 
    display: flex; justify-content: space-between; align-items: center; gap: 12px; 
    max-width: 500px; margin: 0 auto; width: 100%; 
}
.mobile-right-rail .mobile-nav-container { flex-direction: column; height: 100%; justify-content: space-between; }
.mobile-right-rail .rail-top-group, .mobile-right-rail .rail-bottom-group { display: flex; flex-direction: column; gap: 10px; align-items: center; }
.mobile-nav-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.mobile-nav-button { 
    width: 48px; height: 48px; border-radius: 12px; background: var(--border); 
    border: 1px solid var(--border-strong); color: var(--accent); cursor: pointer; 
    transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; 
    pointer-events: auto; -webkit-tap-highlight-color: transparent; user-select: none; 
    -webkit-user-select: none; touch-action: manipulation; 
}
.mobile-nav-button:active { transform: scale(0.92); background: var(--hover-tint-strong); }
.mobile-nav-button svg { width: 22px; height: 22px; fill: currentColor; }
.mobile-nav-label { font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.05em; }
.mobile-progress-container { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 0 12px; }
.mobile-right-rail .mobile-progress-container { height: 100%; width: 100%; flex: 1; justify-content: center; padding: 20px 0; }
.mobile-right-rail .mobile-progress-bar { width: 4px; height: 100%; max-height: 200px; }
.mobile-right-rail .mobile-progress-fill { width: 100%; height: 0%; bottom: 0; top: auto; transition: height 0.3s ease; }
.mobile-progress-text { font-family: var(--ui-font); font-size: 10px; color: var(--ink-2); letter-spacing: 0.05em; }
.mobile-progress-bar { width: 100%; height: 4px; background: var(--border-strong); border-radius: 2px; position: relative; overflow: hidden; }
.mobile-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s ease; width: 0%; }

body.image-active .sentence:not(.active) { opacity: 0.1; color: var(--ink-3); }
body.image-active .sentence.active { opacity: 1; color: var(--sentence-active-color); }
body.image-active .sentence.dimmed { opacity: 0.05; color: var(--ink-3); }

/* ===================================
   BASE STYLES
   =================================== */
*, *::before, *::after { box-sizing: border-box; }
html { color-scheme: dark; -webkit-text-size-adjust: 100%; }
body, html { height: 100%; margin: 0; overflow-x: hidden; }
body { 
    background: var(--bg-color); color: var(--ink); font: 18px/1.8 var(--body-font); 
    overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; 
    -webkit-tap-highlight-color: transparent; cursor: none; user-select: none; 
    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
    transition: background-color 0.35s ease, color 0.35s ease;
}
body::-webkit-scrollbar { display: none; }
body { -ms-overflow-style: none; scrollbar-width: none; }
::selection { background: var(--selection-bg); color: var(--selection-color); }

/* ===================================
   FLOW MODE
   =================================== */
body.flow-mode .sentence { opacity: 0.15; transition: opacity 0.6s ease; }
body.flow-mode .sentence.active { opacity: 1; }
body.flow-mode .sentence.revealed { opacity: 0.6; }
body.flow-mode .text-layer { overflow-y: auto; height: 100vh; -webkit-overflow-scrolling: touch; }
body.layout-split.image-active .sentence:not(.active) { opacity: 0.8 !important; color: var(--ink) !important; }

/* ===================================
   INTERACTION HINTS
   =================================== */
.interaction-hint { 
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 9998; 
    font-family: var(--ui-font); font-size: 11px; letter-spacing: 0.1em; 
    text-transform: uppercase; color: var(--accent); opacity: 0; 
    animation: hintPulse 3s ease-in-out; pointer-events: none; 
}
@keyframes hintPulse { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 0.6; } 50% { opacity: 0.3; } }
body.hint-shown .interaction-hint { display: none; }

/* ===================================
   CONTEXT MENU
   =================================== */
.context-menu { 
    position: fixed; z-index: calc(var(--z-overlay) + 100); background: var(--surface-raised); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
    border: 1px solid var(--border-strong); border-radius: 8px; padding: 8px 0; 
    min-width: 200px; opacity: 0; transform: scale(0.95); pointer-events: none; 
    transition: opacity 0.15s ease, transform 0.15s ease; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); 
}
.context-menu.open { opacity: 1; transform: scale(1); pointer-events: auto; }
.context-menu-item { 
    display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--ink-2); 
    font-family: var(--ui-font); font-size: 13px; cursor: pointer; transition: all 0.15s ease; user-select: none; 
}
.context-menu-item:hover { background: var(--hover-tint); color: var(--accent); }
.context-menu-item:active { background: var(--hover-tint-strong); }
.context-menu-item.context-menu-info { cursor: default; opacity: 0.5; font-size: 11px; padding: 8px 16px; }
.context-menu-item.context-menu-info:hover { background: transparent; color: var(--ink-2); }
.ctx-icon { font-size: 16px; width: 20px; text-align: center; }
.context-menu-divider { height: 1px; background: var(--border); margin: 6px 8px; }

/* ===================================
   VISUAL EFFECTS
   =================================== */
.edge-blur { 
    position: fixed; inset: 0; pointer-events: none; z-index: var(--z-blur); 
    backdrop-filter: blur(var(--edge-blur)); -webkit-backdrop-filter: blur(var(--edge-blur)); 
    mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o)); 
    -webkit-mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o));
    transform: translateZ(0);
    will-change: transform;
}
.vignette { 
    position: fixed; inset: 0; pointer-events: none; z-index: var(--z-vig); 
    background: radial-gradient(120% 90% at 50% 50%, #fff0 var(--vig-inner), rgb(0 0 0 / 0.55) var(--vig-mid), rgb(0 0 0 / 0.9) var(--vig-outer)); 
    opacity: calc(var(--vig-opacity) * var(--curve-k));
    transform: translateZ(0);
    will-change: opacity;
    transition: opacity 0.35s ease;
}
body::after { 
    content: ""; position: fixed; inset: 0; pointer-events: none; z-index: var(--z-grain); opacity: 0.08; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.45'/%3E%3C/svg%3E"); 
    background-size: 120px 120px;
    transform: translateZ(0);
    will-change: transform;
    transition: opacity 0.35s ease;
}
body.theme-transitioning::after {
    opacity: 0;
}

/* ===================================
   PARALLAX & LAYERS
   =================================== */
.curved { 
    position: fixed; inset: 0; transform-style: preserve-3d; 
    transform: perspective(1000px) translateZ(calc(-200px * var(--curve-k))) scale(calc(1 + var(--curve-k) * 0.06)); 
    will-change: transform; z-index: var(--z-content);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.parallax-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
.text-layer { 
    position: relative; z-index: 10; padding: 15vh 8vw 25vh; max-width: 99%; margin: 0 auto; 
    transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.image-layer { 
    position: fixed; inset: 0; z-index: 5; pointer-events: none; 
    transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.stream { font-size: clamp(18px, 2.5vw, 32px); line-height: var(--stream-line-height); letter-spacing: var(--stream-letter-spacing); max-width: 100%; color: var(--sentence-color); font-family: var(--body-font); transition: color 0.35s ease, font-family 0.1s; }
.sentence { display: inline; transition: opacity 0.3s ease, color 0.3s ease, background 0.3s ease; cursor: none; position: relative; z-index: 2; letter-spacing: -0.01em; }
.sentence.active { color: var(--sentence-active-color); opacity: 1; text-shadow: var(--sentence-active-shadow); background: var(--sentence-active-bg); padding: 2px 6px; border-radius: 2px; }
.sentence.dimmed { opacity: var(--sentence-dimmed-opacity); color: var(--sentence-dimmed-color); }
.bullet-item, .numbered-bullet-item { display: block; margin: 0.5em 0; padding-left: 1.5em; position: relative; }
.bullet-marker, .numbered-marker { position: absolute; left: 0; color: var(--accent); font-weight: 600; }
.bullet-marker { font-size: 1.2em; line-height: 1.5; }
.numbered-marker { font-family: var(--ui-font); font-size: 0.85em; }
.line-break-spacer { display: inline; pointer-events: none; background: none !important; padding: 0 !important; }

/* ===================================
   CHAPTER BREAKS
   =================================== */
.chapter-break { 
    display: block; margin: 3em 0 2em; padding: 1.5em 0; 
    border-top: var(--chapter-break-border-width) solid color-mix(in srgb, var(--accent) 30%, transparent); 
    border-bottom: var(--chapter-break-border-width) solid color-mix(in srgb, var(--accent) 30%, transparent); 
    text-align: center; font-family: var(--ui-font); font-size: var(--chapter-break-font-size); 
    letter-spacing: var(--chapter-break-letter-spacing); 
    text-transform: uppercase; color: var(--accent); opacity: 0.7; cursor: pointer; transition: all 0.3s ease; pointer-events: auto; 
}
.chapter-break:hover { opacity: 1; background: var(--hover-tint); padding: 1.5em 1em; }
.chapter-break .chapter-number { display: block; font-size: 0.7em; margin-bottom: 0.5em; color: var(--ink-3); }
.chapter-break .chapter-title { display: block; font-size: 1.2em; font-weight: var(--chapter-break-weight); letter-spacing: var(--chapter-break-letter-spacing); }

/* ===================================
   BRACKETS
   =================================== */
.bracket-trigger { 
    all: unset; cursor: none; font-family: var(--ui-font); font-size: 0.65em; 
    color: var(--bracket-color); letter-spacing: 0.02em; transition: all 0.2s ease; 
    border-bottom: 1px dotted var(--bracket-color); padding-bottom: 1px; 
    display: inline; vertical-align: baseline; line-height: inherit; margin: 0 0.1em; 
}
.bracket-trigger:hover { color: var(--bracket-hover); opacity: 1; border-bottom-color: var(--bracket-hover); }
.bracket-trigger.expanded { opacity: 0.5; }
.bracket-content { 
    display: none; font-size: 0.8em; color: var(--ink-2); font-style: italic; 
    line-height: inherit; padding-left: 0.2em; margin-left: 0.2em; 
    border-left: 1px solid color-mix(in srgb, var(--accent) 50%, transparent); padding-right: 0.2em; 
    background: var(--bracket-bg); animation: bracketFadeIn 0.3s ease-out; 
}
.bracket-content.visible { display: inline; }
@keyframes bracketFadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

/* ===================================
   IMAGE TRIGGERS & HOVER
   =================================== */
.image-trigger { position: relative; text-decoration: none; border-bottom: 1px dotted var(--accent); cursor: help; transition: all 0.2s ease; opacity: 0.9; }
.image-trigger:hover { color: var(--accent); border-bottom-style: solid; opacity: 1; }
.hover-image { 
    position: absolute; z-index: 1; pointer-events: none; opacity: 0; 
    transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.1s linear; 
    width: 1400px; height: 1050px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); 
    transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9) contrast(1.05); 
    will-change: transform, opacity; left: 50%; top: 50%; 
}
.hover-image.active { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
.hover-image img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

/* ===================================
   HEADER
   =================================== */
.header { 
    position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-ui); 
    padding: clamp(16px, 2vh, 28px) clamp(20px, 4vw, 50px); 
    display: flex; justify-content: space-between; align-items: center; pointer-events: none; 
}
.brand-container { position: relative; pointer-events: auto; }
.header-right { display: flex; align-items: center; gap: 12px; }
.brand { 
    font-family: var(--ui-font); font-size: 11px; letter-spacing: 0.08em; 
    text-transform: uppercase; color: var(--ink-3); padding: 6px 10px; border-radius: 3px; 
    transition: all 0.35s ease; text-decoration: none; background: var(--surface); 
    border: 1px solid var(--border); cursor: pointer; 
    display: flex; align-items: center; gap: 8px; 
}
.brand:hover { background: var(--hover-tint); color: var(--ink); border-color: var(--accent); }
.brand:active { transform: scale(0.95); }
.brand-dropdown-icon { font-size: 10px; transition: transform 0.2s ease; }
.brand.open .brand-dropdown-icon { transform: rotate(180deg); }

/* ===================================
   CHAPTER DROPDOWN ‚Äî DRAGGABLE
   =================================== */
.chapter-dropdown { 
    position: fixed;
    top: 60px;
    left: clamp(20px, 4vw, 50px);
    min-width: 280px; 
    background: var(--surface-raised); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
    border: 1px solid var(--border-strong); border-radius: 8px; padding: 8px 0; 
    opacity: 0; visibility: hidden; transform: translateY(-10px); 
    transition: opacity 0.3s cubic-bezier(0.25, 1, 0.5, 1), visibility 0.3s, transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); 
    z-index: var(--z-dropdown); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); 
    max-height: 70vh; display: flex; flex-direction: column; 
    touch-action: none;
}
.chapter-dropdown.open { opacity: 1; visibility: visible; transform: translateY(0); }
.chapter-dropdown.dragging { 
    transition: none !important; 
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.7);
    border-color: var(--accent);
}
.chapter-dropdown-header { 
    padding: 12px 16px; border-bottom: 1px solid var(--border); 
    margin-bottom: 8px; flex-shrink: 0;
    display: flex; align-items: center; gap: 8px;
    cursor: grab;
    user-select: none;
}
.chapter-dropdown-header:active { cursor: grabbing; }
.dropdown-drag-handle {
    font-family: sans-serif;
    color: var(--ink-3);
    font-size: 13px;
    letter-spacing: -2px;
    opacity: 0.45;
    line-height: 1;
    flex-shrink: 0;
}
.chapter-dropdown-header h3 { 
    font-family: var(--ui-font); font-size: 10px; letter-spacing: 0.1em; 
    text-transform: uppercase; color: var(--ink-3); margin: 0; font-weight: 400; flex: 1;
}
.chapter-dropdown-list { 
    overflow-y: auto; padding: 0; margin: 0; list-style: none; 
    overscroll-behavior: contain; -webkit-overflow-scrolling: touch; 
}
.chapter-dropdown-list::-webkit-scrollbar { width: 4px; }
.chapter-dropdown-list::-webkit-scrollbar-track { background: var(--border); }
.chapter-dropdown-list::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }
.chapter-item { padding: 10px 16px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; }
.chapter-item:hover { background: var(--hover-tint); }
.chapter-item.active { background: var(--hover-tint-strong); border-left: 2px solid var(--accent); }
.chapter-item-number { font-family: var(--ui-font); font-size: 10px; color: var(--ink-3); min-width: 40px; }
.chapter-item-title { font-family: var(--body-font); font-size: 14px; color: var(--ink-2); font-style: italic; }
.chapter-item.active .chapter-item-title { color: var(--accent); font-style: normal; }
.chapter-item-progress { margin-left: auto; font-family: var(--ui-font); font-size: 9px; color: var(--ink-3); background: var(--border); padding: 2px 6px; border-radius: 2px; }

/* ===================================
   HEADER BUTTONS
   =================================== */
.preview-toggle, .layout-toggle, .theme-toggle { pointer-events: auto; }
.preview-button, .layout-button, .grid-toggle-btn, .theme-button { 
    background: var(--surface); border: 1px solid var(--border); 
    padding: 8px 12px; border-radius: 3px; cursor: pointer; transition: all 0.35s ease; 
    display: flex; align-items: center; justify-content: center; 
    font-family: var(--ui-font); font-size: 10px; color: var(--ink-3); gap: 6px; pointer-events: auto; 
}
.preview-button:hover, .layout-button:hover, .grid-toggle-btn:hover, .theme-button:hover { background: var(--hover-tint); border-color: var(--accent); color: var(--ink); }
.preview-button:active, .layout-button:active, .grid-toggle-btn:active, .theme-button:active { transform: scale(0.95); }
.preview-button.active { border-color: var(--accent); color: var(--accent); }
.layout-icon { width: 24px; height: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
.layout-icon.layered::before, .layout-icon.layered::after { content: ''; display: block; width: 100%; height: 6px; background: var(--ink-3); border-radius: 1px; transition: all 0.3s ease; }
.layout-icon.layered::after { opacity: 0.5; margin-top: -4px; }
.layout-icon.split::before, .layout-icon.split::after { content: ''; display: block; border-radius: 1px; transition: all 0.3s ease; }
.layout-icon.split::before { width: 10px; height: 100%; background: var(--ink-3); }
.layout-icon.split::after { width: 10px; height: 100%; background: var(--ink-3); margin-left: 4px; opacity: 0.5; }
.grid-toggle-btn { text-transform: uppercase; letter-spacing: 0.05em; }

/* New SVG layout icon styles */
.layout-icon-landscape, .layout-icon-portrait { stroke: var(--ink-3); transition: all 0.3s ease; }
body.layout-layered .layout-icon-landscape { display: block; }
body.layout-layered .layout-icon-portrait { display: none; }
body.layout-split .layout-icon-landscape { display: none; }
body.layout-split .layout-icon-portrait { display: block; }

/* ===================================
   IMAGE GRID OVERLAY
   =================================== */
.image-grid-overlay { 
    position: fixed; inset: 0; z-index: var(--z-overlay); background: var(--grid-overlay-bg); 
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
    display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; overflow-y: auto; 
}
.image-grid-overlay.open { display: flex; opacity: 1; }
.close-hotspot { 
    position: fixed; top: 0; right: 0; width: 25vw; height: 25vh; min-width: 150px; min-height: 150px; 
    z-index: calc(var(--z-overlay) + 10); cursor: none; display: none; pointer-events: auto; 
}
.grid-close-hotspot { z-index: calc(var(--z-overlay) + 10); display: none; }
body.grid-open .grid-close-hotspot { display: block; }
.split-close-hotspot { z-index: calc(var(--z-ui) + 10); display: none !important; }
.rotate-close-hotspot { z-index: calc(var(--z-rotate-warning) + 1); display: none; }
@media (orientation: portrait) { body.layout-split .rotate-close-hotspot { display: block; } }
#cursor.close-mode { width: 60px; height: 60px; border-color: var(--accent); background: var(--hover-tint-strong); }
#cursor.close-mode::before { content: '‚úï'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: var(--accent); line-height: 1; }
.grid-content { padding: 100px 5vw; max-width: 1600px; margin: 0 auto; width: 100%; will-change: transform; transition: transform 0.1s linear; }
.grid-chapter-section { margin-bottom: 60px; }
.grid-chapter-title { font-family: var(--ui-font); font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--grid-title-border); opacity: 0.7; }
.grid-images-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
.grid-image-item { position: relative; aspect-ratio: 4/3; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid var(--grid-item-border); transition: all 0.3s ease; background: var(--grid-item-bg); }
.grid-image-item:hover { transform: scale(1.02); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 2; }
.grid-image-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: opacity 0.3s ease; }
.grid-image-item:hover img { opacity: 0.4; filter: blur(2px); }
.grid-image-caption { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
.grid-image-item:hover .grid-image-caption { opacity: 1; }
.caption-text { color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); background: rgba(0, 0, 0, 0.85); padding: 8px 12px; border-radius: 4px; font-family: var(--body-font); font-size: 16px; line-height: 1.4; }

/* ===================================
   CUSTOM CURSOR
   =================================== */
#cursor { 
    position: fixed; top: 0; left: 0; width: 20px; height: 20px; 
    background: var(--cursor-bg);
    border: 1px solid var(--cursor-border); border-radius: 50%; pointer-events: none; z-index: 9999; 
    transform: translate3d(-50px, -50px, 0) translate(-50%, -50%); 
    transition: width 0.25s, height 0.25s, background-color 0.25s, border-color 0.25s, opacity 0.25s; 
    mix-blend-mode: var(--cursor-blend); will-change: transform;
    opacity: var(--cursor-opacity);
}
#cursor.hovering { width: 36px; height: 36px; background-color: var(--hover-tint); border-color: var(--accent); }
#cursor.pointer { width: 14px; height: 14px; background-color: var(--ink); }
#cursor.has-image { opacity: 0; }

/* ===================================
   SCROLL HINT
   =================================== */
.scroll-hint { 
    position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
    display: flex; flex-direction: column; align-items: center; gap: 8px; 
    z-index: var(--z-ui); opacity: 0; animation: fadeInOut 8s ease-in-out; pointer-events: none; 
}
.scroll-hint-icon { width: 24px; height: 24px; border-right: 2px solid var(--border-strong); border-bottom: 2px solid var(--border-strong); transform: rotate(45deg); animation: bounce 1.5s ease-in-out infinite; }
.scroll-hint-text { font-family: var(--ui-font); font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink-3); }

/* ===================================
   ROTATE WARNING
   =================================== */
.rotate-warning { 
    position: fixed; inset: 0; z-index: var(--z-rotate-warning); 
    background: var(--bg-color); /* Theme aware background */
    backdrop-filter: blur(10px); 
    display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; 
    color: var(--accent); 
}
.rotate-warning svg { width: 48px; height: 48px; fill: var(--accent); margin-bottom: 20px; animation: rotateIcon 2s infinite ease-in-out; }
.rotate-warning p { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--ink); max-width: 300px; line-height: 1.6; }
@keyframes rotateIcon { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 75% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
@keyframes bounce { 0%, 100% { transform: rotate(45deg) translateY(0); } 50% { transform: rotate(45deg) translateY(8px); } }
@keyframes fadeInOut { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
@media (orientation: portrait) { body.layout-split .rotate-warning { display: flex; } }
.rotate-warning.visible { display: flex; }

/* ===================================
   RESPONSIVE BREAKPOINTS
   =================================== */
@media (max-height: 500px) and (orientation: landscape) {
    .scroll-progress { display: none; }
    .left-rail { display: flex; padding: 10px 4px; }
    .mobile-right-rail { display: flex; }
    .mobile-nav-button { width: 36px; height: 36px; }
    .mobile-progress-text { font-size: 9px; }
    .scroll-hint { display: none; }
    .text-layer { padding: 10vh 8vw 20vh; max-width: 90%; }
    .header { padding: 10px 20px; }
    .stream { font-size: clamp(16px, 3vw, 24px); }
    .preview-toggle { display: none; }
}

@media (max-width: 768px) {
    .scroll-progress { display: none; }
    .left-rail { display: flex; }
    .scroll-hint { display: none; }
    .text-layer { padding: 12vh 6vw 20vh 50px; max-width: 95%; }
    .stream { font-size: clamp(16px, 4vw, 28px); }
    .hover-image { width: 800px; height: 600px; }
    .chapter-dropdown { min-width: 240px; }
    .grid-images-container { grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .grid-content { padding: 100px 10vw; }
    body.layout-split .text-layer { width: 100%; padding-left: 50px; padding-right: 20px; }
    body.layout-split .hover-image { position: absolute; left: 50%; top: 50%; width: 800px; height: 600px; transform: translate(-50%, -50%) scale(0.95); }
    @media (pointer: coarse) { #cursor { display: none !important; } }
    * { -webkit-tap-highlight-color: var(--hover-tint); }
    .nav-button { -webkit-tap-highlight-color: var(--hover-tint-strong); }
}

@media (prefers-reduced-motion: reduce) {
    .edge-blur { backdrop-filter: none; -webkit-backdrop-filter: none; }
    * { animation: none !important; transition: none !important; }
}

    </style>
</head>
<body>
    <div class="context-menu" id="contextMenu" aria-hidden="true">
        <div class="context-menu-item" id="ctxNextChapter"><span class="ctx-icon">‚Üí</span><span>Next Chapter</span></div>
        <div class="context-menu-item" id="ctxPrevChapter"><span class="ctx-icon">‚Üê</span><span>Previous Chapter</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxResetProgress"><span class="ctx-icon">‚Üë</span><span>Back to Top</span></div>
        <div class="context-menu-item" id="ctxToggleTheme"><span class="ctx-icon" id="ctxThemeIcon">‚ö°</span><span id="ctxThemeText">Sport Theme</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxCopyLink"><span class="ctx-icon">üîó</span><span>Copy Link</span></div>
        <div class="context-menu-item" id="ctxShare"><span class="ctx-icon">‚Üó</span><span>Share</span></div>
    </div>

    <div class="interaction-hint" id="interactionHint">Move by touch</div>
    <div class="close-hotspot grid-close-hotspot" id="gridCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot split-close-hotspot" id="splitCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot rotate-close-hotspot" id="rotateCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    
    <div class="rotate-warning">
        <svg viewBox="0 0 24 24"><path d="M4 7.59l5-5c.78-.78 2.05-.78 2.83 0L20 10.76c.78.78.78 2.05 0 2.83L11.83 21.76c-.78.78-2.05.78-2.83 0l-5-5c-.78-.78-.78-2.05 0-2.83L4 7.59zM9 19.17l8.17-8.17L9 2.83 2.83 9 9 19.17zM17 12h-2v2h2v-2zm0-4h-2v2h2V8zm0-4h-2v2h2V4z"/></svg>
        <p>Please rotate your device to landscape for Split View.</p>
    </div>

    <div id="keyboardLegend" class="keyboard-legend" title="Drag to move">
        <div class="drag-handle">‚ãÆ‚ãÆ</div>
        <div class="k-group">
            <div class="k-row">
                <div class="k-key" id="keyPrevSentence" aria-label="Previous Sentence">‚Üë<span class="k-tooltip">Prev Sentence</span></div>
            </div>
            <div class="k-row">
                <div class="k-key" id="keyPrevChapter" aria-label="Previous Chapter">‚Üê<span class="k-tooltip">Prev Chapter</span></div>
                <div class="k-key" id="keyNextSentence" aria-label="Next Sentence">‚Üì<span class="k-tooltip">Next Sentence</span></div>
                <div class="k-key" id="keyNextChapter" aria-label="Next Chapter">‚Üí<span class="k-tooltip">Next Chapter</span></div>
            </div>
        </div>
    </div>

    <div id="statsWidget" class="stats-widget" title="Drag to move" aria-label="Reading stats and navigation">
        <div class="stats-drag-handle">‚ãÆ‚ãÆ</div>
        <button class="hud-nav-btn" id="hudPrevBtn" aria-label="Previous Sentence" title="Previous (long-press for prev chapter)">
            <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
        </button>
        <div class="hud-divider"></div>
        <div class="stats-group">
            <div class="stat-item">
                <span class="stat-value" id="statSentencesSeen">1</span>
                <span class="stat-label">Sentences</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statBracketsOpened">0</span>
                <span class="stat-label">Brackets</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="statChaptersRead">1</span>
                <span class="stat-label">Chapters</span>
            </div>
        </div>
        <div class="hud-divider"></div>
        <button class="hud-nav-btn" id="hudNextBtn" aria-label="Next Sentence" title="Next (long-press for next chapter)">
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
    </div>

    <div class="image-grid-overlay" id="imageGridOverlay" aria-hidden="true">
        <div class="grid-content" id="gridContent"></div>
    </div>

    <div id="cursor" aria-hidden="true"></div>
    
    <div class="left-rail" aria-hidden="true">
        <div class="lens-control-container">
            <span class="lens-label">ZOOM</span>
            <div class="accessibility-controls">
                <button class="accessibility-btn" id="accessibilityIncrease" aria-label="Increase accessibility" title="Increase">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
                <div class="accessibility-level" id="accessibilityLevel">
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator active"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                </div>
                <button class="accessibility-btn" id="accessibilityDecrease" aria-label="Decrease accessibility" title="Decrease">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
        </div>
    </div>
    

    <div class="mobile-right-rail" aria-label="Mobile navigation landscape">
        <div class="mobile-nav-container">
            <div class="rail-top-group"></div>
            <div class="mobile-progress-container">
                <div class="mobile-progress-bar"><div class="mobile-progress-fill" id="landProgressFill"></div></div>
            </div>
            <div class="rail-bottom-group">
                <div class="mobile-nav-group">
                    <button class="mobile-nav-button" id="landPrevBtn" title="Previous Sentence" aria-label="Previous Sentence">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
                    </button>
                </div>
                <div class="mobile-nav-group">
                    <button class="mobile-nav-button" id="landNextBtn" title="Next Sentence" aria-label="Next Sentence">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <header class="header">
        <div class="brand-container">
            <div class="brand" id="brandLogo" aria-label="Open chapter menu">
                <span>If I May Be Frank</span>
                <span class="brand-dropdown-icon">‚ñº</span>
            </div>
            <div class="chapter-dropdown" id="chapterDropdown" aria-hidden="true">
                <div class="chapter-dropdown-header" id="chapterDropdownHeader">
                    <span class="dropdown-drag-handle">‚ãÆ‚ãÆ</span>
                    <h3>Chapters</h3>
                </div>
                <ul class="chapter-dropdown-list" id="chapterDropdownList"></ul>
            </div>
        </div>

        <div class="header-right">
            <button class="grid-toggle-btn" id="gridToggleBtn" aria-label="Toggle Image Grid">
                <span>Display</span>
                <span style="font-size: 1.2em;">‚ñ¶</span>
            </button>
            <div class="layout-toggle">
                <button id="layoutToggle" class="layout-button" aria-label="Toggle layout mode" title="Switch layout">
                    <svg class="layout-icon-landscape" style="width: 20px; height: 20px; display: block;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="10" rx="2"/>
                    </svg>
                    <svg class="layout-icon-portrait" style="width: 20px; height: 20px; display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="7" y="2" width="10" height="20" rx="2"/>
                    </svg>
                </button>
            </div>
            <div class="theme-toggle">
                <button id="themeToggle" class="theme-button" aria-label="Toggle theme" title="Switch theme: Default ‚Üí Newspaper ‚Üí Sport (T)">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>
    </header>

    <div class="edge-blur" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>

    <div class="scroll-progress" aria-label="Navigation controls">
        <button class="nav-button prev-sentence" id="prevSentenceBtn" title="Previous Sentence (‚Üë/k)" aria-label="Previous Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
        </button>
        <div class="chapter-progress-container" id="chapterProgressContainer"></div>
        <button class="nav-button next-sentence" id="nextSentenceBtn" title="Next Sentence (‚Üì/j)" aria-label="Next Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </button>
    </div>

    <div class="scroll-hint" aria-hidden="true">
        <div class="scroll-hint-icon"></div>
        <span class="scroll-hint-text">Scroll ¬∑ Left / Right / Up / Down ¬∑ SPC / ENT / SHFT / ESC</span>
    </div>

    <main class="curved">
        <div class="parallax-container">
            <div id="imageLayer" class="image-layer">
                <div id="hoverImage" class="hover-image" role="tooltip" aria-hidden="true">
                    <img src="" alt="" id="hoverImageImg" loading="lazy">
                </div>
            </div>
            <div id="textLayer" class="text-layer">
                <article class="stream" id="stream" role="article"></article>
            </div>
        </div>
    </main>

    <script>
// ===================================
// IFIMAYBEFRANK - Complete JavaScript
// ===================================

const CONFIG = {
    TAIL_LENGTH: 12,
    CURSOR_SMOOTHING: 0.35,
    IMAGE_HOVER_DELAY: 120,
    TEXT_PARALLAX_STRENGTH: 0.03,
    IMAGE_PARALLAX_STRENGTH: 0.15,
    CENTER_MAGNET_STRENGTH: 0.25,
    PARALLAX_DAMPING: 0.1,
    SCROLL_THRESHOLD: 30,
    SCROLL_COOLDOWN: 100,
    LONG_PRESS_DURATION: 500,
    FLICK_THRESHOLD: 50
};

const state = {
    hoveredSentence: null,
    expandedBrackets: new Set(),
    imageActive: false,
    layoutMode: 'layered',
    currentSentenceIndex: -1,
    currentChapterIndex: 0,
    allSentenceElements: [],
    chapterStartIndices: [],
    gridImages: [],
    mouseX: 0,
    mouseY: 0,
    currentTriggerRect: null,
    imageTimeout: null,
    isTouch: false,
    lastInteractionWasTouch: false,
    scrollCooldownActive: false,
    touchStartY: 0,
    touchStartX: 0,
    touchMoved: false,
    // Stats tracking
    sentencesSeen: new Set(),
    bracketsOpened: 0,
    chaptersRead: new Set()
};

const cursor = { x: 0, y: 0, targetX: 0, targetY: 0, element: null, currentImageElement: null };
const parallax = { text: { x: 0, y: 0, targetX: 0, targetY: 0 }, image: { x: 0, y: 0, targetX: 0, targetY: 0 } };

// ===================================
// DATA
// ===================================
const chapters = [
    { id: 0, title: "Hello World", startText: "The year is 2026" },
    { id: 1, title: "Words from the Maker", startText: "I loathe to be so bold" },
    { id: 2, title: "The Early Days", startText: "I built my first computer" },
    { id: 3, title: "Suburbia Startup", startText: "Turn5 was a paradigm shift" },
    { id: 4, title: "#AgencyLife", startText: "One Sixty Over Ninety" },
    { id: 5, title: "The New York Experience", startText: "FlightPath was my gateway to New York" },
    { id: 6, title: "Latest & Greatest", startText: "As an aside, I've been building" },
    { id: 7, title: "About", startText: "Currently I'm seeking my next" },
    { id: 8, title: "Conclusion", startText: "Beyond the work, there's music" },
    { id: 9, title: "Extras", startText: "You can find my music on SoundCloud" }
];

const imageMap = {
    'scrolling': 'https://i.ibb.co/Y7wVfbfK/DSC08212.webp',
    'void': 'https://i.ibb.co/MZbMqsT/6039d4bbb15be328fc33b54d-IMG-6478.jpg',
    'paused': 'https://i.ibb.co/BjZQ8KG/2322060064540385797-5144774570.jpg',
    'intentional': 'https://i.ibb.co/m5sNTvYX/603a967916b10d5bef5a6dd8-ZAX02712-1.webp',
    'beat': 'https://i.ibb.co/twyPzFZf/ZAX01304.webp',
    'moment to movement': 'https://i.ibb.co/gMDT38J5/IMG-20200527-221611-475.jpg',
    'But first': 'https://i.ibb.co/9HWqZ86P/603a95edd9a3b56723de7edc-DSC00910.webp',
    'I loathe to be so bold': 'https://i.ibb.co/0yjJ4j8L/603a967a5dc3e982f571b744-ZAX00968.webp',
    'my own way': 'https://i.ibb.co/bHsf63Q/2269150474215204867-5144774570.jpg',
    'conviction counters': 'https://i.ibb.co/bjCjbfbT/603a93efdfd184c21ef2d238-IMG-3352.webp',
    'curriculum vitae': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'career focus realized': 'https://i.ibb.co/ym4M89VT/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'journey materialized': 'https://i.ibb.co/r2nhMymB/1-Dkcm-PIZj6ro-ZML4w2k-Nk-Mw.webp',
    'eyes and mind': 'https://i.ibb.co/DPJM0yfz/1-k-Y6yg0chz7-Puu-Wgrl-YNMA.webp',
    'to discover': 'https://i.ibb.co/FbxpWLhV/DSC08352-1.jpg',
    'building something': 'https://i.ibb.co/Vc4F4vfT/ZAX09994.jpg',
    'proof of concept': 'https://i.ibb.co/9HzBPc7Y/603a93eea83b1aab7a98c35b-DSC08228.webp',
    'Zack': 'https://i.ibb.co/NZ0y6Hn/2272303929273225747-5144774570.jpg',
    'left-handed': 'https://i.ibb.co/Kp0wZtgT/ZAX01496.jpg',
    'self-taught': 'https://i.ibb.co/bg5W6vyn/DSC09125.jpg',
    'a craftsman': 'https://i.ibb.co/DDFpj6Dm/ZAX03810.jpg',
    'dreamer': 'https://i.ibb.co/hqCtdrS/ZAX02263.jpg',
    'built my first computer': 'https://i.ibb.co/fdxZdwwC/1-d-MG5-YE20sk-Uzo3z7-GIyf1w.webp',
    'installed pirated copies': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'what I saw around me': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'studied typography': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'reading books': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'examining magazines': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'faux website concepts': 'https://i.ibb.co/DHHzHw8G/1-pu-HZ09-ELFPd-Aa-MK0-HAxq-Q.webp',
    'Craigslist post': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'cover letter': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'original cover letter': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'sixteen-fifty an hour': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'Turn5': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'package design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'catalogue design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'Product Photographer': 'https://i.ibb.co/C38FHDx9/1-FYt-Vic-HKj-LDPLW2rcn-J1u-A.webp',
    'product photographer': 'https://i.ibb.co/C38FHDx9/1-FYt-Vic-HKj-LDPLW2rcn-J1u-A.webp',
    'color match': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'OEM quality': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'photographed thousands': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'web designer': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'banner and display ads': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'email marketing': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'wireframe': 'https://i.ibb.co/NdwrPWfV/1-Na-ZV6rc-Ew-RT55p-R12-BY0jg.webp',
    'user testing': 'https://i.ibb.co/fG0dXSr0/1-m7-Hfhu-QO4-Ugr1-Vte-Zf6it-A.webp',
    'forty million per year': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'formal education': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'Leadnomics': 'https://i.ibb.co/zhPSN9QQ/1-6-Cxwk-Ywhhn5-Z-FHINfdp-WA.webp',
    'payday loan': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'payday loans': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    '95.8%': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'ninety-five-point-eight percent': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'free lunches': 'https://i.ibb.co/27BznHGJ/1-BNs-Ch8k1bclj-KMu1-KN-g.gif',
    'interactive haiku': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'interactive Haiku': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'One Sixty Over Ninety': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    '160/90': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    '160over90': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    'Interaction Designer': 'https://i.ibb.co/fd8Ycjyv/1-pch6xh-Ep-Fo-Xxli-AGb-Nnr7-Q.webp',
    'Interactive Department': 'https://i.ibb.co/fd8Ycjyv/1-pch6xh-Ep-Fo-Xxli-AGb-Nnr7-Q.webp',
    'lots of nights': 'https://i.ibb.co/SwzHM3CZ/1-o-P6kr-DDq-Pp-Sg-F4-Ag-Fr-WClw.webp',
    'weekends too': 'https://i.ibb.co/SwzHM3CZ/1-o-P6kr-DDq-Pp-Sg-F4-Ag-Fr-WClw.webp',
    'grayscale wireframes': 'https://i.ibb.co/nNLv6NKB/1-CQ-4u-Tk-D6-MUBWABKw-JIZg-A.webp',
    'Kent State': 'https://i.ibb.co/nNLv6NKB/1-CQ-4u-Tk-D6-MUBWABKw-JIZg-A.webp',
    'mega menus': 'https://i.ibb.co/pBYP6wt8/1-HXIU3nxu-ZGq-Ne-Ef3-Wv-Lf-MQ.webp',
    'hamburger icon': 'https://i.ibb.co/s9DPSGLM/1-Vf-C4i592d-OFh-Rbeo-C22ikw.webp',
    'O3 World': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'agile in nature': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'scrum led': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'scrum-led': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'daily scrums': 'https://i.ibb.co/zTKr9Dh9/1-7w-EKA8du-Scc-OZw-Im-A-6j-SQ.webp',
    'SEI': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'La Colombe': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'Vertex': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'WOVN': 'https://i.ibb.co/mr7gnpTg/1-y-GJCqkzizxa-Uxk3-R5-DCD8g.webp',
    'Workarea': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'Gidget': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'napkin sketches': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'napkins': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'Five Foot Gorilla': 'https://i.ibb.co/mjt5Myw/1-l-EJetj-Ut85-CTbb24d-BTFk-A.webp',
    'proprietary SaaS': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'FlightPath': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'emerging from bankruptcy': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'pharmaceutical sector': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'pharmaceutical': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'WCAG': 'https://i.ibb.co/WpyqgbYQ/1-9-EZTgvxtt-DXOac-Hz-I9axe-Q.gif',
    'Merck': 'https://i.ibb.co/WpyqgbYQ/1-9-EZTgvxtt-DXOac-Hz-I9axe-Q.gif',
    'Cards Against Bad UX': 'https://i.ibb.co/KxyvFKmq/1-P4-Gyqav-HMmzp-A-Ehqy9g-w.webp',
    'jargon-laden spreadsheets': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'single-sided meetings': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'As a shopper': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'content manager': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'guest user': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'LiveArea': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'UX Manager': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'one-point-two million': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$1.2m': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'two-thirty-five per hour': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$235/hr': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'Elva Design Group': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'Elva': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'General Nutrition Centers': 'https://i.ibb.co/pBMMxY1Z/11.webp',
    'GNC': 'https://i.ibb.co/7N2rDqrN/8.webp',
    'mobile-first navigation': 'https://i.ibb.co/vx76zjgf/10.webp',
    'shake things up': 'https://i.ibb.co/rft2bf0T/9.webp',
    'modernized and optimized': 'https://i.ibb.co/cSQCgNQY/work1.webp',
    'Huge': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'single user flow': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'siloed': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'Code and Theory': 'https://i.ibb.co/jP8rS95G/1-5g-Mvv7027-cm7r0vm-IDy1-A.webp',
    'Senior Designer': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'ACD': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'Directly Responsible Individual': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'Publicis Sapient': 'https://i.ibb.co/XkM2hn8n/bny1.png',
    'Digital Transformation': 'https://i.ibb.co/vvMZmq94/bny2.png',
    'BNY Mellon': 'https://i.ibb.co/xS49C07B/bny3.png',
    'Team Lead': 'https://i.ibb.co/rR74bLkf/1-o-XV3b-GDEf-TKoh-Ue-ICCjc1-A.webp',
    'exhaustive research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'industry research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'client workshops': 'https://i.ibb.co/XfXGRWZ5/1-RTEI5a-Ccw31fj-Fzqj-Bg-FEg.webp',
    'consistent presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'in-office presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'laid off': 'https://i.ibb.co/jkpcGvMF/1-f-TX-d-BN7l7of-M3nf-KU7p8g.webp',
    'Design Systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'design systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'data paradigm': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'networking': 'https://i.ibb.co/sJkpkV9Q/1-l4jg-O1-4g-Ey-Wy-IBEQZho0g.webp',
    'low voltage networking': 'https://i.ibb.co/sJkpkV9Q/1-l4jg-O1-4g-Ey-Wy-IBEQZho0g.webp',
    'RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'terminate an RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    '30‚Äì45 seconds': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'thirty to forty-five seconds': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'Run cables': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'security systems': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'cable management': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'twist parity': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'different parts of my brain': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'intoview.pro': 'https://i.ibb.co/ym1z1pyb/DSC05994.webp',
    'intoview': 'https://i.ibb.co/ym1z1pyb/DSC05994.webp',
    'platform for creative exploration': 'https://i.ibb.co/23QsQrCG/DSC05954.webp',
    'note-taking app': 'https://i.ibb.co/qLWQC0cN/DSC08358.webp',
    'kanban': 'https://i.ibb.co/xSCsZcyn/wmzWGlaw.webp',
    'emdash.click': 'https://i.ibb.co/0p7Ktz5L/1-Tut-Ce-PQB0b-SCo-Mf-MTWJb-Q.webp',
    'em dash utility': 'https://i.ibb.co/0p7Ktz5L/1-Tut-Ce-PQB0b-SCo-Mf-MTWJb-Q.webp',
    'sees potential': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'someone out there': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'mouths to feed': 'https://i.ibb.co/gpr7smN/1-Zs0lu-PIi-C5ly-AOEo2-LLEl-A.webp',
    'think different': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'play guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'take photographs': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'photography': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'Wolfgang': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'my dog': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'Bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'non-linear': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'career journey': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'A-list brands': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp',
    'global scale': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp',
    'pink onesie': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'pink onezie': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'systems thinking': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'hands-on prototyping': 'https://i.ibb.co/NdwrPWfV/1-Na-ZV6rc-Ew-RT55p-R12-BY0jg.webp',
    'bridge design and development': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'photographs': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'AI': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'uplift imagination': 'https://i.ibb.co/DPJM0yfz/1-k-Y6yg0chz7-Puu-Wgrl-YNMA.webp'
};

const phraseRegexMap = new Map();
Object.keys(imageMap).forEach(phrase => {
    const escapedPhrase = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    phraseRegexMap.set(phrase, new RegExp(`\\b${escapedPhrase}\\b`, 'gi'));
});

const narrative = `The year is 2026. Here we are ‚Äî scrolling endlessly through feeds optimized for monetization over mindfulness. [operational fulfillment, not emotional] Flowing endlessly through content fabricated to fade into the void. What if we paused? What if reading felt intentional again? Beat by beat by beat. From moment to movement. [All em dashes in this piece were sourced from www.emdash.click] 


I loathe to be so bold [This is not some grand manifesto about the state of UX] ‚Äî but may I say, conviction counters convection by convention [Strong belief resists being carried by the current of convention.] This is my curriculum vitae. [A polished portfolio seems disingenuous to me. Facts are never facts. Truths are almost always half-lies. Capabilities become curbed. We move through content that does not move us. It feels static. It feels stale.]  My career focus realized. My journey materialized. Through the eyes and mind of the beholder [The underlying mechanism that defines the user experience of this site concept is a 'stream of consciousness'] 

//
Truth be told, I'm building something greater than this. [] May this serve as a proof of concept ‚Äî if not of the final product, but of my approach. 
//
But first, let me introduce myself properly.
//
I am Zack ‚Äî Thinker & Maker. [musician, photographer, writer, roamer, wanderer, nomad, Metallica fan] A left-handed autodidact with an affinity for alliterative apropros. [sic] A self-taught designer who learned to code. [amongst many things] An observer, a planner, and a dreamer. A craftsman. I seek not to disrupt, but to discover.  

I built my first computer circa 2005 or 2006. Immediately installed pirated copies of Adobe Photoshop and Illustrator. While I didn't study at university long enough to graduate [stop-out, not drop-out], I studied obsessively what I saw around me. Whatever piqued my interest, I examined intensely. I studied typography by reading books, flipping through magazines, and taking on client work. I created faux website concepts to understand designing for the medium. All this culminated in responding to a Craigslist post that changed everything. [] A garage startup in the suburbs of Philadelphia that would become my formal education.

Turn5 was a paradigm shift. I joined a budding home-grown startup. I was provided a brand new PC and a Canon Rebel DSLR. I became the graphic designer for all web properties, handling package design and catalogue design. I became a Product Photographer, specializing in color match and OEM quality. We photographed thousands of parts. I later pivoted to web designer, focusing on email marketing and feature design. In four years, the company grew to forty million per year. Turn5 was my education.
//
Leadnomics was shifty. We focused on lead generation for payday loans. I helped facilitate high-interest loans for desperate people. But the perks were great ‚Äî free lunches and flexible work. My job was to make catastrophic financial decisions feel intuitive. I achieved a 95.8% conversion rate using responsive design and rigorous testing. We fashioned a hell of a fishing net. Business is necessity, not idealism.
//
Recovering from an injury, I spent my downtime learning to code ‚Äî HTML, CSS, and JavaScript. I built an interactive haiku to prove my skills. This was my gateway to agency life.

One Sixty Over Ninety hired me as an Interaction Designer in Center City, Philadelphia. I took a pay cut to join their new Interactive Department. We worked long nights and weekends. We explored grayscale wireframes, mega menus, and debated the hamburger icon. Clients included Comcast, Kent State, and the Philadelphia Eagles. I learned the hard realities of agency life.
//
O3 World was an elevating experience. We were agile in nature and scrum led. We used daily scrums to manage projects for clients like Vertex and La Colombe. Later, at Workarea, I worked on a proprietary SaaS platform. We skipped high-fidelity mockups for napkin sketches and direct collaboration with developers. We built a platform for A-list brands.
//
FlightPath was my gateway to New York. Emerging from bankruptcy, the agency served the pharmaceutical sector. I worked on rigorous WCAG compliance for clients like Merck. I was let go after exactly one year, having accomplished my goal of breaking into the NYC market.
//
LiveArea was a paradigm shift. As a UX Manager, I handled contracts worth one-point-two million at a rate of two-thirty-five per hour. I created "Cards Against Bad UX" to help clients empathize with users. By shifting the conversation to the guest user and content manager, we saved the contract.
//
At Elva Design Group, I led discovery for GNC. Management wanted to shake things up. We designed a mobile-first navigation schema. We didn't have time for perfection, but we successfully modernized and optimized their online experience.
//
At Huge, teams were massive. I was responsible for a single user flow, unaware of the other designers on the project. To say we were siloed would be an understatement.
//
At Code and Theory, I was hired as a Senior Designer with sights on ACD. I quickly proved my worth. But leadership churn and a lack of support made it a challenging experience. I acted as a Directly Responsible Individual for UX and strategy. I learned hard lessons about large agencies.
//
Enter Publicis Sapient. I spent a year working on Digital Transformation for BNY Mellon. I became the de facto Team Lead, driving exhaustive research and client workshops. Despite my consistent presence and hard work securing a contract extension, I was laid off. I was just a number on a spreadsheet.
//
Come on baby, let's do the twist. I pivoted to low voltage networking. I learned to terminate an RJ45 in 30‚Äì45 seconds. I run cables, install security systems, and manage cable management. It requires specific twist parity. I'm using different parts of my brain, but I still have mouths to feed.

As an aside, I've been building. I repurposed intoview.pro as a platform for creative exploration. I built a note-taking app and a kanban board. I created emdash.click because the world needed it. These aren't just portfolio pieces; they are functioning products that prove I can build.

Currently I'm seeking my next full-time role. I want work that matters with people who care. I offer systems thinking and hands-on prototyping. I bridge design and development. I think. I make.

Beyond the work, there's music. I play guitar left-handed. I take photographs of New York. I have a dog named Wolfgang. I once wore a pink onesie to this country. These details make the whole picture.
//
I'm not worried about AI taking our jobs. My talent is presenting ideas that uplift imagination. I do this with capable hands. [I think different]

You can find my music on SoundCloud. My photography lives on Instagram. My full portfolio is at zackgort.com. Thanks for reading one sentence at a time.`;

// ===================================
// UTILITY FUNCTIONS
// ===================================
const Utils = {
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) { func.apply(this, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }
        };
    },
    $(selector) { return document.querySelector(selector); },
    $$(selector) { return Array.from(document.querySelectorAll(selector)); }
};

// ===================================
// STATS WIDGET
// ===================================
function pulseStatValue(elId) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.remove('pulse');
    void el.offsetWidth; // reflow to restart animation
    el.classList.add('pulse');
    el.addEventListener('animationend', () => el.classList.remove('pulse'), { once: true });
}

function updateStats() {
    const sentencesEl = document.getElementById('statSentencesSeen');
    const bracketsEl = document.getElementById('statBracketsOpened');
    const chaptersEl = document.getElementById('statChaptersRead');
    if (sentencesEl) sentencesEl.textContent = state.sentencesSeen.size;
    if (bracketsEl) bracketsEl.textContent = state.bracketsOpened;
    if (chaptersEl) chaptersEl.textContent = state.chaptersRead.size;
}

function trackSentence(index) {
    const wasNew = !state.sentencesSeen.has(index);
    state.sentencesSeen.add(index);
    if (wasNew) {
        pulseStatValue('statSentencesSeen');
        updateStats();
    }
}

function trackChapter(chapterId) {
    const wasNew = !state.chaptersRead.has(chapterId);
    state.chaptersRead.add(chapterId);
    if (wasNew) {
        pulseStatValue('statChaptersRead');
        updateStats();
    }
}

function trackBracketOpen() {
    state.bracketsOpened++;
    pulseStatValue('statBracketsOpened');
    updateStats();
}

// ===================================
// DRAGGABLE WIDGET FACTORY
// ===================================
function makeDraggable(el, { useRight = true, useBottom = true } = {}) {
    let isDragging = false;
    let hasMoved = false;
    let startX, startY, initialA, initialB;
    const DRAG_THRESHOLD = 4; // px of movement before drag activates

    function getInitialPos() {
        const style = window.getComputedStyle(el);
        initialA = useRight ? parseInt(style.right, 10) || 0 : parseInt(style.left, 10) || 0;
        initialB = useBottom ? parseInt(style.bottom, 10) || 0 : parseInt(style.top, 10) || 0;
    }

    function clampToViewport(aVal, bVal, w, h) {
        const rect = el.getBoundingClientRect();
        const elW = rect.width || 200;
        const elH = rect.height || 100;
        const margin = 8;
        if (useRight) {
            aVal = Math.max(margin, Math.min(aVal, w - elW - margin));
        } else {
            aVal = Math.max(margin, Math.min(aVal, w - elW - margin));
        }
        if (useBottom) {
            bVal = Math.max(margin, Math.min(bVal, h - elH - margin));
        } else {
            bVal = Math.max(margin, Math.min(bVal, h - elH - margin));
        }
        return [aVal, bVal];
    }

    function applyPos(aVal, bVal) {
        const [ca, cb] = clampToViewport(aVal, bVal, window.innerWidth, window.innerHeight);
        if (useRight) el.style.right = ca + 'px'; else el.style.left = ca + 'px';
        if (useBottom) el.style.bottom = cb + 'px'; else el.style.top = cb + 'px';
    }

    // Mouse
    el.addEventListener('mousedown', (e) => {
        if (e.target.closest('.k-key, .chapter-item, .chapter-dropdown-list, button, a, input, [role="button"]')) return;
        isDragging = true;
        hasMoved = false;
        el.style.cursor = 'grabbing';
        startX = e.clientX; startY = e.clientY;
        getInitialPos();
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const dX = useRight ? startX - e.clientX : e.clientX - startX;
        const dY = useBottom ? startY - e.clientY : e.clientY - startY;
        if (!hasMoved && Math.abs(e.clientX - startX) < DRAG_THRESHOLD && Math.abs(e.clientY - startY) < DRAG_THRESHOLD) return;
        hasMoved = true;
        applyPos(initialA + dX, initialB + dY);
    });

    document.addEventListener('mouseup', (e) => {
        if (isDragging) {
            isDragging = false;
            hasMoved = false;
            el.style.cursor = '';
        }
    });

    // Touch
    let tStartX, tStartY;
    el.addEventListener('touchstart', (e) => {
        if (e.target.closest('.k-key, .chapter-item, .chapter-dropdown-list, button, a, input, [role="button"]')) return;
        isDragging = true;
        hasMoved = false;
        const t = e.touches[0];
        tStartX = t.clientX; tStartY = t.clientY;
        getInitialPos();
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const t = e.touches[0];
        if (!hasMoved && Math.abs(t.clientX - tStartX) < DRAG_THRESHOLD && Math.abs(t.clientY - tStartY) < DRAG_THRESHOLD) return;
        hasMoved = true;
        if (e.cancelable) e.preventDefault();
        const dX = useRight ? tStartX - t.clientX : t.clientX - tStartX;
        const dY = useBottom ? tStartY - t.clientY : t.clientY - tStartY;
        applyPos(initialA + dX, initialB + dY);
    }, { passive: false });

    document.addEventListener('touchend', () => { isDragging = false; hasMoved = false; });
}

// ===================================
// DRAGGABLE CHAPTER DROPDOWN
// ===================================
function initializeDraggableDropdown() {
    const dropdown = document.getElementById('chapterDropdown');
    const header = document.getElementById('chapterDropdownHeader');
    if (!dropdown || !header) return;

    let isDragging = false;
    let startX, startY, initLeft, initTop;
    let hasBeenDragged = false;

    function anchorToViewport() {
        // On first drag, switch from CSS-anchored to pixel-anchored position
        if (!hasBeenDragged) {
            const rect = dropdown.getBoundingClientRect();
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = rect.top + 'px';
            hasBeenDragged = true;
        }
    }

    function clampDropdown(left, top) {
        const rect = dropdown.getBoundingClientRect();
        const w = rect.width || 280;
        const h = rect.height || 300;
        const margin = 8;
        left = Math.max(margin, Math.min(left, window.innerWidth - w - margin));
        top = Math.max(margin, Math.min(top, window.innerHeight - h - margin));
        return [left, top];
    }

    // Mouse drag
    header.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation(); // prevent brand toggle from firing
        anchorToViewport();
        isDragging = true;
        dropdown.classList.add('dragging');
        startX = e.clientX; startY = e.clientY;
        initLeft = parseInt(dropdown.style.left, 10);
        initTop = parseInt(dropdown.style.top, 10);
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const newLeft = initLeft + (e.clientX - startX);
        const newTop = initTop + (e.clientY - startY);
        const [cl, ct] = clampDropdown(newLeft, newTop);
        dropdown.style.left = cl + 'px';
        dropdown.style.top = ct + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            dropdown.classList.remove('dragging');
        }
    });

    // Touch drag
    let tStartX, tStartY;
    header.addEventListener('touchstart', (e) => {
        e.preventDefault();
        e.stopPropagation();
        anchorToViewport();
        isDragging = true;
        dropdown.classList.add('dragging');
        const t = e.touches[0];
        tStartX = t.clientX; tStartY = t.clientY;
        initLeft = parseInt(dropdown.style.left, 10);
        initTop = parseInt(dropdown.style.top, 10);
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();
        const t = e.touches[0];
        const newLeft = initLeft + (t.clientX - tStartX);
        const newTop = initTop + (t.clientY - tStartY);
        const [cl, ct] = clampDropdown(newLeft, newTop);
        dropdown.style.left = cl + 'px';
        dropdown.style.top = ct + 'px';
    }, { passive: false });

    document.addEventListener('touchend', () => {
        if (isDragging) {
            isDragging = false;
            dropdown.classList.remove('dragging');
        }
    });
}

// ===================================
// TOUCH DETECTION
// ===================================
function detectTouch() {
    window.addEventListener('touchstart', () => { state.lastInteractionWasTouch = true; state.isTouch = true; }, { passive: true });
    window.addEventListener('mousedown', () => { state.lastInteractionWasTouch = false; state.isTouch = false; }, { passive: true });
}

// ===================================
// NARRATIVE PARSING
// ===================================
function parseNarrative(text) {
    const parts = [];
    let idCounter = 0;
    const segments = text.split(/(\[|\])/);
    let inBracket = false;
    let bracketId = null;
    
    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        if (segment === '[') {
            inBracket = true;
            bracketId = idCounter++;
            parts.push({ type: 'bracket', id: bracketId, content: '' });
        } else if (segment === ']') {
            inBracket = false;
            bracketId = null;
        } else if (segment.length > 0) {
            if (inBracket && bracketId !== null) {
                const bracket = parts.find(p => p.id === bracketId);
                if (bracket) bracket.content = segment.trim();
            } else {
                const lineSegments = segment.split(/(\/\/|\/)/);
                for (let j = 0; j < lineSegments.length; j++) {
                    const lineSegment = lineSegments[j];
                    if (lineSegment === '//') {
                        parts.push({ type: 'line-break', id: idCounter++, breakType: 'double' });
                    } else if (lineSegment === '/') {
                        parts.push({ type: 'line-break', id: idCounter++, breakType: 'single' });
                    } else if (lineSegment.trim()) {
                        const sentences = lineSegment.split(/(?<=[.!?])\s+/);
                        sentences.forEach(sentence => {
                            const trimmedSentence = sentence.trim();
                            if (!trimmedSentence) return;
                            if (/^\(\d+\)\s/.test(trimmedSentence)) {
                                const match = trimmedSentence.match(/^\((\d+)\)\s(.+)/);
                                if (match) { parts.push({ type: 'numbered-bullet', id: idCounter++, number: match[1], text: match[2].trim() }); return; }
                            }
                            if (trimmedSentence.startsWith('* ')) {
                                parts.push({ type: 'bullet', id: idCounter++, text: trimmedSentence.substring(2).trim() });
                                return;
                            }
                            parts.push({ type: 'sentence', id: idCounter++, text: trimmedSentence });
                        });
                    }
                }
            }
        }
    }
    return parts;
}

// ===================================
// IMAGE HANDLING
// ===================================
function wrapImageTriggers(text) {
    let wrapped = text;
    for (const [phrase, url] of Object.entries(imageMap)) {
        const regex = phraseRegexMap.get(phrase);
        if (regex) wrapped = wrapped.replace(regex, `<span class="image-trigger" data-image="${url}">$&</span>`);
    }
    return wrapped;
}

function preloadImages() {
    const imageUrls = [...new Set(Object.values(imageMap))];
    imageUrls.forEach(url => { const img = new Image(); img.src = url; });
}

function showImage(imageUrl, triggerElement) {
    cursor.currentImageElement = triggerElement;
    state.imageActive = true;
    state.currentTriggerRect = triggerElement.getBoundingClientRect();
    document.body.classList.add('image-active');
    const hoverImage = Utils.$('#hoverImage');
    const hoverImageImg = Utils.$('#hoverImageImg');
    if (state.imageTimeout) clearTimeout(state.imageTimeout);
    state.imageTimeout = setTimeout(() => {
        hoverImageImg.onload = () => hoverImage.classList.add('active');
        hoverImageImg.onerror = () => hoverImage.classList.add('active');
        hoverImageImg.src = imageUrl;
    }, CONFIG.IMAGE_HOVER_DELAY);
}

function hideImage() {
    const hoverImage = Utils.$('#hoverImage');
    if (state.imageTimeout) clearTimeout(state.imageTimeout);
    hoverImage.classList.remove('active');
    cursor.element.classList.remove('has-image');
    document.body.classList.remove('image-active');
    state.imageActive = false;
    cursor.currentImageElement = null;
    state.currentTriggerRect = null;
}

// ===================================
// CHAPTER MANAGEMENT
// ===================================
function getCurrentChapter() {
    if (state.allSentenceElements.length === 0) return 0;
    for (let i = chapters.length - 1; i >= 0; i--) {
        if (state.currentSentenceIndex >= state.chapterStartIndices[i]) return i;
    }
    return 0;
}

function goToChapter(chapterId) {
    const startIndex = state.chapterStartIndices[chapterId];
    if (startIndex !== undefined) {
        state.currentSentenceIndex = startIndex;
        highlightSentence(startIndex);
        closeChapterDropdown();
    }
}

function nextChapter() {
    const currentChapter = getCurrentChapter();
    if (currentChapter < chapters.length - 1) goToChapter(currentChapter + 1);
}

function previousChapter() {
    const currentChapter = getCurrentChapter();
    if (currentChapter > 0) goToChapter(currentChapter - 1);
}

// ===================================
// SENTENCE NAVIGATION
// ===================================
function nextSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex + 1) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function previousSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex - 1 + state.allSentenceElements.length) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function highlightSentence(index) {
    const sentence = state.allSentenceElements[index];
    if (!sentence) return;
    state.allSentenceElements.forEach(s => { s.classList.remove('active'); s.classList.add('dimmed'); });
    sentence.classList.add('active');
    sentence.classList.remove('dimmed');
    
    // Track stats
    trackSentence(index);
    trackChapter(getCurrentChapter());
    
    updateChapterProgress();
    updateChapterDropdown();
    sentence.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const imageTrigger = sentence.querySelector('.image-trigger');
    if (imageTrigger) {
        const imageUrl = imageTrigger.getAttribute('data-image');
        if (imageUrl) showImage(imageUrl, imageTrigger);
    } else {
        hideImage();
    }
}

function resetToBeginning() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = 0;
    highlightSentence(0);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===================================
// UI UPDATE FUNCTIONS
// ===================================
function updateChapterProgress() {
    const currentChapter = getCurrentChapter();
    const bars = Utils.$$('.chapter-bar');
    bars.forEach(bar => {
        const chapterId = parseInt(bar.dataset.chapterId);
        bar.classList.remove('active', 'completed');
        if (chapterId === currentChapter) bar.classList.add('active');
        else if (chapterId < currentChapter) bar.classList.add('completed');
    });
    const total = state.allSentenceElements.length;
    const current = state.currentSentenceIndex + 1;
    const progress = (current / total) * 100;
    // Landscape right-rail progress
    const landProgressFill = Utils.$('#landProgressFill');
    if (landProgressFill) landProgressFill.style.height = `${progress}%`;
}

function updateChapterDropdown() {
    const currentChapter = getCurrentChapter();
    const items = Utils.$$('.chapter-item');
    items.forEach(item => {
        const chapterId = parseInt(item.dataset.chapterId);
        if (chapterId === currentChapter) {
            item.classList.add('active');
            if (isDropdownOpen()) item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            item.classList.remove('active');
        }
    });
}

function initializeChapterProgress() {
    const container = Utils.$('#chapterProgressContainer');
    if (!container) return;
    container.innerHTML = '';
    let isRapidScrolling = false;
    let rapidScrollTimeout = null;
    chapters.forEach(chapter => {
        const bar = document.createElement('div');
        bar.className = 'chapter-bar';
        bar.dataset.chapterId = chapter.id;
        bar.dataset.chapterTitle = `${String(chapter.id + 1).padStart(2, '0')}. ${chapter.title}`;
        bar.title = chapter.title;
        bar.addEventListener('click', function(e) { e.stopPropagation(); goToChapter(parseInt(this.dataset.chapterId)); });
        bar.addEventListener('mouseenter', function() { if (isRapidScrolling) goToChapter(parseInt(this.dataset.chapterId)); });
        bar.addEventListener('mousedown', function(e) { e.preventDefault(); isRapidScrolling = true; if (rapidScrollTimeout) clearTimeout(rapidScrollTimeout); });
        container.appendChild(bar);
    });
    document.addEventListener('mouseup', function() {
        if (isRapidScrolling) {
            isRapidScrolling = false;
            if (rapidScrollTimeout) clearTimeout(rapidScrollTimeout);
            rapidScrollTimeout = setTimeout(() => isRapidScrolling = false, 100);
        }
    });
    updateChapterProgress();
}

function buildChapterDropdown() {
    const dropdownList = Utils.$('#chapterDropdownList');
    dropdownList.innerHTML = '';
    chapters.forEach(chapter => {
        const startIndex = state.chapterStartIndices[chapter.id];
        const endIndex = chapter.id < chapters.length - 1 ? state.chapterStartIndices[chapter.id + 1] : state.allSentenceElements.length;
        const li = document.createElement('li');
        li.className = 'chapter-item';
        li.dataset.chapterId = chapter.id;
        li.innerHTML = `
            <span class="chapter-item-number">${String(chapter.id + 1).padStart(2, '0')}</span>
            <span class="chapter-item-title">${chapter.title}</span>
            <span class="chapter-item-progress">${endIndex - startIndex} sentences</span>
        `;
        li.addEventListener('click', () => goToChapter(chapter.id));
        dropdownList.appendChild(li);
    });
}

// ===================================
// DROPDOWN MANAGEMENT
// ===================================
function isDropdownOpen() { return Utils.$('#chapterDropdown').classList.contains('open'); }

function toggleChapterDropdown() {
    const brand = Utils.$('#brandLogo');
    const dropdown = Utils.$('#chapterDropdown');
    brand.classList.toggle('open');
    dropdown.classList.toggle('open');
    if (dropdown.classList.contains('open')) updateChapterDropdown();
}

function closeChapterDropdown() {
    Utils.$('#brandLogo').classList.remove('open');
    Utils.$('#chapterDropdown').classList.remove('open');
}

// ===================================
// IMAGE GRID
// ===================================
function isGridOpen() { return Utils.$('#imageGridOverlay').classList.contains('open'); }

function toggleImageGrid() {
    const overlay = Utils.$('#imageGridOverlay');
    const btns = Utils.$$('.grid-toggle-btn');
    if (overlay.classList.contains('open')) {
        overlay.classList.remove('open');
        document.body.classList.remove('grid-open');
        document.body.style.overflow = '';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '‚ñ¶');
    } else {
        overlay.classList.add('open');
        document.body.classList.add('grid-open');
        document.body.style.overflow = 'hidden';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '‚úï');
        buildImageGrid();
    }
}

function buildImageGrid() {
    const content = Utils.$('#gridContent');
    content.innerHTML = '';
    const imagesByChapter = {};
    state.gridImages.forEach(imgData => {
        if (!imagesByChapter[imgData.chapterId]) imagesByChapter[imgData.chapterId] = [];
        imagesByChapter[imgData.chapterId].push(imgData);
    });
    chapters.forEach(chapter => {
        if (imagesByChapter[chapter.id] && imagesByChapter[chapter.id].length > 0) {
            const section = document.createElement('div');
            section.className = 'grid-chapter-section';
            section.innerHTML = `<div class="grid-chapter-title">Chapter ${String(chapter.id + 1).padStart(2, '0')} ¬∑ ${chapter.title}</div>`;
            const grid = document.createElement('div');
            grid.className = 'grid-images-container';
            imagesByChapter[chapter.id].forEach(imgData => {
                const item = document.createElement('div');
                item.className = 'grid-image-item';
                item.innerHTML = `<img src="${imgData.url}" loading="lazy" alt="Grid preview"><div class="grid-image-caption"><span class="caption-text">${imgData.text}</span></div>`;
                item.addEventListener('click', () => { toggleImageGrid(); state.currentSentenceIndex = imgData.index; highlightSentence(imgData.index); });
                grid.appendChild(item);
            });
            section.appendChild(grid);
            content.appendChild(section);
        }
    });
}

// ===================================
// SCROLL & TOUCH HANDLING
// ===================================
function handleScroll(event) {
    if (state.scrollCooldownActive) return;
    if (event.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) { event.preventDefault(); return; }
    if (isGridOpen()) return;
    const scrollDelta = event.deltaY;
    if (Math.abs(scrollDelta) >= CONFIG.SCROLL_THRESHOLD) {
        state.scrollCooldownActive = true;
        if (scrollDelta > 0) nextSentence(); else previousSentence();
        setTimeout(() => { state.scrollCooldownActive = false; }, CONFIG.SCROLL_COOLDOWN);
    }
    event.preventDefault();
}

function handleTouchStart(e) { state.touchStartY = e.touches[0].clientY; state.touchStartX = e.touches[0].clientX; state.touchMoved = false; }
function handleTouchMove(e) {
    state.touchMoved = true;
    if (e.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) { e.preventDefault(); return; }
    if (isGridOpen()) return;
    e.preventDefault();
}
function handleTouchEnd(e) {
    if (!state.touchMoved || state.scrollCooldownActive || isDropdownOpen() || isGridOpen()) return;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaY = state.touchStartY - touchEndY;
    if (Math.abs(deltaY) > CONFIG.FLICK_THRESHOLD) {
        state.scrollCooldownActive = true;
        if (deltaY > 0) nextSentence(); else previousSentence();
        setTimeout(() => { state.scrollCooldownActive = false; }, CONFIG.SCROLL_COOLDOWN);
    }
}

// ===================================
// PARALLAX & CURSOR
// ===================================
function updateParallax() {
    const viewportCenterX = window.innerWidth / 2;
    const viewportCenterY = window.innerHeight / 2;
    const mouseOffsetX = (state.mouseX - viewportCenterX) / viewportCenterX;
    const mouseOffsetY = (state.mouseY - viewportCenterY) / viewportCenterY;
    parallax.text.targetX = mouseOffsetX * 20 * CONFIG.TEXT_PARALLAX_STRENGTH;
    parallax.text.targetY = mouseOffsetY * 20 * CONFIG.TEXT_PARALLAX_STRENGTH;
    if (state.imageActive && state.currentTriggerRect) {
        const trigger = state.currentTriggerRect;
        const triggerCenterX = trigger.left + trigger.width / 2;
        const triggerCenterY = trigger.top + trigger.height / 2;
        const distToCenterX = (viewportCenterX - triggerCenterX) / viewportCenterX;
        const distToCenterY = (viewportCenterY - triggerCenterY) / viewportCenterY;
        parallax.image.targetX = (mouseOffsetX * 100 * CONFIG.IMAGE_PARALLAX_STRENGTH) - (distToCenterX * CONFIG.CENTER_MAGNET_STRENGTH * 100);
        parallax.image.targetY = (mouseOffsetY * 100 * CONFIG.IMAGE_PARALLAX_STRENGTH) - (distToCenterY * CONFIG.CENTER_MAGNET_STRENGTH * 100);
    } else {
        parallax.image.targetX = 0; parallax.image.targetY = 0;
    }
    parallax.text.x += (parallax.text.targetX - parallax.text.x) * CONFIG.PARALLAX_DAMPING;
    parallax.text.y += (parallax.text.targetY - parallax.text.y) * CONFIG.PARALLAX_DAMPING;
    parallax.image.x += (parallax.image.targetX - parallax.image.x) * CONFIG.PARALLAX_DAMPING;
    parallax.image.y += (parallax.image.targetY - parallax.image.y) * CONFIG.PARALLAX_DAMPING;
    const textLayer = Utils.$('#textLayer');
    const imageLayer = Utils.$('#imageLayer');
    const gridOverlay = Utils.$('#gridContent');
    if (textLayer) textLayer.style.transform = `translate3d(${parallax.text.x}px, ${parallax.text.y}px, 0)`;
    if (imageLayer) imageLayer.style.transform = `translate3d(${parallax.image.x}px, ${parallax.image.y}px, 0)`;
    if (gridOverlay) gridOverlay.style.transform = `translate3d(${parallax.image.x * 0.5}px, ${parallax.image.y * 0.5}px, 0)`;
    requestAnimationFrame(updateParallax);
}

function updateCursor() {
    if (!cursor.element) return;
    cursor.x += (cursor.targetX - cursor.x) * CONFIG.CURSOR_SMOOTHING;
    cursor.y += (cursor.targetY - cursor.y) * CONFIG.CURSOR_SMOOTHING;
    cursor.element.style.transform = `translate3d(${cursor.x}px, ${cursor.y}px, 0) translate(-50%, -50%)`;
    requestAnimationFrame(updateCursor);
}

// ===================================
// RENDER FUNCTION
// ===================================
function render() {
    const streamEl = Utils.$('#stream');
    const parsedContent = parseNarrative(narrative);
    const fragment = document.createDocumentFragment();
    state.allSentenceElements = [];
    state.gridImages = [];
    state.chapterStartIndices = new Array(chapters.length).fill(-1);
    chapters.forEach(chapter => {
        const index = narrative.indexOf(chapter.startText);
        if (index !== -1) state.chapterStartIndices[chapter.id] = index;
    });
    let sentenceCount = 0;
    let nextChapterIndex = 0;
    let currentActiveChapter = 0;

    parsedContent.forEach(part => {
        if (nextChapterIndex < chapters.length) {
            const nextChapter = chapters[nextChapterIndex];
            const textContent = part.type === 'sentence' || part.type === 'bullet' || part.type === 'numbered-bullet' ? part.text : (part.type === 'bracket' ? part.content : '');
            if (textContent && textContent.includes(nextChapter.startText)) {
                state.chapterStartIndices[nextChapter.id] = sentenceCount;
                const chapterBreak = document.createElement('div');
                chapterBreak.className = 'chapter-break';
                chapterBreak.dataset.chapterId = nextChapter.id;
                chapterBreak.innerHTML = `<span class="chapter-number">Chapter ${String(nextChapter.id + 1).padStart(2, '0')}</span><span class="chapter-title">${nextChapter.title}</span>`;
                chapterBreak.addEventListener('click', () => goToChapter(nextChapter.id));
                fragment.appendChild(chapterBreak);
                currentActiveChapter = nextChapter.id;
                nextChapterIndex++;
            }
        }

        if (part.type === 'sentence') {
            const span = document.createElement('span');
            span.className = 'sentence';
            span.dataset.sentenceIndex = sentenceCount;
            span.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            span.innerHTML = wrapImageTriggers(part.text) + ' ';
            span.addEventListener('mouseenter', () => { const index = parseInt(span.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            span.addEventListener('mouseleave', () => { state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            span.addEventListener('click', () => { state.currentSentenceIndex = parseInt(span.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(span);
            sentenceCount++;
            fragment.appendChild(span);
        } else if (part.type === 'line-break') {
            const br = document.createElement('span');
            br.className = 'line-break-spacer';
            br.innerHTML = part.breakType === 'double' ? '<br><br>' : '<br>';
            fragment.appendChild(br);
        } else if (part.type === 'bullet') {
            const li = document.createElement('div');
            li.className = 'sentence bullet-item';
            li.dataset.sentenceIndex = sentenceCount;
            li.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            li.innerHTML = '<span class="bullet-marker">‚Ä¢</span> ' + wrapImageTriggers(part.text);
            li.addEventListener('mouseenter', () => { const index = parseInt(li.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            li.addEventListener('mouseleave', () => { state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            li.addEventListener('click', () => { state.currentSentenceIndex = parseInt(li.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(li);
            sentenceCount++;
            fragment.appendChild(li);
        } else if (part.type === 'numbered-bullet') {
            const li = document.createElement('div');
            li.className = 'sentence numbered-bullet-item';
            li.dataset.sentenceIndex = sentenceCount;
            li.style.cursor = 'pointer';
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) { state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter }); break; }
            }
            li.innerHTML = `<span class="numbered-marker">${part.number}.</span> ` + wrapImageTriggers(part.text);
            li.addEventListener('mouseenter', () => { const index = parseInt(li.dataset.sentenceIndex); state.allSentenceElements.forEach((s, i) => { s.style.opacity = i === index ? '0.7' : '0.25'; }); }, { passive: true });
            li.addEventListener('mouseleave', () => { state.allSentenceElements.forEach(s => s.style.opacity = ''); }, { passive: true });
            li.addEventListener('click', () => { state.currentSentenceIndex = parseInt(li.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            state.allSentenceElements.push(li);
            sentenceCount++;
            fragment.appendChild(li);
        } else if (part.type === 'bracket') {
            const trigger = document.createElement('button');
            trigger.className = 'bracket-trigger';
            trigger.textContent = '[+]';
            const contentId = `bracket-content-${part.id}`;
            trigger.setAttribute('aria-controls', contentId);
            const content = document.createElement('span');
            content.className = 'bracket-content';
            content.id = contentId;
            content.textContent = ' ' + part.content + ' ';
            trigger.addEventListener('click', () => {
                const isExpanded = content.classList.toggle('visible');
                trigger.textContent = isExpanded ? '[‚àí]' : '[+]';
                trigger.classList.toggle('expanded');
                if (isExpanded) { state.expandedBrackets.add(part.id); trackBracketOpen(); }
                else state.expandedBrackets.delete(part.id);
            });
            fragment.appendChild(trigger);
            fragment.appendChild(content);
        }
    });
    
    streamEl.innerHTML = '';
    streamEl.appendChild(fragment);
    buildChapterDropdown();
    initializeChapterProgress();
    
    streamEl.addEventListener('mouseover', e => {
        const trigger = e.target.closest('.image-trigger');
        if (trigger) { const imageUrl = trigger.getAttribute('data-image'); if (imageUrl) showImage(imageUrl, trigger); }
    }, { passive: true });
    streamEl.addEventListener('mouseout', e => { if (e.target.closest('.image-trigger')) hideImage(); }, { passive: true });
}

// ===================================
// CONTEXT MENU
// ===================================
function initializeContextMenu() {
    const contextMenu = Utils.$('#contextMenu');
    function hideContextMenu() { contextMenu.classList.remove('open'); contextMenu.setAttribute('aria-hidden', 'true'); }
    document.addEventListener('contextmenu', e => { e.preventDefault(); });
}

// ===================================
// LAYOUT & THEME
// ===================================
function toggleLayout() {
    state.layoutMode = state.layoutMode === 'layered' ? 'split' : 'layered';
    document.body.classList.remove('layout-layered', 'layout-split');
    document.body.classList.add(`layout-${state.layoutMode}`);
    // SVG icons are now controlled by CSS classes on body, no need to update className
    document.body.style.transition = 'all 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
    setTimeout(() => document.body.style.transition = '', 500);
}

function toggleTheme() {
    const body = document.body;
    // Add a transitioning flag so grain/edge-blur don't flash during the swap
    body.classList.add('theme-transitioning');
    requestAnimationFrame(() => {
        if (body.classList.contains('theme-sport')) body.classList.remove('theme-sport');
        else if (body.classList.contains('theme-newspaper')) { body.classList.remove('theme-newspaper'); body.classList.add('theme-sport'); }
        else body.classList.add('theme-newspaper');
        const icon = Utils.$('.theme-icon');
        icon.textContent = body.classList.contains('theme-sport') ? '‚ö°' : (body.classList.contains('theme-newspaper') ? 'üìñ' : '‚òÄÔ∏è');
        requestAnimationFrame(() => {
            body.classList.remove('theme-transitioning');
        });
    });
}

// ===================================
// ACCESSIBILITY
// ===================================
function initializeAccessibility() {
    let accessibilityLevel = 2;
    const accessibilityLevels = [0, 0.25, 0.5, 0.75, 1];
    function applyAccessibilityLevel(level) {
        const value = accessibilityLevels[level];
        document.documentElement.style.setProperty('--curve-k', value * 3);
        document.documentElement.style.setProperty('--vig-opacity', Math.min(value * 2.4, 1.2));
        document.documentElement.style.setProperty('--edge-blur', (value * 20) + 'px');
        document.body.style.fontSize = ((1.3 - (value * 0.9)) * 100) + '%';
        Utils.$$('.level-indicator').forEach((el, i) => { el.classList.toggle('active', i === level); });
    }
    Utils.$('#accessibilityIncrease').addEventListener('click', () => { if (accessibilityLevel > 0) applyAccessibilityLevel(--accessibilityLevel); });
    Utils.$('#accessibilityDecrease').addEventListener('click', () => { if (accessibilityLevel < accessibilityLevels.length - 1) applyAccessibilityLevel(++accessibilityLevel); });
    applyAccessibilityLevel(accessibilityLevel);
}

// ===================================
// LONG PRESS
// ===================================
function setupLongPress(buttonId, normalAction, longPressAction) {
    const button = Utils.$(`#${buttonId}`);
    if (!button) return;
    let longPressTimer = null;
    let longPressActivated = false;
    button.addEventListener('touchstart', () => {
        longPressActivated = false;
        longPressTimer = setTimeout(() => { longPressActivated = true; longPressAction(); if (navigator.vibrate) navigator.vibrate(50); }, CONFIG.LONG_PRESS_DURATION);
    }, { passive: true });
    button.addEventListener('touchend', (e) => { if (longPressTimer) clearTimeout(longPressTimer); if (longPressActivated) e.preventDefault(); }, { passive: false });
    button.addEventListener('touchcancel', () => { if (longPressTimer) clearTimeout(longPressTimer); }, { passive: true });
    button.addEventListener('click', (e) => { if (longPressActivated) { e.preventDefault(); e.stopPropagation(); longPressActivated = false; } else normalAction(); });
}

// ===================================
// CLOSE HOTSPOTS
// ===================================
function initializeCloseHotspots() {
    const gridCloseHotspot = Utils.$('#gridCloseHotspot');
    const rotateCloseHotspot = Utils.$('#rotateCloseHotspot');
    gridCloseHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    gridCloseHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    gridCloseHotspot.addEventListener('click', () => { toggleImageGrid(); cursor.element.classList.remove('close-mode'); });
    rotateCloseHotspot.addEventListener('mouseenter', () => cursor.element.classList.add('close-mode'));
    rotateCloseHotspot.addEventListener('mouseleave', () => cursor.element.classList.remove('close-mode'));
    rotateCloseHotspot.addEventListener('click', () => { Utils.$('.rotate-warning').style.display = 'none'; cursor.element.classList.remove('close-mode'); });
}

// ===================================
// KEYBOARD CONTROLS
// ===================================
function initializeKeyboardControls() {
    const getBtnForKey = (key) => {
        if (key === 'ArrowUp' || key === 'k' || key === 'Backspace') return Utils.$('#prevSentenceBtn');
        if (key === 'ArrowDown' || key === 'j' || key === ' ' || key === 'Space') return Utils.$('#nextSentenceBtn');
        return null;
    };
    // Also flash HUD buttons on key press for visual feedback
    const getHudBtnForKey = (key) => {
        if (key === 'ArrowUp' || key === 'k' || key === 'Backspace' || key === 'ArrowLeft') return Utils.$('#hudPrevBtn');
        if (key === 'ArrowDown' || key === 'j' || key === ' ' || key === 'Space' || key === 'ArrowRight') return Utils.$('#hudNextBtn');
        return null;
    };
    // Get keyboard legend key element for highlighting
    const getKeyElement = (key) => {
        if (key === 'ArrowUp' || key === 'k') return Utils.$('#keyPrevSentence');
        if (key === 'ArrowDown' || key === 'j') return Utils.$('#keyNextSentence');
        if (key === 'ArrowLeft') return Utils.$('#keyPrevChapter');
        if (key === 'ArrowRight') return Utils.$('#keyNextChapter');
        return null;
    };
    document.addEventListener('keydown', e => {
        const btn = getBtnForKey(e.key);
        if (btn) btn.classList.add('active-press');
        const hudBtn = getHudBtnForKey(e.key);
        if (hudBtn) hudBtn.classList.add('active-press');
        // Highlight keyboard legend keys
        const keyElement = getKeyElement(e.key);
        if (keyElement) {
            keyElement.style.background = 'var(--accent)';
            keyElement.style.color = '#fff';
            keyElement.style.borderColor = 'var(--accent)';
        }
        
        if (e.key === 'Space' || e.code === 'Space') { e.preventDefault(); nextSentence(); }
        else if (e.key === 'Backspace') { e.preventDefault(); previousSentence(); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); nextChapter(); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); previousChapter(); }
        else if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); nextSentence(); }
        else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); previousSentence(); }
        else if (e.key === 'Shift') { e.preventDefault(); toggleLayout(); }
        else if (e.key === 'l') toggleLayout();
        else if (e.key.toLowerCase() === 't') toggleTheme();
        else if (e.key === 'Home') { e.preventDefault(); resetToBeginning(); }
        else if (e.key === 'Escape' || e.key.toLowerCase() === 'x') {
            closeChapterDropdown();
            if (isGridOpen()) { toggleImageGrid(); cursor.element.classList.remove('close-mode'); }
            else if (Utils.$('.rotate-warning').style.display === 'flex') { Utils.$('.rotate-warning').style.display = 'none'; cursor.element.classList.remove('close-mode'); }
            else if (state.layoutMode === 'split') toggleLayout();
        }
    });
    document.addEventListener('keyup', e => { 
        const btn = getBtnForKey(e.key); if (btn) btn.classList.remove('active-press');
        const hudBtn = getHudBtnForKey(e.key); if (hudBtn) hudBtn.classList.remove('active-press');
        // Remove highlight from keyboard legend keys
        const keyElement = getKeyElement(e.key);
        if (keyElement) {
            keyElement.style.background = '';
            keyElement.style.color = '';
            keyElement.style.borderColor = '';
        }
    });
}

// ===================================
// INTERACTION HINT
// ===================================
function initializeInteractionHint() {
    let hintDismissed = false;
    const dismissHint = () => { if (!hintDismissed) { document.body.classList.add('hint-shown'); hintDismissed = true; } };
    document.addEventListener('click', dismissHint, { once: true });
    document.addEventListener('touchstart', dismissHint, { once: true });
    setTimeout(dismissHint, 3000);
}

// ===================================
// MAIN INITIALIZATION
// ===================================
document.addEventListener('DOMContentLoaded', () => {
    cursor.element = Utils.$('#cursor');
    
    document.addEventListener('mousemove', e => {
        cursor.targetX = e.clientX; cursor.targetY = e.clientY;
        state.mouseX = e.clientX; state.mouseY = e.clientY;
    }, { passive: true });
    
    document.addEventListener('mouseover', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item, .k-key')) {
            cursor.element.classList.add('hovering');
            if (e.target.matches('button, a, .grid-image-item, .k-key')) cursor.element.classList.add('pointer');
        }
    }, { passive: true });
    
    document.addEventListener('mouseout', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item, .k-key')) {
            cursor.element.classList.remove('hovering', 'pointer');
        }
    }, { passive: true });
    
    detectTouch();
    initializeAccessibility();
    initializeContextMenu();
    initializeCloseHotspots();
    initializeKeyboardControls();
    initializeInteractionHint();
    
    // Initialize draggable widgets using factory
    const legend = document.getElementById('keyboardLegend');
    if (legend) {
        makeDraggable(legend, { useRight: true, useBottom: true });
        Utils.$('#keyPrevSentence').addEventListener('click', (e) => { e.stopPropagation(); previousSentence(); });
        Utils.$('#keyNextSentence').addEventListener('click', (e) => { e.stopPropagation(); nextSentence(); });
        Utils.$('#keyPrevChapter').addEventListener('click', (e) => { e.stopPropagation(); previousChapter(); });
        Utils.$('#keyNextChapter').addEventListener('click', (e) => { e.stopPropagation(); nextChapter(); });
    }
    
    const statsWidget = document.getElementById('statsWidget');
    if (statsWidget) {
        // Only make draggable on desktop ‚Äî on mobile it's a centered floating HUD
        const updateStatsWidgetPosition = () => {
            if (window.innerWidth <= 768) {
                // Mobile: explicitly enforce centering ‚Äî don't just clear, set the values
                // so drag code's inline styles can't win
                statsWidget.style.left = '0';
                statsWidget.style.right = '0';
                statsWidget.style.transform = 'none';
                statsWidget.style.marginLeft = 'auto';
                statsWidget.style.marginRight = 'auto';
                statsWidget.style.width = 'fit-content';
                statsWidget.style.bottom = '';
            } else {
                // Desktop: restore draggable positioning
                statsWidget.style.left = statsWidget.dataset.desktopLeft || '80px';
                statsWidget.style.transform = '';
            }
        };
        
        // Initial setup - apply immediately
        if (window.innerWidth > 768) {
            makeDraggable(statsWidget, { useRight: false, useBottom: true });
            // Save initial desktop position
            statsWidget.dataset.desktopLeft = statsWidget.style.left || '80px';
        }
        
        // Apply position on initial load
        updateStatsWidgetPosition();
        
        // Re-evaluate on resize
        window.addEventListener('resize', Utils.debounce(() => {
            if (window.innerWidth <= 768) {
                updateStatsWidgetPosition();
            } else if (window.innerWidth > 768) {
                makeDraggable(statsWidget, { useRight: false, useBottom: true });
                updateStatsWidgetPosition();
            }
        }, 200));
    }
    
    // Event listeners
    Utils.$('#brandLogo').addEventListener('click', toggleChapterDropdown);
    Utils.$('#gridToggleBtn').addEventListener('click', toggleImageGrid);
    Utils.$('#layoutToggle').addEventListener('click', toggleLayout);
    Utils.$('#themeToggle').addEventListener('click', toggleTheme);
    Utils.$('#prevSentenceBtn').addEventListener('click', previousSentence);
    Utils.$('#nextSentenceBtn').addEventListener('click', nextSentence);
    
    document.addEventListener('click', e => {
        if (!Utils.$('#brandLogo').contains(e.target) && !Utils.$('#chapterDropdown').contains(e.target)) closeChapterDropdown();
    });
    
    window.addEventListener('wheel', handleScroll, { passive: false });
    window.addEventListener('touchstart', handleTouchStart, { passive: true });
    window.addEventListener('touchmove', handleTouchMove, { passive: false });
    window.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // Wire HUD nav buttons with long-press (prev/next sentence, long-press for chapter)
    setupLongPress('hudPrevBtn', previousSentence, previousChapter);
    setupLongPress('hudNextBtn', nextSentence, nextChapter);
    setupLongPress('landPrevBtn', previousSentence, previousChapter);
    setupLongPress('landNextBtn', nextSentence, nextChapter);
    
    preloadImages();
    render();
    updateStats(); // Initialize stats display
    updateCursor();
    updateParallax();
    
    document.body.classList.add(`layout-${state.layoutMode}`);
    
    if (state.allSentenceElements.length > 0) {
        state.currentSentenceIndex = 0;
        highlightSentence(0);
    }
    
    // Initialize draggable dropdown after render
    initializeDraggableDropdown();
    
    window.toggleLayout = toggleLayout;
    window.toggleTheme = toggleTheme;
});
    </script>
</body>
</html>
