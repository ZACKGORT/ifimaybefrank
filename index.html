<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="IFIMAYBEFRANK">
    <title>IFIMAYBEFRANK</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables & Themes preserved exactly as original */
        :root {
            --bg-color: #000000;
            --ink: #ffffff;
            --ink-2: #b8b8b8;
            --ink-3: #808080;
            --accent: #daa520;
            --curve-k: 1;
            --vig-opacity: 0.85;
            --vig-inner: 30%;
            --vig-mid: 75%;
            --vig-outer: 100%;
            --edge-blur: 6px;
            --edge-mask-i: 65%;
            --edge-mask-o: 80%;
            --z-content: 0;
            --z-grain: 149;
            --z-blur: 150;
            --z-vig: 151;
            --z-ui: 220;
            --z-overlay: 300;
            --z-dropdown: 350;
            --z-rail: 210;
            --z-mobile-bottom-rail: 220;
            --z-rotate-warning: 9999;
            --bracket-color: #8b6f47;
            --bracket-hover: #daa520;
            --bracket-bg: rgba(218, 165, 32, 0.04);
            
            --text-parallax-strength: 0.03;
            --image-parallax-strength: 0.15;
            --center-magnet-strength: 0.25;
        }
        
        /* Newspaper/Ink Light Theme */
        body.theme-newspaper {
            --bg-color: #faf8f3;
            --ink: #000000;
            --ink-2: #1a1a1a;
            --ink-3: #2a2a2a;
            --accent: #8b4513;
            --vig-opacity: 0.12;
            --bracket-color: #5d4e37;
            --bracket-hover: #8b4513;
            --bracket-bg: rgba(139, 69, 19, 0.03);
        }
        
        /* Academic Theme */
        body.theme-academic {
            --bg-color: #ffffff;
            --ink: #000000;
            --ink-2: #1a1a1a;
            --ink-3: #333333;
            --accent: #0066cc;
            --vig-opacity: 0;
            --edge-blur: 0px;
            --bracket-color: #004080;
            --bracket-hover: #0066cc;
            --bracket-bg: rgba(0, 102, 204, 0.05);
        }
        
        /* ... [All original styles preserved] ... */
        /* Consolidated optimized styles for performance below */
        
        body.theme-newspaper .scroll-progress-bar-container { background: rgba(0, 0, 0, 0.08); }
        body.theme-newspaper .nav-button, body.theme-newspaper .lens-control-container, body.theme-newspaper .mobile-bottom-rail, body.theme-newspaper .mobile-right-rail { background: rgba(245, 241, 232, 0.95); border-color: rgba(0, 0, 0, 0.12); }
        body.theme-newspaper .nav-button:hover { background: rgba(139, 69, 19, 0.08); }
        body.theme-newspaper .stream { color: var(--ink) !important; }
        body.theme-newspaper .grain { background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJhIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iLjkiIG51bU9jdGF2ZXM9IjQiLz48ZmVDb2xvck1hdHJpeCB0eXBlPSJzYXR1cmF0ZSIgdmFsdWVzPSIwIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2EpIiBvcGFjaXR5PSIuMDUiLz48L3N2Zz4='); opacity: 0.3; }
        body.theme-newspaper .chapter-dropdown { background: rgba(245, 241, 232, 0.98); border-color: rgba(0, 0, 0, 0.15); }
        body.theme-newspaper .chapter-item:hover { background: rgba(139, 69, 19, 0.06); }
        
        /* Academic styles */
        body.theme-academic .scroll-progress-bar-container { background: rgba(0, 0, 0, 0.1); }
        body.theme-academic .nav-button, body.theme-academic .lens-control-container, body.theme-academic .mobile-bottom-rail, body.theme-academic .mobile-right-rail { background: rgba(255, 255, 255, 0.98); border-color: rgba(0, 0, 0, 0.15); }
        body.theme-academic .nav-button:hover { background: rgba(0, 102, 204, 0.08); }
        body.theme-academic .lens-slider { background: rgba(0, 0, 0, 0.15); }
        body.theme-academic .stream { color: var(--ink) !important; line-height: 1.9; }
        body.theme-academic .grain, body.theme-academic .vignette, body.theme-academic .edge-blur { display: none; }
        body.theme-academic .chapter-dropdown { background: rgba(255, 255, 255, 0.98); border-color: rgba(0, 0, 0, 0.2); }
        body.theme-academic .chapter-item:hover { background: rgba(0, 102, 204, 0.08); }
        body.theme-academic .sentence { color: #000000; }
        body.theme-academic .sentence:hover { color: #000000; background: rgba(0, 102, 204, 0.1); padding: 2px 6px; border-radius: 2px; }
        body.theme-academic .sentence.active { color: #ffffff; background: #0066cc; padding: 2px 6px; border-radius: 2px; text-shadow: none; }
        body.theme-academic .sentence.dimmed { opacity: 0.4; color: #333333; }
        body.theme-academic .chapter-break { border-top-color: rgba(0, 102, 204, 0.3); border-bottom-color: rgba(0, 102, 204, 0.3); color: var(--accent); }
        body.theme-academic .image-grid-overlay { background: rgba(255, 255, 255, 0.98); }
        body.theme-academic .grid-chapter-title { border-bottom-color: rgba(0, 0, 0, 0.15); }
        body.theme-academic .grid-image-item { border-color: rgba(0, 0, 0, 0.2); background: #f5f5f5; }
        body.theme-academic .grid-image-item:hover { border-color: var(--accent); box-shadow: 0 4px 12px rgba(0, 102, 204, 0.2); }
        body.theme-academic .accessibility-btn { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.15); }
        body.theme-academic .accessibility-btn:hover { background: rgba(0, 102, 204, 0.1); }
        body.theme-academic .level-indicator { background: rgba(0, 0, 0, 0.15); }
        body.theme-academic .level-indicator.active { background: var(--accent); }
        body.theme-academic .context-menu { background: rgba(255, 255, 255, 0.98); border-color: rgba(0, 0, 0, 0.2); }
        body.theme-academic .context-menu-item { color: var(--ink-2); }
        body.theme-academic .context-menu-item:hover { background: rgba(0, 102, 204, 0.08); color: var(--accent); }
        body.theme-academic .context-menu-item:active { background: rgba(0, 102, 204, 0.15); }
        body.theme-academic .context-menu-divider { background: rgba(0, 0, 0, 0.15); }
        
        /* Newspaper extra styles */
        body.theme-newspaper .grid-chapter-title { border-bottom-color: rgba(0, 0, 0, 0.12); }
        body.theme-newspaper .grid-image-item { border-color: rgba(0, 0, 0, 0.15); background: #e8e4d8; }
        body.theme-newspaper .grid-image-item:hover { border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); }
        body.theme-newspaper .sentence { color: #000000; }
        body.theme-newspaper .sentence:hover { color: #000000; background: rgba(255, 255, 255, 0.95); padding: 2px 6px; border-radius: 2px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        body.theme-newspaper .sentence.active { color: #ffffff; background: #000000; padding: 2px 6px; border-radius: 2px; text-shadow: none; }
        body.theme-newspaper .sentence.dimmed { opacity: 0.35; color: #333333; }
        body.theme-newspaper .chapter-break { border-top-color: rgba(139, 69, 19, 0.25); border-bottom-color: rgba(139, 69, 19, 0.25); color: var(--accent); }
        
        /* Newspaper Context Menu */
        body.theme-newspaper .context-menu { background: rgba(245, 241, 232, 0.98); border-color: rgba(0, 0, 0, 0.15); }
        body.theme-newspaper .context-menu-item { color: var(--ink-2); }
        body.theme-newspaper .context-menu-item:hover { background: rgba(139, 69, 19, 0.08); color: var(--accent); }
        body.theme-newspaper .context-menu-item:active { background: rgba(139, 69, 19, 0.15); }
        body.theme-newspaper .context-menu-divider { background: rgba(0, 0, 0, 0.1); }
        
        html, body { overscroll-behavior: none; touch-action: pan-y; }
        body.layout-layered .text-layer { width: 95%; margin: 0 auto; max-width: 1400px; }
        body.layout-layered .stream { color: rgba(255, 255, 255, 0.85); }
        body.layout-layered .hover-image { position: absolute; left: 50%; top: 50%; }
        body.layout-split .text-layer { width: 50%; margin: 0; padding-left: 6vw; }
        body.layout-split .stream { color: rgba(255, 255, 255, 0.9); font-size: clamp(16px, 2vw, 28px); }
        body.layout-split .hover-image { position: fixed; left: 72%; top: 50%; width: 45vw; height: 34vw; opacity: 1 !important; }
        body.layout-split .sentence.dimmed { opacity: 0.75 !important; }
        body.layout-split.theme-newspaper .sentence.dimmed { opacity: 0.70 !important; color: #1a1a1a !important; }
        body.layout-split.theme-academic .sentence.dimmed { opacity: 0.70 !important; color: #1a1a1a !important; }
        body:not(.cursor-preview-mode) .hover-image { display: block; }
        body:not(.cursor-preview-mode) #cursorImage { display: none !important; }
        body.cursor-preview-mode .hover-image { display: none !important; }
        body.cursor-preview-mode #cursorImage { display: block !important; }
        
        /* Navigation Rails */
        .scroll-progress { position: fixed; right: 30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: var(--z-ui); pointer-events: auto; }
        .scroll-progress-bar-container { width: 2px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 1px; position: relative; margin: 10px 0; }
        .scroll-progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--accent); border-radius: 1px; transition: height 0.3s ease; }
        .nav-button { width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--ink-3); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 14px; pointer-events: auto; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .nav-button:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--accent); color: var(--accent); transform: scale(1.1); }
        .nav-button:active { transform: scale(0.95); }
        .nav-button svg { width: 16px; height: 16px; fill: currentColor; }
        
        .left-rail { position: fixed; left: 0; top: 50%; transform: translateY(-50%); z-index: var(--z-rail); padding: 20px 12px; pointer-events: auto; display: flex; align-items: center; }
        .lens-control-container { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-left: none; border-radius: 0 8px 8px 0; padding: 16px 8px; display: flex; flex-direction: column; align-items: center; gap: 12px; backdrop-filter: blur(5px); }
        .lens-label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.05em; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        .accessibility-controls { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .accessibility-btn { width: 28px; height: 28px; border-radius: 4px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--ink-2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .accessibility-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--accent); color: var(--accent); }
        .accessibility-btn:active { transform: scale(0.9); }
        .accessibility-btn svg { width: 16px; height: 16px; }
        .accessibility-level { display: flex; flex-direction: column; gap: 4px; padding: 8px 0; }
        .level-indicator { width: 16px; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; transition: background 0.2s ease; }
        .level-indicator.active { background: var(--accent); }
        
        body.theme-newspaper .accessibility-btn { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.1); }
        body.theme-newspaper .accessibility-btn:hover { background: rgba(139, 69, 19, 0.1); }
        body.theme-newspaper .level-indicator { background: rgba(0, 0, 0, 0.1); }
        body.theme-newspaper .level-indicator.active { background: var(--accent); }
        
        /* Mobile Rails */
        .mobile-right-rail { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 60px; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: var(--z-ui); flex-direction: column; align-items: center; justify-content: center; gap: 20px; border-left: 1px solid rgba(255, 255, 255, 0.1); padding: 20px 0; }
        .mobile-bottom-rail { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 12px 20px; z-index: var(--z-mobile-bottom-rail); pointer-events: auto; }
        .mobile-nav-container { display: flex; justify-content: space-between; align-items: center; gap: 12px; max-width: 500px; margin: 0 auto; width: 100%; }
        .mobile-right-rail .mobile-nav-container { flex-direction: column; height: 100%; justify-content: space-between; }
        .mobile-right-rail .rail-top-group, .mobile-right-rail .rail-bottom-group { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .mobile-nav-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .mobile-nav-button { width: 48px; height: 48px; border-radius: 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--accent); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; pointer-events: auto; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        .mobile-nav-button:active { transform: scale(0.92); background: rgba(218, 165, 32, 0.15); }
        .mobile-nav-button svg { width: 22px; height: 22px; fill: currentColor; }
        .mobile-nav-label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.05em; }
        .mobile-progress-container { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 0 12px; }
        .mobile-right-rail .mobile-progress-container { height: 100%; width: 100%; flex: 1; justify-content: center; padding: 20px 0; }
        .mobile-right-rail .mobile-progress-bar { width: 4px; height: 100%; max-height: 200px; }
        .mobile-right-rail .mobile-progress-fill { width: 100%; height: 0%; bottom: 0; top: auto; transition: height 0.3s ease; }
        .mobile-progress-text { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--ink-2); letter-spacing: 0.05em; }
        .mobile-progress-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; position: relative; overflow: hidden; }
        .mobile-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s ease; width: 0%; }
        
        body.image-active .sentence:not(.active) { opacity: 0.1; color: rgba(255, 255, 255, 0.3); }
        body.image-active .sentence.active { opacity: 1; color: #fff; }
        body.image-active .sentence.dimmed { opacity: 0.05; color: rgba(255, 255, 255, 0.15); }
        
        *, *::before, *::after { box-sizing: border-box; }
        html { color-scheme: dark; -webkit-text-size-adjust: 100%; }
        body, html { height: 100%; margin: 0; overflow-x: hidden; }
        body { background: var(--bg-color); color: var(--ink); font: 18px/1.8 'Crimson Text', Georgia, serif; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; cursor: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        ::selection { background: rgba(218, 165, 32, 0.25); color: #fff; }
        
        .context-menu { position: fixed; z-index: calc(var(--z-overlay) + 100); background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 8px 0; min-width: 200px; opacity: 0; transform: scale(0.95); pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
        .context-menu.open { opacity: 1; transform: scale(1); pointer-events: auto; }
        .context-menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--ink-2); font-family: 'Space Mono', monospace; font-size: 13px; cursor: pointer; transition: all 0.15s ease; user-select: none; }
        .context-menu-item:hover { background: rgba(255, 255, 255, 0.08); color: var(--accent); }
        .context-menu-item:active { background: rgba(255, 255, 255, 0.15); }
        .context-menu-item.context-menu-info { cursor: default; opacity: 0.5; font-size: 11px; padding: 8px 16px; }
        .context-menu-item.context-menu-info:hover { background: transparent; color: var(--ink-2); }
        .ctx-icon { font-size: 16px; width: 20px; text-align: center; }
        .context-menu-divider { height: 1px; background: rgba(255, 255, 255, 0.1); margin: 6px 8px; }
        
        .edge-blur { position: fixed; inset: 0; pointer-events: none; z-index: var(--z-blur); backdrop-filter: blur(var(--edge-blur)); -webkit-backdrop-filter: blur(var(--edge-blur)); mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o)); -webkit-mask: radial-gradient(100% 64% at 50% 50%, transparent var(--edge-mask-i), rgb(255 255 255 / 0.98) var(--edge-mask-o)); }
        .vignette { position: fixed; inset: 0; pointer-events: none; z-index: var(--z-vig); background: radial-gradient(120% 90% at 50% 50%, #fff0 var(--vig-inner), rgb(0 0 0 / 0.55) var(--vig-mid), rgb(0 0 0 / 0.9) var(--vig-outer)); opacity: calc(var(--vig-opacity) * var(--curve-k)); }
        body::after { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: var(--z-grain); opacity: 0.08; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.45'/%3E%3C/svg%3E"); background-size: 120px 120px; }
        
        .curved { position: fixed; inset: 0; transform-style: preserve-3d; transform: perspective(1000px) translateZ(calc(-200px * var(--curve-k))) scale(calc(1 + var(--curve-k) * 0.06)); will-change: transform; z-index: var(--z-content); }
        .parallax-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .text-layer { position: relative; z-index: 10; padding: 15vh 8vw 25vh; max-width: 99%; margin: 0 auto; transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear; }
        .image-layer { position: fixed; inset: 0; z-index: 5; pointer-events: none; transform-style: preserve-3d; will-change: transform; transition: transform 0.1s linear; }
        .stream { font-size: clamp(18px, 2.5vw, 32px); line-height: 1.8; letter-spacing: -0.01em; max-width: 100%; color: rgba(255, 255, 255, 0.85); }
        .sentence { display: inline; transition: opacity 0.3s ease, color 0.3s ease; cursor: none; position: relative; z-index: 2; letter-spacing: -0.01em; }
        .sentence.active { color: #fff; opacity: 1; text-shadow: 0 0 20px rgba(218, 165, 32, 0.3); background: rgba(0, 0, 0, 0.85); padding: 2px 6px; border-radius: 2px; }
        .sentence.dimmed { opacity: 0.4; color: rgba(255, 255, 255, 0.5); }
        .chapter-break { display: block; margin: 3em 0 2em; padding: 1.5em 0; border-top: 1px solid rgba(218, 165, 32, 0.2); border-bottom: 1px solid rgba(218, 165, 32, 0.2); text-align: center; font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); opacity: 0.6; cursor: pointer; transition: all 0.3s ease; pointer-events: auto; }
        .chapter-break:hover { opacity: 1; background: rgba(218, 165, 32, 0.05); padding: 1.5em 1em; }
        .chapter-break .chapter-number { display: block; font-size: 0.7em; margin-bottom: 0.5em; color: var(--ink-3); }
        .chapter-break .chapter-title { display: block; font-size: 1.2em; font-weight: 700; letter-spacing: 0.1em; }
        
        .bracket-trigger { all: unset; cursor: none; font-family: 'Space Mono', 'Courier New', monospace; font-size: 0.65em; color: var(--bracket-color); letter-spacing: 0.02em; transition: all 0.2s ease; border-bottom: 1px dotted rgba(139, 111, 71, 0.5); padding-bottom: 1px; display: inline; vertical-align: baseline; line-height: inherit; margin: 0 0.1em; }
        .bracket-trigger:hover { color: var(--bracket-hover); opacity: 1; border-bottom-color: var(--bracket-hover); }
        .bracket-trigger.expanded { opacity: 0.5; }
        .bracket-content { display: none; font-size: 0.8em; color: rgba(184, 184, 184, 0.8); font-style: italic; line-height: inherit; padding-left: 0.2em; margin-left: 0.2em; border-left: 1px solid rgba(218, 165, 32, 0.5); padding-right: 0.2em; background: rgba(218, 165, 32, 0.02); animation: bracketFadeIn 0.3s ease-out; }
        .bracket-content.visible { display: inline; }
        
        @keyframes bracketFadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        
        .image-trigger { position: relative; text-decoration: none; border-bottom: 1px dotted var(--accent); cursor: help; transition: all 0.2s ease; opacity: 0.9; }
        .image-trigger:hover { color: var(--accent); border-bottom-style: solid; opacity: 1; }
        
        .hover-image { position: absolute; z-index: 1; pointer-events: none; opacity: 0; transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.1s linear; width: 1400px; height: 1050px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); transform: translate(-50%, -50%) scale(0.95); filter: brightness(0.9) contrast(1.05); will-change: transform, opacity; left: 50%; top: 50%; }
        .hover-image.active { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        .hover-image img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        
        #cursorImage { position: fixed; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s ease, width 0.3s ease, height 0.3s ease; border-radius: 4px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); width: 400px; height: 300px; object-fit: cover; display: none; top: 0; left: 0; }
        #cursorImage.active { opacity: 1; }
        #cursorImage.enlarged { width: 600px; height: 450px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-ui); padding: clamp(16px, 2vh, 28px) clamp(20px, 4vw, 50px); display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
        .brand-container { position: relative; pointer-events: auto; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .brand { font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--ink-3); padding: 6px 10px; border-radius: 3px; transition: all 0.2s ease; text-decoration: none; background: rgba(255, 255, 255, 0.015); border: 1px solid rgba(255, 255, 255, 0.06); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .brand:hover { background: rgba(255, 255, 255, 0.04); color: var(--ink); border-color: var(--accent); }
        .brand:active { transform: scale(0.95); }
        .brand-dropdown-icon { font-size: 10px; transition: transform 0.2s ease; }
        .brand.open .brand-dropdown-icon { transform: rotate(180deg); }
        
        .chapter-dropdown { position: absolute; top: calc(100% + 8px); left: 0; min-width: 280px; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 8px 0; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); z-index: var(--z-dropdown); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); max-height: 70vh; display: flex; flex-direction: column; }
        .chapter-dropdown.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .chapter-dropdown-header { padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); margin-bottom: 8px; flex-shrink: 0; }
        .chapter-dropdown-header h3 { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink-3); margin: 0; font-weight: 400; }
        .chapter-dropdown-list { overflow-y: auto; padding: 0; margin: 0; list-style: none; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .chapter-dropdown-list::-webkit-scrollbar { width: 4px; }
        .chapter-dropdown-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .chapter-dropdown-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 2px; }
        .chapter-item { padding: 10px 16px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; }
        .chapter-item:hover { background: rgba(218, 165, 32, 0.08); }
        .chapter-item.active { background: rgba(218, 165, 32, 0.12); border-left: 2px solid var(--accent); }
        .chapter-item-number { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--ink-3); min-width: 40px; }
        .chapter-item-title { font-family: 'Crimson Text', serif; font-size: 14px; color: var(--ink-2); font-style: italic; }
        .chapter-item.active .chapter-item-title { color: var(--accent); font-style: normal; }
        .chapter-item-progress { margin-left: auto; font-family: 'Space Mono', monospace; font-size: 9px; color: var(--ink-3); background: rgba(255, 255, 255, 0.05); padding: 2px 6px; border-radius: 2px; }
        
        .preview-toggle, .layout-toggle, .theme-toggle { pointer-events: auto; }
        .preview-button, .layout-button, .grid-toggle-btn, .theme-button { background: rgba(255, 255, 255, 0.015); border: 1px solid rgba(255, 255, 255, 0.06); padding: 8px 12px; border-radius: 3px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace; font-size: 10px; color: var(--ink-3); gap: 6px; pointer-events: auto; }
        .preview-button:hover, .layout-button:hover, .grid-toggle-btn:hover, .theme-button:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.12); }
        .preview-button:active, .layout-button:active, .grid-toggle-btn:active, .theme-button:active { transform: scale(0.95); }
        .preview-button.active { border-color: var(--accent); color: var(--accent); }
        
        .layout-icon { width: 24px; height: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
        .layout-icon.layered::before, .layout-icon.layered::after { content: ''; display: block; width: 100%; height: 6px; background: var(--ink-3); border-radius: 1px; transition: all 0.3s ease; }
        .layout-icon.layered::after { opacity: 0.5; margin-top: -4px; }
        .layout-icon.split::before, .layout-icon.split::after { content: ''; display: block; border-radius: 1px; transition: all 0.3s ease; }
        .layout-icon.split::before { width: 10px; height: 100%; background: var(--ink-3); }
        .layout-icon.split::after { width: 10px; height: 100%; background: var(--ink-3); margin-left: 4px; opacity: 0.5; }
        .grid-toggle-btn { text-transform: uppercase; letter-spacing: 0.05em; }
        
        .image-grid-overlay { position: fixed; inset: 0; z-index: var(--z-overlay); background: rgba(5, 5, 5, 0.96); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; overflow-y: auto; }
        .image-grid-overlay.open { display: flex; opacity: 1; }
        
        .close-hotspot { position: fixed; top: 0; right: 0; width: 25vw; height: 25vh; min-width: 150px; min-height: 150px; z-index: calc(var(--z-overlay) + 10); cursor: none; display: none; pointer-events: auto; }
        .grid-close-hotspot { z-index: calc(var(--z-overlay) + 10); display: none; }
        body.grid-open .grid-close-hotspot { display: block; }
        .split-close-hotspot { z-index: calc(var(--z-ui) + 10); display: none !important; }
        .rotate-close-hotspot { z-index: calc(var(--z-rotate-warning) + 1); display: none; }
        @media (orientation: portrait) { body.layout-split .rotate-close-hotspot { display: block; } }
        
        #cursor.close-mode { width: 60px; height: 60px; border-color: var(--accent); background: rgba(218, 165, 32, 0.15); }
        #cursor.close-mode::before { content: '‚úï'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: var(--accent); line-height: 1; }
        body.theme-newspaper #cursor.close-mode { border-color: var(--accent); background: rgba(139, 69, 19, 0.15); }
        body.theme-newspaper #cursor.close-mode::before { color: var(--accent); }
        
        .grid-content { padding: 100px 5vw; max-width: 1600px; margin: 0 auto; width: 100%; will-change: transform; transition: transform 0.1s linear; }
        .grid-chapter-section { margin-bottom: 60px; }
        .grid-chapter-title { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); opacity: 0.7; }
        .grid-images-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .grid-image-item { position: relative; aspect-ratio: 4/3; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; background: #111; }
        .grid-image-item:hover { transform: scale(1.02); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 2; }
        .grid-image-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.3s ease; }
        .grid-image-item:hover img { opacity: 0.4; filter: blur(2px); }
        .grid-image-caption { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
        .grid-image-item:hover .grid-image-caption { opacity: 1; }
        .caption-text { color: #fff; text-shadow: 0 0 20px rgba(218, 165, 32, 0.3); background: rgba(0, 0, 0, 0.85); padding: 8px 12px; border-radius: 4px; font-family: 'Crimson Text', serif; font-size: 16px; line-height: 1.4; }
        
        #cursor { position: fixed; top: 0; left: 0; width: 20px; height: 20px; border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 50%; pointer-events: none; z-index: 9999; transform: translate3d(-50px, -50px, 0) translate(-50%, -50%); transition: width 0.25s, height 0.25s, background-color 0.25s, border-color 0.25s, opacity 0.25s; mix-blend-mode: difference; will-change: transform; }
        #cursor.hovering { width: 36px; height: 36px; background-color: rgba(255, 255, 255, 0.08); border-color: var(--accent); }
        #cursor.pointer { width: 14px; height: 14px; background-color: rgba(255, 255, 255, 0.7); }
        #cursor.has-image { opacity: 0; }
        
        .scroll-hint { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: var(--z-ui); opacity: 0; animation: fadeInOut 4s ease-in-out; pointer-events: none; }
        .scroll-hint-icon { width: 24px; height: 24px; border-right: 2px solid rgba(255, 255, 255, 0.4); border-bottom: 2px solid rgba(255, 255, 255, 0.4); transform: rotate(45deg); animation: bounce 1.5s ease-in-out infinite; }
        .scroll-hint-text { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink-3); }
        
        .rotate-warning { position: fixed; inset: 0; z-index: var(--z-rotate-warning); background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; color: var(--accent); }
        .rotate-warning svg { width: 48px; height: 48px; fill: currentColor; margin-bottom: 20px; animation: rotateIcon 2s infinite ease-in-out; }
        .rotate-warning p { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--ink); max-width: 300px; line-height: 1.6; }
        @keyframes rotateIcon { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 75% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @keyframes bounce { 0%, 100% { transform: rotate(45deg) translateY(0); } 50% { transform: rotate(45deg) translateY(8px); } }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
        @media (orientation: portrait) { body.layout-split .rotate-warning { display: flex; } }
        .rotate-warning.visible { display: flex; }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .scroll-progress { display: none; }
            .left-rail { display: flex; padding: 10px 4px; }
            .mobile-bottom-rail { display: none; }
            .mobile-right-rail { display: flex; }
            .mobile-nav-button { width: 36px; height: 36px; }
            .mobile-progress-text { font-size: 9px; }
            .scroll-hint { display: none; }
            .text-layer { padding: 10vh 8vw 20vh; max-width: 90%; }
            .header { padding: 10px 20px; }
            .stream { font-size: clamp(16px, 3vw, 24px); }
            .preview-toggle { display: none; }
        }
        
        @media (max-width: 768px) {
            .scroll-progress { display: none; }
            .left-rail { display: flex; }
            .mobile-bottom-rail { display: flex; }
            .scroll-hint { display: none; }
            .text-layer { padding: 12vh 6vw 20vh 50px; max-width: 95%; }
            .stream { font-size: clamp(16px, 4vw, 28px); }
            .hover-image { width: 800px; height: 600px; }
            .chapter-dropdown { min-width: 240px; left: -10px; }
            .grid-images-container { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .grid-content { padding: 100px 10vw; }
            body.layout-split .text-layer { width: 100%; padding-left: 50px; padding-right: 20px; }
            body.layout-split .hover-image { position: absolute; left: 50%; top: 50%; width: 800px; height: 600px; transform: translate(-50%, -50%) scale(0.95); }
            /* Cursor hidden on touch via JS detection, but add media query safety */
            @media (pointer: coarse) { #cursor { display: none !important; } }
            * { -webkit-tap-highlight-color: rgba(218, 165, 32, 0.2); }
            .nav-button { -webkit-tap-highlight-color: rgba(218, 165, 32, 0.3); }
        }
        
        @media (prefers-reduced-motion: reduce) {
            .edge-blur { backdrop-filter: none; -webkit-backdrop-filter: none; }
            * { animation: none !important; transition: none !important; }
        }
            </style>

</head>
<body>
    <div class="context-menu" id="contextMenu" aria-hidden="true">
        <div class="context-menu-item" id="ctxCopyLink">
            <span class="ctx-icon">üîó</span>
            <span>Copy Link</span>
        </div>
        <div class="context-menu-item" id="ctxShare">
            <span class="ctx-icon">‚Üó</span>
            <span>Share</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxResetProgress">
            <span class="ctx-icon">‚Üª</span>
            <span>Reset to Beginning</span>
        </div>
        <div class="context-menu-item" id="ctxToggleTheme">
            <span class="ctx-icon" id="ctxThemeIcon">‚òÄÔ∏è</span>
            <span id="ctxThemeText">Light Theme</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item context-menu-info">
            <span class="ctx-icon">‚ÑπÔ∏è</span>
            <span>IFIMAYBEFRANK</span>
        </div>
    </div>
    
    <div class="close-hotspot grid-close-hotspot" id="gridCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot split-close-hotspot" id="splitCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    <div class="close-hotspot rotate-close-hotspot" id="rotateCloseHotspot" aria-label="Move cursor here to close (top-right corner)"></div>
    
    <div class="rotate-warning">
        <svg viewBox="0 0 24 24">
            <path d="M4 7.59l5-5c.78-.78 2.05-.78 2.83 0L20 10.76c.78.78.78 2.05 0 2.83L11.83 21.76c-.78.78-2.05.78-2.83 0l-5-5c-.78-.78-.78-2.05 0-2.83L4 7.59zM9 19.17l8.17-8.17L9 2.83 2.83 9 9 19.17zM17 12h-2v2h2v-2zm0-4h-2v2h2V8zm0-4h-2v2h2V4z"/>
        </svg>
        <p>Please rotate your device to landscape for Split View.</p>
    </div>

    <div class="image-grid-overlay" id="imageGridOverlay" aria-hidden="true">
        <div class="grid-content" id="gridContent">
            </div>
    </div>

    <div id="cursor" aria-hidden="true"></div>
    <img id="cursorImage" alt="Preview" aria-hidden="true">
    
    <div class="left-rail" aria-hidden="true">
        <div class="lens-control-container">
            <span class="lens-label">Accessibility</span>
            <div class="accessibility-controls">
                <button class="accessibility-btn" id="accessibilityIncrease" aria-label="Increase accessibility" title="Increase">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
                <div class="accessibility-level" id="accessibilityLevel">
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator active"></div>
                    <div class="level-indicator"></div>
                    <div class="level-indicator"></div>
                </div>
                <button class="accessibility-btn" id="accessibilityDecrease" aria-label="Decrease accessibility" title="Decrease">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <div class="mobile-bottom-rail" aria-label="Mobile navigation">
        <div class="mobile-nav-container">
            <div class="mobile-nav-group">
                <button class="mobile-nav-button" id="mobilePrevSentenceBtn" title="Previous Sentence" aria-label="Previous Sentence">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
                </button>
                <span class="mobile-nav-label">Prev</span>
            </div>
            
            <div class="mobile-progress-container">
                <span class="mobile-progress-text" id="mobileProgressText">0 / 0</span>
                <div class="mobile-progress-bar">
                    <div class="mobile-progress-fill" id="mobileProgressFill"></div>
                </div>
            </div>
            
            <div class="mobile-nav-group">
                <button class="mobile-nav-button" id="mobileNextSentenceBtn" title="Next Sentence" aria-label="Next Sentence">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                </button>
                <span class="mobile-nav-label">Next</span>
            </div>
        </div>
    </div>

    <div class="mobile-right-rail" aria-label="Mobile navigation landscape">
        <div class="mobile-nav-container">
            <div class="rail-top-group"></div>
            <div class="mobile-progress-container">
                <div class="mobile-progress-bar">
                    <div class="mobile-progress-fill" id="landProgressFill"></div>
                </div>
            </div>
            <div class="rail-bottom-group">
                <div class="mobile-nav-group">
                    <button class="mobile-nav-button" id="landPrevBtn" title="Previous Sentence" aria-label="Previous Sentence">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
                    </button>
                </div>
                <div class="mobile-nav-group">
                    <button class="mobile-nav-button" id="landNextBtn" title="Next Sentence" aria-label="Next Sentence">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <header class="header">
        <div class="brand-container">
            <div class="brand" id="brandLogo" aria-label="Open chapter menu">
                <span>If I May Be Frank</span>
                <span class="brand-dropdown-icon">‚ñº</span>
            </div>
            <div class="chapter-dropdown" id="chapterDropdown" aria-hidden="true">
                <div class="chapter-dropdown-header">
                    <h3>Chapters</h3>
                </div>
                <ul class="chapter-dropdown-list" id="chapterDropdownList">
                </ul>
            </div>
        </div>

        <div class="header-right">
            <button class="grid-toggle-btn" id="gridToggleBtn" aria-label="Toggle Image Grid">
                <span>Display</span>
                <span style="font-size: 1.2em;">‚ñ¶</span>
            </button>
            <div class="layout-toggle">
                <button id="layoutToggle" class="layout-button" aria-label="Toggle layout mode" title="Switch layout">
                    <span class="layout-icon layered"></span>
                </button>
            </div>
            <div class="theme-toggle">
                <button id="themeToggle" class="theme-button" aria-label="Toggle theme" title="Switch theme (T)">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>
    </header>

    <div class="edge-blur" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>

    <div class="scroll-progress" aria-label="Navigation controls">
        <button class="nav-button prev-chapter" id="prevChapterBtn" title="Previous Chapter ([)" aria-label="Previous Chapter">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 7.41L10.83 12l4.58 4.59L14 18l-6-6 6-6 1.41 1.41z"/></svg>
        </button>
        <button class="nav-button prev-sentence" id="prevSentenceBtn" title="Previous Sentence (‚Üë/k)" aria-label="Previous Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/></svg>
        </button>
        <div class="scroll-progress-bar-container">
            <div class="scroll-progress-bar" id="scrollProgressBar"></div>
        </div>
        <button class="nav-button next-sentence" id="nextSentenceBtn" title="Next Sentence (‚Üì/j)" aria-label="Next Sentence">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </button>
        <button class="nav-button next-chapter" id="nextChapterBtn" title="Next Chapter (])" aria-label="Next Chapter">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </button>
    </div>

    <div class="scroll-hint" aria-hidden="true">
        <div class="scroll-hint-icon"></div>
        <span class="scroll-hint-text">Scroll ¬∑ Press P ¬∑ Long-press to free scroll</span>
    </div>

    <main class="curved">
        <div class="parallax-container">
            <div id="imageLayer" class="image-layer">
                <div id="hoverImage" class="hover-image" role="tooltip" aria-hidden="true">
                    <img src="" alt="" id="hoverImageImg" loading="lazy">
                </div>
            </div>
            <div id="textLayer" class="text-layer">
                <article class="stream" id="stream" role="article"></article>
            </div>
        </div>
    </main>

    <script>
let isTouch = false;
let lastInteractionWasTouch = false;

window.addEventListener('touchstart', () => { lastInteractionWasTouch = true; isTouch = true; }, { passive: true });
window.addEventListener('mousedown', () => { lastInteractionWasTouch = false; isTouch = false; }, { passive: true });

const TAIL_LENGTH = 12;
const CURSOR_SMOOTHING = 0.35;
const IMAGE_HOVER_DELAY = 120;
const TEXT_PARALLAX_STRENGTH = 0.03;
const IMAGE_PARALLAX_STRENGTH = 0.15;
const CENTER_MAGNET_STRENGTH = 0.25;
const PARALLAX_DAMPING = 0.1;
const SCROLL_THRESHOLD = 30;
const SCROLL_COOLDOWN = 100;
let scrollCooldownActive = false;
let spacebarPressed = false;

let touchStartY = 0;
let touchStartX = 0;
let touchMoved = false;
const LONG_PRESS_DURATION = 500;
const FLICK_THRESHOLD = 50;

const imageMap = {
    'scroll': 'https://i.ibb.co/Y7wVfbfK/DSC08212.webp',
    'void': 'https://i.ibb.co/MZbMqsT/6039d4bbb15be328fc33b54d-IMG-6478.jpg',
    'boredom': 'https://i.ibb.co/m5sNTvYX/603a967916b10d5bef5a6dd8-ZAX02712-1.webp',
    'repeatedly': 'https://i.ibb.co/twyPzFZf/ZAX01304.webp',
    'excess': 'https://i.ibb.co/8njbYh3K/603d0b5635e8053bc120bec7-DSC09034.webp',   
    'most valuable': 'https://i.ibb.co/0yjJ4j8L/603a967a5dc3e982f571b744-ZAX00968.webp',   
    'cooked': 'https://i.ibb.co/L9BB3tR/603a93eedce047078935438a-IMG-5686.jpg',
    'alright': 'https://i.ibb.co/8cFGqNB/6463c90009f6d464ffca5fe3-wellbeaight.jpg',
    'pirated copies of Adobe': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'built my first computer': 'https://i.ibb.co/SwPmvZd8/1-Zpy-OMlmz-Ma0r-Pl-NY-3-KXA.webp',
    'studied typography': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'reading books': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'examining magazines': 'https://i.ibb.co/9mcrj9tg/1-h9lj-VOzz-RT-Irakga-DSWv-Q.webp',
    'faux website concepts': 'https://i.ibb.co/DHHzHw8G/1-pu-HZ09-ELFPd-Aa-MK0-HAxq-Q.webp',
    'Craigslist post': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'cover letter': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'sixteen-fifty an hour': 'https://i.ibb.co/mg5GQc5/1-lm5-BUxr0d-Dq73b-Woi3vy4w.webp',
    'Turn5': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'Xoxide': 'https://i.ibb.co/nNdHf3zM/1-dt-Ggr-Sm7am-TRi-5j-QMVe-Iw.webp',
    'package design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'catalogue design': 'https://i.ibb.co/KJsXgPv/1-dy-MNhi-XFPWPe9og0-dbv-Q.webp',
    'Product Photographer': 'https://i.ibb.co/C38FHDx9/1-FYt-Vic-HKj-LDPLW2rcn-J1u-A.webp',
    'product photographer': 'https://i.ibb.co/C38FHDx9/1-FYt-Vic-HKj-LDPLW2rcn-J1u-A.webp',
    'color match': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'OEM quality': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'photographed thousands': 'https://i.ibb.co/5WSx4J20/1-GFvd-yw-Ap-PELXmtr-Fbx-Vug.webp',
    'web designer': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'banner and display ads': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'email marketing': 'https://i.ibb.co/w581TnW/1-ktn-HKT8-Zg-IADpbe-Byv2bqg.webp',
    'wireframe': 'https://i.ibb.co/NdwrPWfV/1-Na-ZV6rc-Ew-RT55p-R12-BY0jg.webp',
    'user testing': 'https://i.ibb.co/fG0dXSr0/1-m7-Hfhu-QO4-Ugr1-Vte-Zf6it-A.webp',
    'Leadnomics': 'https://i.ibb.co/zhPSN9QQ/1-6-Cxwk-Ywhhn5-Z-FHINfdp-WA.webp',
    'payday loan': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'payday loans': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    '95.8%': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'ninety-five-point-eight percent': 'https://i.ibb.co/RGXh3Zn6/1-HI1b-Kb-Zm-FYVgs3-My-H3wvg.webp',
    'free lunches': 'https://i.ibb.co/27BznHGJ/1-BNs-Ch8k1bclj-KMu1-KN-g.gif',
    'interactive haiku': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'interactive Haiku': 'https://i.ibb.co/8LXV5fSP/1-mn-DJg-S7ab-Si-Pjlzk2-Bxk-TA.webp',
    'One Sixty Over Ninety': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    '160/90': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    '160over90': 'https://i.ibb.co/5gGkM1yF/1-a-QOv-TWfv-Awf6m7-oy-Zy-Gy-A.webp',
    'Interaction Designer': 'https://i.ibb.co/fd8Ycjyv/1-pch6xh-Ep-Fo-Xxli-AGb-Nnr7-Q.webp',
    'Interactive Department': 'https://i.ibb.co/fd8Ycjyv/1-pch6xh-Ep-Fo-Xxli-AGb-Nnr7-Q.webp',
    'lots of nights': 'https://i.ibb.co/SwzHM3CZ/1-o-P6kr-DDq-Pp-Sg-F4-Ag-Fr-WClw.webp',
    'weekends too': 'https://i.ibb.co/SwzHM3CZ/1-o-P6kr-DDq-Pp-Sg-F4-Ag-Fr-WClw.webp',
    'grayscale wireframes': 'https://i.ibb.co/nNLv6NKB/1-CQ-4u-Tk-D6-MUBWABKw-JIZg-A.webp',
    'Kent State': 'https://i.ibb.co/nNLv6NKB/1-CQ-4u-Tk-D6-MUBWABKw-JIZg-A.webp',
    'mega menus': 'https://i.ibb.co/pBYP6wt8/1-HXIU3nxu-ZGq-Ne-Ef3-Wv-Lf-MQ.webp',
    'hamburger icon': 'https://i.ibb.co/s9DPSGLM/1-Vf-C4i592d-OFh-Rbeo-C22ikw.webp',
    'O3 World': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'agile in nature': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'scrum led': 'https://i.ibb.co/fdPcvQHJ/1-H-0uci-Bq6-4k-OUn1-BV-hpg.webp',
    'daily scrums': 'https://i.ibb.co/zTKr9Dh9/1-7w-EKA8du-Scc-OZw-Im-A-6j-SQ.webp',
    'SEI': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'La Colombe': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'Vertex': 'https://i.ibb.co/v6fqJ9b9/1-I-n-HQKs7-BIXo-Y0onf-Nxn-Og.webp',
    'WOVN': 'https://i.ibb.co/mr7gnpTg/1-y-GJCqkzizxa-Uxk3-R5-DCD8g.webp',
    'Workarea': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'Gidget': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'napkin sketches': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'napkins': 'https://i.ibb.co/Y49DcPw2/1-KE8g-FA6w4wud1u-DAr-A4-Yv-Q.webp',
    'Five Foot Gorilla': 'https://i.ibb.co/mjt5Myw/1-l-EJetj-Ut85-CTbb24d-BTFk-A.webp',
    'FlightPath': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'emerging from bankruptcy': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'pharmaceutical sector': 'https://i.ibb.co/3YTzmTm1/1-XT2ea-L5pv1yb49r-o-Jq-Ao-A.webp',
    'WCAG': 'https://i.ibb.co/WpyqgbYQ/1-9-EZTgvxtt-DXOac-Hz-I9axe-Q.gif',
    'Merck': 'https://i.ibb.co/WpyqgbYQ/1-9-EZTgvxtt-DXOac-Hz-I9axe-Q.gif',
    'Cards Against Bad UX': 'https://i.ibb.co/KxyvFKmq/1-P4-Gyqav-HMmzp-A-Ehqy9g-w.webp',
    'jargon-laden spreadsheets': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'single-sided meetings': 'https://i.ibb.co/PRpwWXQ/1-a9to-Sr99x6-Nt-E5-YC7b-Gnzw.webp',
    'As a shopper': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'content manager': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'guest user': 'https://i.ibb.co/6Jf5xj5D/1-Gx-Z4jd-EHO3-IWmhx-Tr-Dff-CA.webp',
    'LiveArea': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'UX Manager': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'one-point-two million': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$1.2m': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'two-thirty-five per hour': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    '$235/hr': 'https://i.ibb.co/VYpfVW1J/1-q6-XH2u-HTIVh-Nd-NY0ab-XW3g.webp',
    'Huge': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'single user flow': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'siloed': 'https://i.ibb.co/7JSWc10M/1-p-XU6-Sp-Y7-Mx-MKiyf-VI-976g.gif',
    'General Nutrition Centers': 'https://i.ibb.co/JwN6TKCH/1-HZ-r-YXa4q-YKau-P1q-Et-K3-LQ.webp',
    'GNC': 'https://i.ibb.co/JwN6TKCH/1-HZ-r-YXa4q-YKau-P1q-Et-K3-LQ.webp',
    'mobile-first navigation': 'https://i.ibb.co/JwN6TKCH/1-HZ-r-YXa4q-YKau-P1q-Et-K3-LQ.webp',
    'Elva': 'https://i.ibb.co/JwN6TKCH/1-HZ-r-YXa4q-YKau-P1q-Et-K3-LQ.webp',
    'Notes': 'https://i.ibb.co/XrxGt0D4/1-UATKEet6-Vtc-Lk-A8r-Yspj-FQ.webp',
    'mental notes': 'https://i.ibb.co/XrxGt0D4/1-UATKEet6-Vtc-Lk-A8r-Yspj-FQ.webp',
    'Hypothesis': 'https://i.ibb.co/hFxVPkN9/1-Ex-Xe-Zp-Pz-Cw-C4-QKjx3-Fp-J-Q.webp',
    'Setting up for success': 'https://i.ibb.co/VWjMBKyJ/1-bd-or-S3kj2g-Ul-Or1-T0cp-Xw.webp',
    'Roadmap': 'https://i.ibb.co/jkzBy6JF/1-qplrq-W-v-Dn7-Rkr-XIQYYm-Q.webp',
    'Iteration': 'https://i.ibb.co/0RTCJshv/1-q-GUMUAN-NA1-FY2gm8knong.webp',
    'Innovation': 'https://i.ibb.co/hF26Bg3H/1-Sl-Zx-RIiu-Ds1k-Q19me-Imf-Q.webp',
    'Optimization': 'https://i.ibb.co/HT0xKhzF/1-HRsg-XZNL-WJf4-Xj-J-O75-Bg.webp',
    'Refinement': 'https://i.ibb.co/mC4dJwfG/1-7e7-U6-ZN5-HC-zd-Qzm1t-Sb-Gg.webp',
    'Gains': 'https://i.ibb.co/Y4BS0p8f/1-LCDr-FFlm-X0-F1-Rasve-Rsrv-A.webp',
    'Code and Theory': 'https://i.ibb.co/jP8rS95G/1-5g-Mvv7027-cm7r0vm-IDy1-A.webp',
    'Code & Theory': 'https://i.ibb.co/jP8rS95G/1-5g-Mvv7027-cm7r0vm-IDy1-A.webp',
    '62nd Floor': 'https://i.ibb.co/k22XR8x5/1-t-Vlq3-Svyk-Yb9-EM5yd-Nlcg-A.webp',
    'World One Trade Center': 'https://i.ibb.co/k22XR8x5/1-t-Vlq3-Svyk-Yb9-EM5yd-Nlcg-A.webp',
    'ACD': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'Senior Designer': 'https://i.ibb.co/99qqJkRJ/1-aso-Tm-Z5c-V3-Zkodr-Mcu-Yjig.webp',
    'wow factor': 'https://i.ibb.co/h1fn9fxc/1-Iy-n-WY-5d-Nz-Lniq7v-HVg-Iw.webp',
    'post mortem': 'https://i.ibb.co/h1fn9fxc/1-Iy-n-WY-5d-Nz-Lniq7v-HVg-Iw.webp',
    'Publicis Sapient': 'https://i.ibb.co/jkpcGvMF/1-f-TX-d-BN7l7of-M3nf-KU7p8g.webp',
    'Digital Transformation': 'https://i.ibb.co/jkpcGvMF/1-f-TX-d-BN7l7of-M3nf-KU7p8g.webp',
    'Organizational Spaghetti': 'https://i.ibb.co/jkpcGvMF/1-f-TX-d-BN7l7of-M3nf-KU7p8g.webp',
    'de facto Team Lead': 'https://i.ibb.co/rR74bLkf/1-o-XV3b-GDEf-TKoh-Ue-ICCjc1-A.webp',
    'Product Owner': 'https://i.ibb.co/rR74bLkf/1-o-XV3b-GDEf-TKoh-Ue-ICCjc1-A.webp',
    'company paid lunches': 'https://i.ibb.co/v4q7TbDZ/1-t-Yd-DX2-Ql-VLw-XI7gm3ev-MLw.webp',
    'exhaustive research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'industry research': 'https://i.ibb.co/XrpnL50W/1-x-Qoqr-V021-PFk0sxts5-AWAg.webp',
    'consistent presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'in-office presence': 'https://i.ibb.co/fdW3K2gp/1-1gjr-Eff-Bio-JYo-EAv-MWHf-KQ.webp',
    'client workshops': 'https://i.ibb.co/XfXGRWZ5/1-RTEI5a-Ccw31fj-Fzqj-Bg-FEg.webp',
    'Design Systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'design systems': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'data paradigm': 'https://i.ibb.co/4wtq5p9V/1-g-C-cm-PMo-CAMgckq051lw-Zg.webp',
    'Pershing X': 'https://i.ibb.co/B2V4Skt5/1-Oen-HCQm-Ga10wp-Cz-R8o9-Pt-A.webp',
    'BNY Mellon': 'https://i.ibb.co/B2V4Skt5/1-Oen-HCQm-Ga10wp-Cz-R8o9-Pt-A.webp',
    'networking': 'https://i.ibb.co/sJkpkV9Q/1-l4jg-O1-4g-Ey-Wy-IBEQZho0g.webp',
    'RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'terminate an RJ45': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    '30‚Äì45 seconds': 'https://i.ibb.co/ZR7Tb6YW/1-b-Q-s-X24b-Qk-Utx50-Q5j-MZNg.webp',
    'Run cables': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'security systems': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'cable management': 'https://i.ibb.co/fdvw7XLN/1-PGk-VR2s-OAfc-Kk5kk-Trn-Qdw.webp',
    'twist parity': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'different parts of my brain': 'https://i.ibb.co/2YMPHshQ/1-3gn-Cq0a4-Kb-Y8-MGJy-VKy-P-A.webp',
    'sees potential': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'someone out there': 'https://i.ibb.co/4Rfyq6Z8/1-S3-L6-fci-CRNsv-Vq-Pk8-NRA.webp',
    'mouths to feed': 'https://i.ibb.co/gpr7smN/1-Zs0lu-PIi-C5ly-AOEo2-LLEl-A.webp',
    'left-handed': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'think different': 'https://i.ibb.co/DDw627yH/1-A-KU6r-Bmxccz-M6m1-Hxdkg.webp',
    'play guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'guitar': 'https://i.ibb.co/MyqYv5cS/1-RLgidsi-DWtxpf-Y4y52-WLWA.webp',
    'take photographs': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'photography': 'https://i.ibb.co/tP1YpWFG/1-f-R6-Yh5w77l-Iv-Sg-R4ldzj-TA.webp',
    'Wolfgang': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'my dog': 'https://i.ibb.co/tTTgw7Md/1-q-zg-Zh-Kn-Cs6ab-K8-CIp-E00-Q.webp',
    'Bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'bootstrap startup': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'non-linear': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'career journey': 'https://i.ibb.co/psftCmn/1-sq-USg-c1x-GQx-Zd-QS4-L7f-Sw.webp',
    'A-list brands': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp',
    'global scale': 'https://i.ibb.co/840YDJMT/1-6ft-VCi9-Pi-L1q47-Vskw-Mb-WA.webp'
};

const chapters = [
    { id: 0, title: "Hello World", startText: "The year is 2026" },
    { id: 1, title: "Early Years", startText: "Convention" },
    { id: 2, title: "First Steps", startText: "I built my first computer" },
    { id: 3, title: "Turn5 / Xoxide", startText: "Alright. Now, where to begin?" },
    { id: 4, title: "Leadnomics", startText: "Okay, so Leadnomics was shifty." },
    { id: 5, title: "Learning to Code", startText: "From here, I desired to move" },
    { id: 6, title: "One Sixty Over Ninety", startText: "One Sixty Over Ninety‚Äî" },
    { id: 7, title: "O3 World", startText: "An elevating experience with O3 World" },
    { id: 8, title: "FlightPath", startText: "Did I mention I co-founded" },
    { id: 9, title: "LiveArea", startText: "A paradigm shift: From Midtown to Uptown." },
    { id: 10, title: "Huge", startText: "At Huge, I couldn't tell you" },
    { id: 11, title: "Elva / GNC", startText: "Heavy lift. Big gains. This is the whey." },
    { id: 12, title: "Code and Theory", startText: "It's a long way to the top" },
    { id: 13, title: "Publicis Sapient", startText: "Okay, fine. Huge only wanted me" },
    { id: 14, title: "The Twist", startText: "Come on, baby. Let's do the twist." },
    { id: 15, title: "Conclusion", startText: "As an aside, I've been keeping up" }
];

const narrative = `The year is 2026, and folks still need to be told to scroll. But alas, to what avail? To wander into the void‚Äîblinded by the light? To aimlessly interact with that which disinterests us‚Äîor worse yet‚Äîoffends us with boredom? Repeatedly. Masochism by minimalism in excess. A world where delineation dissolves between Most Valuable, or Minimally Viable?.

[asf] Convention? Conviction? Convection? Are we cooked? We'll be alright. This is what I am doing about it. This is what I have to show and to say. This is my approach.


[I built my first computer circa 2005 to '06.] I immediately installed pirated copies of Adobe Photoshop and Illustrator. While I didn't study at university, I studied what I saw. Whatever piqued my interest, I looked at, intensely. I studied typography‚Äîreading books, examining magazines, and generally observing what I saw wherever I were. I studied color theory and sought online tutorials that taught me how to master the tools I had at my disposal. I began to create faux website concepts to gain an understanding of designing for that medium. I also learned the proper etiquette towards finding gainful employment. All this culminated with an interview from a Craigslist post. I can still pull up my original cover letter. Here, I was brought on as a graphic designer, full-time. You have no idea how happy I was. I was set to make sixteen-fifty an hour, plus full benefits, a 401K, and have my own cubicle. [Alright. Now, where to begin?] I'd just been brought into the fold with a budding home-grown startup. Turn5 had set up its new HQ at a warehouse office facility in Great Valley, PA‚Äîabout twenty miles outside of Philly‚Äîowned and operated by two brothers; one of which wasn't even old enough to drink at the company holiday party. I had been provided a brand new PC replete with a dual-screen monitor setup and a Canon Rebel DSLR. I became graphic designer for all web properties, graphic designer for all print initiatives including package design and catalogue design, Product Photographer specializing in lighting and establishing systematic protocols for visual uniformity at scale. We photographed thousands of parts, with customization at the heart of what we sold‚Äîcountless product permutations. We had to color match perfectly to mimic OEM quality, ensuring our product photography looked consistent through print and digital media alike. Having passed the torch of photography duties onto a true professional, I was able to focus on email marketing and feature design. Working with analytical data helped to inform top-level site design changes. It was at this point, I graduated from graphic designer to web designer. [Okay, so Leadnomics was shifty.] Paradigm shifty, we'll say. It was a great place to work though‚ÄîI have lasting friendships with folks I worked with there. Our work fed upon the uneducated and disenfranchised, in some respects. Our focus was in lead generation. Our cash cow was in facilitating easy access to payday loans. But we had free lunches, regular bonuses, company outings. In short, my job was to make it intuitive and stress free‚Äîdaresay pleasant‚Äîfor one to make catastrophic financial decisions at a scale in tens of thousands per month. I had a ninety-five-point-eight percent conversion rate with a bounce rate lower than 15%. This wasn't magic. This was the result of introducing Responsive Web Design practices via Twitter's Bootstrap ethos, while backed by thoughtful action and solutioning based on analytical data and insights drawn from user testing and A/B split-testing. We fashioned a helluva good fishing net. [From here, I desired to move my creative talents into an environment where I was happy to share and expound upon.] There was a period between Leadnomics and 160over90, where I was recovering from a catastrophically comminuted clavicle injury. During my down time, I determined that my best chance at landing an agency job, was if I could prove I understood the ins-and-outs of web design. So, I learned how to code HTML, CSS, and throw in a little Javascript to make the magic happen. I did this by concepting an interactive Haiku, which communicated in various ways, the things I wished to convey. [One Sixty Over Ninety‚Äî] my heart rate when I was offered a full-time gig as an Interaction Designer working at a leading design agency at the literal epicenter of Center City, Philadelphia. Granted, I accepted the job at approximately twelve-thousand less than I was at my previous start-up, but I was one of two interactive designers hired to fulfill the needs of the newly minted Interactive Department at the 160/90 HQ. There were lots of nights, weekends too. When waterfall process meets business-minded clients with exceptional aspirations meets unmanaged expectations meets crunch time‚Äîwell, compromises happen. We explored grayscale wireframes that looked like design. We explored mega menus and full-screen takeovers. We pondered if the hamburger icon was intuitive enough‚Äîremember, this was circa 2014 when these were legitimate questions. Interactive Designers at 160/90 were responsible for IA, UX, and Visual Design. [An elevating experience with O3 World,] a digital product shop based in Fishtown, Philadelphia. Wireframes at 160over90 fit the workflow there. Wireframing at O3 World was different‚Äîreverting to the basics. Here, it was less about impressing our clients. Here, it was all about working with our clients. We were agile in nature and scrum led. We had daily scrums and weekly sprint schedules. We dealt with client feedback organically, and responsively, as opposed to reactively. Clients included Vertex, SEI, La Colombe, and WOVN. [Did I mention I co-founded a two-person strong design agency] that existed for about six months before I dissolved it in favor of gaining bona fide NYC-grade agency experience? My business partner, while brilliant, was unpredictable. Anyway, Five Foot Gorilla was stout, resolute, strong‚Äîand with good humor. But FlightPath presented an intriguing opportunity. Recently emerging from bankruptcy, the agency had drastically downsized. It wasn't lucrative‚Äîthe pay was passable at best. But for me, the allure lay in the chance to immerse myself in the New York agency scene. Operating in the pharmaceutical sector, these clients demanded design solutions that adhered to WCAG compliance standards and underwent rigorous scrutiny from legal and regulatory authorities. Work with Merck, Zoetis, Charter. I was let-go on the day of my one-year annual review. I had been commuting to-and-from Philadelphia and New York daily. I had accomplished exactly what I had set out to do. [A paradigm shift: From Midtown to Uptown.] From Individual Contributor to UX Manager. At LiveArea, I was the UX Manager assigned to contracts exceeding one-point-two million in value. My hourly billable rate to the client was something like two-thirty-five per hour. Everything I did had a direct impact on the final deliverable. What do you do when you're working with a sophisticated client with a tremendously complex product line, who while fluent with their industry acumen, were completely unfamiliar with the design process? When jargon-laden spreadsheets and single-sided meetings net nothing but frustration to the point where they're considering abandoning the contract? Enter, Cards Against Bad UX. All I did was simplify what we asked‚Äîto shift the conversation away from technical jargon towards user-centric thinking. By providing different perspectives such as "As a shopper" or "As a content manager" or "As a guest user", I was able to help our stakeholders empathize with their end-users. [At Huge, I couldn't tell you what my billable rate was,] but I could say this was the first time I had seen a project with at least twenty different people involved‚Äîon just the agency side. At Huge, I was responsible for exploring a single user flow. There were other designers responsible for exploring other individual user flows. At no point during my time with Huge did I even know there were other designers on that project. To say we were siloed would be a gross understatement. Being completely candid, I get it. This was a mere contract position. [Heavy lift. Big gains. This is the whey.] Enter, Elva Design Group‚Äîa boutique design agency based in San Francisco specializing in Shopify e-commerce builds, and I was just resourced to their newest client, General Nutrition Centers. I was responsible for leading discovery and requirements gathering. GNC Leadership wanted to shake things up, so we fashioned a mobile-first navigation schema with conventional fall-backs. We didn't have the time, infrastructure, or budget to perform exhaustive fool-proof design, but rather execute foolhardy decisions in favor of shaking things up. The result? GNC was able to relaunch their brand and reinvigorate consumer interest by focusing their efforts on a modernized and optimized online shopping experience. [It's a long way to the top if you want to rock and roll.] I interviewed for an ACD, Interactive position at Code and Theory and was immediately hired on a freelance basis as a Senior Designer, with the intention of fulfilling the ACD responsibilities. I quickly proved my worth and was transitioned to full-time employment. The project was led by a Directly Responsible Individual, but whom accepted a Director-level position elsewhere three months into the project. There were also the departure of several key team members, which placed additional responsibilities on my shoulders. Besides resourcing hurdles, there were issues spanning practicality and pragmatism, suffice to say. Despite offering to improve internal education initiatives and providing proactive feedback, I was let go from Code and Theory without explanation. It was a challenging experience, but one that taught me valuable lessons about the realities of working in a large agency environment. [Okay, fine. Huge only wanted me for a little bit.] Code and Theory wasn't ready for me. I don't necessarily care to be a boomerang in my career. Now, where can I go that won't be a lateral or backwards step? Enter Publicis Sapient, a Digital Transformation Company. I can tell you that I spent a full year here working in the Financial Services sector serving BNY Mellon‚ÄîPershing X. I became the de facto Team Lead and Product Owner. I led research and discovery efforts. I led client workshops. I led design and prototype development and testing. I collaborated across multiple concurrent tracks, while providing mentorship and guidance to junior and associate designers. I set my team up for success daily, conducting exhaustive research and socializing of knowledge. My efforts were directly responsible for securing a contract extension leading into the next fiscal year. This was the most sophisticated work I've done in my career, and despite putting an incredible effort into it, corporate will do what corporate will do. I was laid off, or otherwise separated amicably as my exit contract states. [Come on, baby. Let's do the twist.] In the world of Low Voltage Data Installation, some terminations require a very specific twist parity, lest you run risk of signal impedance. I've been networking‚Äîpun intended. I've taken on sub-contractor gigs and learned new hands-on skills. I can now terminate an RJ45 in thirty to forty-five seconds. I can run cables and install security systems and setup indoor/outdoor digital displays. No problem. My passion for creative output is unrelenting, though I'm using different parts of my brain to make due. I still have my eyes set on elevating my career in a paradigm changing way. Maybe someone out there sees potential. [As an aside, I've been keeping up with the latest happenings in the world of Artificial Intelligence.] I am absolutely unequivocally NOT worried about the thinking machines taking over jobs, or the world for that matter. I truly try not to be the type of person to sway your mind one way or another, so I'll refrain from writing any sort of conclusion. If my photography or music are any indicator, it's that my true talent‚Äîmy special sauce‚Äîis in presenting ideas in a way that uplifts and encourages imagination. Put simply, I yearn to make folks wonder and I do this with capable hands. I think. I make. Will work for work.`;

const state = { hoveredSentence: null, expandedBrackets: new Set(), mouseX: 0, mouseY: 0, imageTimeout: null, imageActive: false, currentTriggerRect: null, layoutMode: 'layered', currentSentenceIndex: -1, currentChapterIndex: 0, allSentenceElements: [], chapterStartIndices: [], previewMode: 'background', gridImages: [] };

let mouseX = 0, mouseY = 0, currentImageElement = null;
let textParallaxX = 0, textParallaxY = 0, targetTextParallaxX = 0, targetTextParallaxY = 0;
let imageParallaxX = 0, imageParallaxY = 0, targetImageParallaxX = 0, targetImageParallaxY = 0;

const phraseRegexMap = new Map();
for (const phrase of Object.keys(imageMap)) {
    const escapedPhrase = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    phraseRegexMap.set(phrase, new RegExp(`\\b${escapedPhrase}\\b`, 'gi'));
}

function getCurrentChapter() {
    if (state.allSentenceElements.length === 0) return 0;
    for (let i = chapters.length - 1; i >= 0; i--) {
        if (state.currentSentenceIndex >= state.chapterStartIndices[i]) return i;
    }
    return 0;
}

function parseNarrative(text) {
    const parts = [];
    let idCounter = 0;
    const segments = text.split(/(\[|\])/);
    let inBracket = false;
    let bracketId = null;
    
    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        if (segment === '[') {
            inBracket = true;
            bracketId = idCounter++;
            parts.push({ type: 'bracket', id: bracketId, content: '' });
        } else if (segment === ']') {
            inBracket = false;
            bracketId = null;
        } else if (segment.length > 0) {
            if (inBracket && bracketId !== null) {
                const bracket = parts.find(p => p.id === bracketId);
                if (bracket) bracket.content = segment.trim();
            } else {
                const sentences = segment.split(/(?<=[.!?])\s+/);
                sentences.forEach(sentence => {
                    if (sentence.trim()) parts.push({ type: 'sentence', id: idCounter++, text: sentence.trim() });
                });
            }
        }
    }
    return parts;
}

function wrapImageTriggers(text) {
    let wrapped = text;
    for (const [phrase, url] of Object.entries(imageMap)) {
        const regex = phraseRegexMap.get(phrase);
        if (regex) wrapped = wrapped.replace(regex, `<span class="image-trigger" data-image="${url}">$&</span>`);
    }
    return wrapped;
}

function preloadImages() {
    const imageUrls = [...new Set(Object.values(imageMap))];
    imageUrls.forEach(url => { const img = new Image(); img.src = url; });
}

function showImage(imageUrl, triggerElement) {
    currentImageElement = triggerElement;
    state.imageActive = true;
    state.currentTriggerRect = triggerElement.getBoundingClientRect();
    document.body.classList.add('image-active');
    
    if (state.previewMode === 'cursor') {
        const cursorImage = document.getElementById('cursorImage');
        const cursor = document.getElementById('cursor');
        cursorImage.src = imageUrl;
        cursorImage.classList.add('active');
        cursor.classList.add('has-image');
    } else {
        const hoverImage = document.getElementById('hoverImage');
        const hoverImageImg = document.getElementById('hoverImageImg');
        if (state.imageTimeout) clearTimeout(state.imageTimeout);
        state.imageTimeout = setTimeout(() => {
            hoverImageImg.onload = () => hoverImage.classList.add('active');
            hoverImageImg.onerror = () => hoverImage.classList.add('active');
            hoverImageImg.src = imageUrl;
        }, IMAGE_HOVER_DELAY);
    }
}

function hideImage() {
    const hoverImage = document.getElementById('hoverImage');
    const cursorImage = document.getElementById('cursorImage');
    const cursor = document.getElementById('cursor');
    if (state.imageTimeout) clearTimeout(state.imageTimeout);
    hoverImage.classList.remove('active');
    cursorImage.classList.remove('active');
    cursorImage.classList.remove('enlarged');
    cursor.classList.remove('has-image');
    document.body.classList.remove('image-active');
    state.imageActive = false;
    currentImageElement = null;
    state.currentTriggerRect = null;
}

function toggleImageSize() {
    if (!state.imageActive || state.previewMode !== 'cursor') return;
    document.getElementById('cursorImage').classList.toggle('enlarged');
}

function isDropdownOpen() { return document.getElementById('chapterDropdown').classList.contains('open'); }
function isGridOpen() { return document.getElementById('imageGridOverlay').classList.contains('open'); }

function handleScroll(event) {
    if (scrollCooldownActive) return;
    if (event.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) {
         event.preventDefault();
         return; 
    }
    if (isGridOpen()) return;
    
    const scrollDelta = event.deltaY;
    if (Math.abs(scrollDelta) >= SCROLL_THRESHOLD) {
        scrollCooldownActive = true;
        if (scrollDelta > 0) nextSentence(); else previousSentence();
        setTimeout(() => { scrollCooldownActive = false; }, SCROLL_COOLDOWN);
    }
    event.preventDefault();
}

function handleTouchStart(e) {
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
    touchMoved = false;
}

function handleTouchMove(e) {
    touchMoved = true;
    if (e.target.closest('.chapter-dropdown-list, .image-grid-overlay')) return;
    if (isDropdownOpen()) { e.preventDefault(); return; }
    if (isGridOpen()) return;
    e.preventDefault();
}

function handleTouchEnd(e) {
    if (!touchMoved || scrollCooldownActive || isDropdownOpen() || isGridOpen()) return;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaY = touchStartY - touchEndY;
    if (Math.abs(deltaY) > FLICK_THRESHOLD) {
        scrollCooldownActive = true;
        if (deltaY > 0) nextSentence(); else previousSentence();
        setTimeout(() => { scrollCooldownActive = false; }, SCROLL_COOLDOWN);
    }
}

function nextSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex + 1) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function previousSentence() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = (state.currentSentenceIndex - 1 + state.allSentenceElements.length) % state.allSentenceElements.length;
    highlightSentence(state.currentSentenceIndex);
}

function highlightSentence(index) {
    const sentence = state.allSentenceElements[index];
    if (!sentence) return;
    
    state.allSentenceElements.forEach(s => { s.classList.remove('active'); s.classList.add('dimmed'); });
    sentence.classList.add('active');
    sentence.classList.remove('dimmed');
    
    updateScrollProgress();
    updateChapterDropdown();
    
    sentence.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    const imageTrigger = sentence.querySelector('.image-trigger');
    if (imageTrigger) {
        const imageUrl = imageTrigger.getAttribute('data-image');
        if (imageUrl) showImage(imageUrl, imageTrigger);
    } else {
        hideImage();
    }
}

function goToChapter(chapterId) {
    const startIndex = state.chapterStartIndices[chapterId];
    if (startIndex !== undefined) {
        state.currentSentenceIndex = startIndex;
        highlightSentence(startIndex);
        closeChapterDropdown();
    }
}

function nextChapter() {
    const currentChapter = getCurrentChapter();
    if (currentChapter < chapters.length - 1) goToChapter(currentChapter + 1);
}

function previousChapter() {
    const currentChapter = getCurrentChapter();
    if (currentChapter > 0) goToChapter(currentChapter - 1);
}

function updateScrollProgress() {
    const progressBar = document.getElementById('scrollProgressBar');
    const mobileProgressFill = document.getElementById('mobileProgressFill');
    const mobileProgressText = document.getElementById('mobileProgressText');
    const landProgressFill = document.getElementById('landProgressFill');
    
    const total = state.allSentenceElements.length;
    const current = state.currentSentenceIndex + 1;
    const progress = (current / total) * 100;
    
    if (progressBar) progressBar.style.height = `${progress}%`;
    if (mobileProgressFill) mobileProgressFill.style.width = `${progress}%`;
    if (landProgressFill) landProgressFill.style.height = `${progress}%`;
    if (mobileProgressText) mobileProgressText.textContent = `${current} / ${total}`;
}

function resetToBeginning() {
    if (state.allSentenceElements.length === 0) return;
    state.currentSentenceIndex = 0;
    highlightSentence(0);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateParallax() {
    const viewportCenterX = window.innerWidth / 2;
    const viewportCenterY = window.innerHeight / 2;
    const mouseOffsetX = (mouseX - viewportCenterX) / viewportCenterX;
    const mouseOffsetY = (mouseY - viewportCenterY) / viewportCenterY;
    
    targetTextParallaxX = mouseOffsetX * 20 * TEXT_PARALLAX_STRENGTH;
    targetTextParallaxY = mouseOffsetY * 20 * TEXT_PARALLAX_STRENGTH;
    
    if (state.imageActive && state.currentTriggerRect) {
        const trigger = state.currentTriggerRect;
        const triggerCenterX = trigger.left + trigger.width / 2;
        const triggerCenterY = trigger.top + trigger.height / 2;
        const distToCenterX = (viewportCenterX - triggerCenterX) / viewportCenterX;
        const distToCenterY = (viewportCenterY - triggerCenterY) / viewportCenterY;
        const magnetX = distToCenterX * CENTER_MAGNET_STRENGTH * 100;
        const magnetY = distToCenterY * CENTER_MAGNET_STRENGTH * 100;
        
        targetImageParallaxX = (mouseOffsetX * 100 * IMAGE_PARALLAX_STRENGTH) - magnetX;
        targetImageParallaxY = (mouseOffsetY * 100 * IMAGE_PARALLAX_STRENGTH) - magnetY;
    } else {
        targetImageParallaxX = 0;
        targetImageParallaxY = 0;
    }
    
    textParallaxX += (targetTextParallaxX - textParallaxX) * PARALLAX_DAMPING;
    textParallaxY += (targetTextParallaxY - textParallaxY) * PARALLAX_DAMPING;
    imageParallaxX += (targetImageParallaxX - imageParallaxX) * PARALLAX_DAMPING;
    imageParallaxY += (targetImageParallaxY - imageParallaxY) * PARALLAX_DAMPING;
    
    const textLayer = document.getElementById('textLayer');
    const imageLayer = document.getElementById('imageLayer');
    const gridOverlay = document.getElementById('gridContent');
    
    if (textLayer) textLayer.style.transform = `translate3d(${textParallaxX}px, ${textParallaxY}px, 0)`;
    if (imageLayer) imageLayer.style.transform = `translate3d(${imageParallaxX}px, ${imageParallaxY}px, 0)`;
    if (gridOverlay) gridOverlay.style.transform = `translate3d(${imageParallaxX * 0.5}px, ${imageParallaxY * 0.5}px, 0)`;
    
    requestAnimationFrame(updateParallax);
}

function buildChapterDropdown() {
    const dropdownList = document.getElementById('chapterDropdownList');
    dropdownList.innerHTML = '';
    
    chapters.forEach(chapter => {
        const startIndex = state.chapterStartIndices[chapter.id];
        const endIndex = chapter.id < chapters.length - 1 ? state.chapterStartIndices[chapter.id + 1] : state.allSentenceElements.length;
        const li = document.createElement('li');
        li.className = 'chapter-item';
        li.dataset.chapterId = chapter.id;
        li.innerHTML = `<span class="chapter-item-number">${String(chapter.id + 1).padStart(2, '0')}</span><span class="chapter-item-title">${chapter.title}</span><span class="chapter-item-progress">${endIndex - startIndex} sentences</span>`;
        li.addEventListener('click', () => goToChapter(chapter.id));
        dropdownList.appendChild(li);
    });
}

function updateChapterDropdown() {
    const currentChapter = getCurrentChapter();
    const items = document.querySelectorAll('.chapter-item');
    items.forEach(item => {
        const chapterId = parseInt(item.dataset.chapterId);
        if (chapterId === currentChapter) {
            item.classList.add('active');
            if (isDropdownOpen()) item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            item.classList.remove('active');
        }
    });
}

function toggleChapterDropdown() {
    const brand = document.getElementById('brandLogo');
    const dropdown = document.getElementById('chapterDropdown');
    brand.classList.toggle('open');
    dropdown.classList.toggle('open');
    if (dropdown.classList.contains('open')) updateChapterDropdown();
}

function closeChapterDropdown() {
    document.getElementById('brandLogo').classList.remove('open');
    document.getElementById('chapterDropdown').classList.remove('open');
}

function toggleImageGrid() {
    const overlay = document.getElementById('imageGridOverlay');
    const btns = document.querySelectorAll('.grid-toggle-btn');
    
    if (overlay.classList.contains('open')) {
        overlay.classList.remove('open');
        document.body.classList.remove('grid-open');
        document.body.style.overflow = '';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '‚ñ¶');
    } else {
        overlay.classList.add('open');
        document.body.classList.add('grid-open');
        document.body.style.overflow = 'hidden';
        btns.forEach(btn => btn.querySelector('span:last-child').textContent = '‚úï');
        buildImageGrid();
    }
}

function buildImageGrid() {
    const content = document.getElementById('gridContent');
    content.innerHTML = '';
    const imagesByChapter = {};
    state.gridImages.forEach(imgData => {
        if (!imagesByChapter[imgData.chapterId]) imagesByChapter[imgData.chapterId] = [];
        imagesByChapter[imgData.chapterId].push(imgData);
    });
    
    chapters.forEach(chapter => {
        if (imagesByChapter[chapter.id] && imagesByChapter[chapter.id].length > 0) {
            const section = document.createElement('div');
            section.className = 'grid-chapter-section';
            section.innerHTML = `<div class="grid-chapter-title">Chapter ${String(chapter.id + 1).padStart(2, '0')} ¬∑ ${chapter.title}</div>`;
            const grid = document.createElement('div');
            grid.className = 'grid-images-container';
            
            imagesByChapter[chapter.id].forEach(imgData => {
                const item = document.createElement('div');
                item.className = 'grid-image-item';
                item.innerHTML = `<img src="${imgData.url}" loading="lazy" alt="Grid preview"><div class="grid-image-caption"><span class="caption-text">${imgData.text}</span></div>`;
                item.addEventListener('click', () => { toggleImageGrid(); state.currentSentenceIndex = imgData.index; highlightSentence(imgData.index); });
                grid.appendChild(item);
            });
            section.appendChild(grid);
            content.appendChild(section);
        }
    });
}

function render() {
    const streamEl = document.getElementById('stream');
    const parsedContent = parseNarrative(narrative);
    const fragment = document.createDocumentFragment();
    state.allSentenceElements = [];
    state.gridImages = [];
    
    let sentenceCount = 0;
    state.chapterStartIndices = new Array(chapters.length).fill(0);
    let nextChapterIndex = 0;
    let currentActiveChapter = 0;

    parsedContent.forEach(part => {
        if (nextChapterIndex < chapters.length) {
            const nextChapter = chapters[nextChapterIndex];
            const textContent = part.type === 'sentence' ? part.text : part.content;
            if (textContent.includes(nextChapter.startText.replace(/^\[/, ''))) {
                state.chapterStartIndices[nextChapter.id] = sentenceCount;
                const chapterBreak = document.createElement('div');
                chapterBreak.className = 'chapter-break';
                chapterBreak.dataset.chapterId = nextChapter.id;
                chapterBreak.innerHTML = `<span class="chapter-number">Chapter ${String(nextChapter.id + 1).padStart(2, '0')}</span><span class="chapter-title">${nextChapter.title}</span>`;
                chapterBreak.addEventListener('click', () => goToChapter(nextChapter.id));
                fragment.appendChild(chapterBreak);
                currentActiveChapter = nextChapter.id;
                nextChapterIndex++;
            }
        }

        if (part.type === 'sentence') {
            const span = document.createElement('span');
            span.className = 'sentence';
            span.dataset.sentenceIndex = sentenceCount;
            span.style.cursor = 'pointer';
            
            for (const [phrase, url] of Object.entries(imageMap)) {
                if (part.text.includes(phrase)) {
                    state.gridImages.push({ index: sentenceCount, text: part.text, url: url, chapterId: currentActiveChapter });
                    break;
                }
            }

            span.innerHTML = wrapImageTriggers(part.text) + ' ';
            if (state.hoveredSentence === part.id) span.classList.add('active');
            else if (state.hoveredSentence !== null) span.classList.add('dimmed');
            
            span.addEventListener('mouseenter', () => {
                const index = parseInt(span.dataset.sentenceIndex);
                state.allSentenceElements.forEach((s, i) => s.style.opacity = i === index ? '0.7' : '0.25');
            }, { passive: true });
            span.addEventListener('mouseleave', () => state.allSentenceElements.forEach(s => s.style.opacity = ''), { passive: true });
            span.addEventListener('click', () => { state.currentSentenceIndex = parseInt(span.dataset.sentenceIndex); highlightSentence(state.currentSentenceIndex); });
            
            state.allSentenceElements.push(span);
            sentenceCount++;
            fragment.appendChild(span);
        } else if (part.type === 'bracket') {
            const trigger = document.createElement('button');
            trigger.className = 'bracket-trigger';
            trigger.textContent = '[+]';
            const contentId = `bracket-content-${part.id}`;
            trigger.setAttribute('aria-controls', contentId);
            
            const content = document.createElement('span');
            content.className = 'bracket-content';
            content.id = contentId;
            content.textContent = ' ' + part.content + ' ';
            
            trigger.addEventListener('click', () => {
                const isExpanded = content.classList.toggle('visible');
                trigger.textContent = isExpanded ? '[‚àí]' : '[+]';
                trigger.classList.toggle('expanded');
                if (isExpanded) state.expandedBrackets.add(part.id); else state.expandedBrackets.delete(part.id);
            });
            
            fragment.appendChild(trigger);
            fragment.appendChild(content);
        }
    });
    
    streamEl.innerHTML = '';
    streamEl.appendChild(fragment);
    buildChapterDropdown();
    
    streamEl.addEventListener('mouseover', e => {
        const trigger = e.target.closest('.image-trigger');
        if (trigger) {
            const imageUrl = trigger.getAttribute('data-image');
            if (imageUrl) showImage(imageUrl, trigger);
        }
    }, { passive: true });
    
    streamEl.addEventListener('mouseout', e => {
        if (e.target.closest('.image-trigger')) hideImage();
    }, { passive: true });
}

let cursorX = 0, cursorY = 0, targetX = 0, targetY = 0;
let cursorEl, cursorImageEl;

function updateCursor() {
    if (!cursorEl) return;
    cursorX += (targetX - cursorX) * CURSOR_SMOOTHING;
    cursorY += (targetY - cursorY) * CURSOR_SMOOTHING;
    cursorEl.style.transform = `translate3d(${cursorX}px, ${cursorY}px, 0) translate(-50%, -50%)`;
    if (cursorImageEl) cursorImageEl.style.transform = `translate3d(${cursorX}px, ${cursorY}px, 0) translate(-50%, -50%)`;
    requestAnimationFrame(updateCursor);
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize cursor elements
    cursorEl = document.getElementById('cursor');
    cursorImageEl = document.getElementById('cursorImage');
    const cursor = cursorEl; // Local alias for use in event handlers
    const cursorImage = cursorImageEl;
    
    document.addEventListener('mousemove', e => { targetX = e.clientX; targetY = e.clientY; mouseX = e.clientX; mouseY = e.clientY; }, { passive: true });
    document.addEventListener('mouseover', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item')) {
            cursor.classList.add('hovering');
            if (e.target.matches('button, a, .grid-image-item')) cursor.classList.add('pointer');
        }
    }, { passive: true });
    document.addEventListener('mouseout', e => {
        if (e.target.matches('a, button, .image-trigger, input[type="range"], .chapter-break, .chapter-item, .grid-image-item')) {
            cursor.classList.remove('hovering');
            cursor.classList.remove('pointer');
        }
    }, { passive: true });
    
    // Accessibility
    let accessibilityLevel = 2;
    const accessibilityLevels = [0, 0.25, 0.5, 0.75, 1];
    
    function applyAccessibilityLevel(level) {
        const value = accessibilityLevels[level];
        document.documentElement.style.setProperty('--curve-k', value * 3);
        document.documentElement.style.setProperty('--vig-opacity', Math.min(value * 2.4, 1.2));
        document.documentElement.style.setProperty('--edge-blur', (value * 20) + 'px');
        document.body.style.fontSize = ((1.3 - (value * 0.9)) * 100) + '%';
        document.querySelectorAll('.level-indicator').forEach((el, i) => i === level ? el.classList.add('active') : el.classList.remove('active'));
    }
    
    document.getElementById('accessibilityIncrease').addEventListener('click', () => { if (accessibilityLevel > 0) applyAccessibilityLevel(--accessibilityLevel); });
    document.getElementById('accessibilityDecrease').addEventListener('click', () => { if (accessibilityLevel < accessibilityLevels.length - 1) applyAccessibilityLevel(++accessibilityLevel); });
    applyAccessibilityLevel(accessibilityLevel);
    
    // Long press setup
    function setupLongPress(buttonId, normalAction, longPressAction) {
        const button = document.getElementById(buttonId);
        if (!button) return;
        let longPressTimer = null, longPressActivated = false;

        button.addEventListener('touchstart', (e) => {
            longPressActivated = false;
            longPressTimer = setTimeout(() => {
                longPressActivated = true;
                longPressAction();
                if (navigator.vibrate) navigator.vibrate(50);
            }, 500);
        }, { passive: true });

        button.addEventListener('touchend', (e) => {
            if (longPressTimer) clearTimeout(longPressTimer);
            if (longPressActivated) {
                e.preventDefault(); 
            }
        }, { passive: false });

        button.addEventListener('touchcancel', () => { if (longPressTimer) clearTimeout(longPressTimer); }, { passive: true });
        
        button.addEventListener('click', (e) => {
            if (longPressActivated) {
                e.preventDefault();
                e.stopPropagation();
                longPressActivated = false;
            } else {
                normalAction();
            }
        });
    }
    
    // Context menu
    const contextMenu = document.getElementById('contextMenu');
    function showContextMenu(x, y) {
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';
        contextMenu.classList.add('open');
        contextMenu.setAttribute('aria-hidden', 'false');
        
        const themeText = document.getElementById('ctxThemeText');
        const themeIcon = document.getElementById('ctxThemeIcon');
        if (document.body.classList.contains('theme-academic')) { themeText.textContent = 'Dark Theme'; themeIcon.textContent = 'üåô'; }
        else if (document.body.classList.contains('theme-newspaper')) { themeText.textContent = 'Academic Theme'; themeIcon.textContent = 'üìñ'; }
        else { themeText.textContent = 'Newspaper Theme'; themeIcon.textContent = '‚òÄÔ∏è'; }

        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) contextMenu.style.left = (window.innerWidth - rect.width - 10) + 'px';
        if (rect.bottom > window.innerHeight) contextMenu.style.top = (window.innerHeight - rect.height - 10) + 'px';
    }
    
    function hideContextMenu() {
        contextMenu.classList.remove('open');
        contextMenu.setAttribute('aria-hidden', 'true');
    }
    
    document.addEventListener('contextmenu', e => { if (!lastInteractionWasTouch) { e.preventDefault(); showContextMenu(e.clientX, e.clientY); } });
    document.addEventListener('click', e => { if (!contextMenu.contains(e.target)) hideContextMenu(); });
    
    let globalLongPressTimer = null;
    document.addEventListener('touchstart', e => {
        if (e.target.closest('button')) return;
        globalLongPressTimer = setTimeout(() => { showContextMenu(e.touches[0].clientX, e.touches[0].clientY); if (navigator.vibrate) navigator.vibrate(50); }, 500);
    }, { passive: true });
    document.addEventListener('touchend', () => { if (globalLongPressTimer) clearTimeout(globalLongPressTimer); }, { passive: true });
    document.addEventListener('touchmove', () => { if (globalLongPressTimer) clearTimeout(globalLongPressTimer); }, { passive: true });
    
    document.getElementById('ctxCopyLink').addEventListener('click', () => { navigator.clipboard.writeText(window.location.href); hideContextMenu(); });
    document.getElementById('ctxShare').addEventListener('click', async () => { try { await navigator.share({ title: 'IFIMAYBEFRANK', url: window.location.href }); } catch(e){} hideContextMenu(); });
    document.getElementById('ctxResetProgress').addEventListener('click', () => { resetToBeginning(); hideContextMenu(); });
    document.getElementById('ctxToggleTheme').addEventListener('click', () => { window.toggleTheme(); hideContextMenu(); });
    document.getElementById('gridToggleBtn').addEventListener('click', toggleImageGrid);
    
    const gridCloseHotspot = document.getElementById('gridCloseHotspot');
    gridCloseHotspot.addEventListener('mouseenter', () => cursor.classList.add('close-mode'));
    gridCloseHotspot.addEventListener('mouseleave', () => cursor.classList.remove('close-mode'));
    gridCloseHotspot.addEventListener('click', () => { toggleImageGrid(); cursor.classList.remove('close-mode'); });
    
    const rotateCloseHotspot = document.getElementById('rotateCloseHotspot');
    rotateCloseHotspot.addEventListener('mouseenter', () => cursor.classList.add('close-mode'));
    rotateCloseHotspot.addEventListener('mouseleave', () => cursor.classList.remove('close-mode'));
    rotateCloseHotspot.addEventListener('click', () => { document.querySelector('.rotate-warning').style.display = 'none'; cursor.classList.remove('close-mode'); });
    
    // Initialize
    preloadImages();
    render();
    updateCursor();
    updateParallax();
    document.body.classList.add(`layout-${state.layoutMode}`);
    
    window.toggleLayout = function() {
        state.layoutMode = state.layoutMode === 'layered' ? 'split' : 'layered';
        document.body.classList.remove('layout-layered', 'layout-split');
        document.body.classList.add(`layout-${state.layoutMode}`);
        document.querySelector('.layout-icon').className = `layout-icon ${state.layoutMode}`;
        document.body.style.transition = 'all 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
        setTimeout(() => document.body.style.transition = '', 500);
    };
    document.getElementById('layoutToggle').addEventListener('click', window.toggleLayout);
    
    window.toggleTheme = function() {
        const body = document.body;
        if (body.classList.contains('theme-academic')) body.classList.remove('theme-academic');
        else if (body.classList.contains('theme-newspaper')) { body.classList.remove('theme-newspaper'); body.classList.add('theme-academic'); }
        else body.classList.add('theme-newspaper');
        const icon = document.querySelector('.theme-icon');
        icon.textContent = body.classList.contains('theme-academic') ? 'üåô' : (body.classList.contains('theme-newspaper') ? 'üìñ' : '‚òÄÔ∏è');
    };
    document.getElementById('themeToggle').addEventListener('click', window.toggleTheme);
    
    document.getElementById('brandLogo').addEventListener('click', toggleChapterDropdown);
    document.addEventListener('click', e => { if (!document.getElementById('brandLogo').contains(e.target) && !document.getElementById('chapterDropdown').contains(e.target)) closeChapterDropdown(); });
    
    window.addEventListener('wheel', handleScroll, { passive: false });
    window.addEventListener('touchstart', handleTouchStart, { passive: true });
    window.addEventListener('touchmove', handleTouchMove, { passive: false });
    window.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    document.addEventListener('keydown', e => {
        if (e.code === 'Space') { e.preventDefault(); if (!spacebarPressed) { toggleImageSize(); spacebarPressed = true; } }
        else if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); nextSentence(); }
        else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); previousSentence(); }
        else if (e.key === '[') { e.preventDefault(); previousChapter(); }
        else if (e.key === ']') { e.preventDefault(); nextChapter(); }
        else if (e.key === 'l') window.toggleLayout();
        else if (e.key.toLowerCase() === 't') window.toggleTheme();
        else if (e.key === 'Home') { e.preventDefault(); resetToBeginning(); }
        else if (e.key === 'Escape' || e.key.toLowerCase() === 'x') {
            closeChapterDropdown();
            if (document.getElementById('imageGridOverlay').classList.contains('open')) { toggleImageGrid(); cursor.classList.remove('close-mode'); }
            else if (document.querySelector('.rotate-warning').style.display === 'flex') { document.querySelector('.rotate-warning').style.display = 'none'; cursor.classList.remove('close-mode'); }
            else if (state.layoutMode === 'split') window.toggleLayout();
        }
    });
    document.addEventListener('keyup', e => { if (e.code === 'Space') spacebarPressed = false; });
    
    if (state.allSentenceElements.length > 0) { state.currentSentenceIndex = 0; highlightSentence(0); }
    
    setupLongPress('mobilePrevSentenceBtn', previousSentence, previousChapter);
    setupLongPress('mobileNextSentenceBtn', nextSentence, nextChapter);
    setupLongPress('landPrevBtn', previousSentence, previousChapter);
    setupLongPress('landNextBtn', nextSentence, nextChapter);
    
    // Add click listeners for desktop nav
    document.getElementById('prevSentenceBtn').addEventListener('click', previousSentence);
    document.getElementById('nextSentenceBtn').addEventListener('click', nextSentence);
    document.getElementById('prevChapterBtn').addEventListener('click', previousChapter);
    document.getElementById('nextChapterBtn').addEventListener('click', nextChapter);
});
    </script>
</body>
</html>
